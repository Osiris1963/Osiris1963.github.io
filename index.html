<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales & Customer Forecaster</title>
    <!-- Chosen Palette: McDonald's Professional (Warm Gray, Red, Yellow, Dark Text) -->
    <!-- Application Structure Plan: The SPA uses a fixed top navigation bar to switch between content sections, mimicking the logical flow of the original app's tabs. This design was chosen because it provides clear, persistent navigation, allowing users to easily move between the main forecast 'Dashboard', component 'Insights', and performance 'Evaluator' without losing context. All content is dynamically rendered into a single main content area, making it a true single-page application focused on usability and a seamless user flow. -->
    <!-- Visualization & Content Choices: Data from the report is presented using Chart.js for all visualizations to maintain a consistent look and feel. Goal: Show Change -> Viz: A dual-axis line chart is used on the Dashboard to show sales/customer trends. Interaction: Hover tooltips provide specific data points. Goal: Organize/Explain -> Viz: A waterfall chart on the Insights page breaks down forecast components. Interaction: A dropdown filters the view by date. Goal: Compare -> Viz: Paired line charts on the Evaluator page compare actuals vs. forecasts. Interaction: Toggles filter the time range. Data management is handled via styled HTML forms and cards, providing a clear and standard interface. This approach avoids proscribed libraries and focuses on universally understood interactions. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F7F7F7;
        }
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button.active {
            background-color: #DA291C; /* McDonald's Red */
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 50vh;
        }
        .stat-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #E5E7EB;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-center p-4">
            <svg class="animate-spin h-10 w-10 text-[#DA291C] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">Authenticating...</p>
        </div>
    </div>

    <div id="app-container" class="min-h-screen flex-col hidden">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center space-x-4">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png" alt="Logo" class="h-8 w-auto">
                        <h1 class="text-xl md:text-2xl font-bold text-gray-800">Sales & Customer Forecaster</h1>
                    </div>
                     <nav class="hidden md:flex space-x-2">
                        <button data-view="dashboard" class="nav-button active px-4 py-2 rounded-lg font-semibold">Dashboard</button>
                        <button data-view="insights" class="nav-button px-4 py-2 rounded-lg font-semibold">Insights</button>
                        <button data-view="evaluator" class="nav-button px-4 py-2 rounded-lg font-semibold">Evaluator</button>
                        <button data-view="datamgmt" class="nav-button px-4 py-2 rounded-lg font-semibold">Data Management</button>
                    </nav>
                </div>
            </div>
        </header>
        
        <!-- Mobile Navigation -->
        <nav class="md:hidden bg-white shadow-md p-2 flex justify-around sticky top-20 z-10">
            <button data-view="dashboard" class="nav-button active flex-1 text-sm py-2 rounded-lg font-semibold">Dashboard</button>
            <button data-view="insights" class="nav-button flex-1 text-sm py-2 rounded-lg font-semibold">Insights</button>
            <button data-view="evaluator" class="nav-button flex-1 text-sm py-2 rounded-lg font-semibold">Evaluator</button>
            <button data-view="datamgmt" class="nav-button flex-1 text-sm py-2 rounded-lg font-semibold">Data</button>
        </nav>


        <!-- Main Content Area -->
        <main id="content-area" class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="view">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Dashboard</h2>
                    <p class="text-gray-600">This section presents the 15-day outlook for projected sales and customer traffic, providing a high-level overview of expected performance.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Daily Sales (7-Day)</h3>
                        <p id="avg-sales" class="text-4xl font-bold text-[#DA291C] mt-2">₱0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Daily Customers (7-Day)</h3>
                        <p id="avg-customers" class="text-4xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Transaction Value (7-Day)</h3>
                        <p id="avg-atv" class="text-4xl font-bold text-gray-800 mt-2">₱0.00</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                     <h3 class="text-xl font-bold mb-4">15-Day Performance Outlook</h3>
                    <div class="chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Insights Section -->
            <section id="insights-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Insights</h2>
                    <p class="text-gray-600">Explore the underlying drivers of the daily forecast. This waterfall chart breaks down how factors like the day of the week, seasonality, and holidays contribute to the final customer projection.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h3 class="text-xl font-bold mb-2 sm:mb-0">Daily Driver Analysis</h3>
                        <div>
                            <label for="insightDate" class="font-semibold mr-2">Select a Date:</label>
                            <select id="insightDate" class="p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
                        <div class="lg:col-span-2 chart-container">
                            <canvas id="waterfallChart"></canvas>
                        </div>
                        <div id="insight-summary" class="bg-gray-50 p-6 rounded-lg border">
                            <h4 class="font-bold text-lg mb-2">Summary</h4>
                            <p class="text-gray-700">Select a date to see a summary of its forecast drivers.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Evaluator Section -->
            <section id="evaluator-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Evaluator</h2>
                    <p class="text-gray-600">This section measures the model's historical accuracy by comparing past day-ahead forecasts against actual results. This helps build trust and identify areas for model improvement.</p>
                </div>
                <div class="flex justify-center mb-6">
                     <div class="inline-flex rounded-lg shadow-sm bg-white border">
                        <button id="eval-7-day" class="eval-toggle-button bg-[#DA291C] text-white px-4 py-2 rounded-l-lg font-semibold">Last 7 Days</button>
                        <button id="eval-30-day" class="eval-toggle-button px-4 py-2 font-semibold text-gray-600">Last 30 Days</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                     <div class="stat-card">
                         <h3 class="text-lg font-semibold text-gray-500">Sales Accuracy (vs MAPE)</h3>
                         <p id="sales-accuracy" class="text-3xl font-bold mt-1">0.00%</p>
                     </div>
                     <div class="stat-card">
                         <h3 class="text-lg font-semibold text-gray-500">Customer Accuracy (vs MAPE)</h3>
                         <p id="customer-accuracy" class="text-3xl font-bold mt-1">0.00%</p>
                     </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Actual vs. Forecasted Sales</h3>
                        <div class="chart-container">
                            <canvas id="salesEvalChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Actual vs. Forecasted Customers</h3>
                        <div class="chart-container">
                            <canvas id="customersEvalChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
             <!-- Data Management Section -->
            <section id="datamgmt-section" class="view hidden">
                 <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Data Management</h2>
                    <p class="text-gray-600">Add new daily records for historical data, or log upcoming activities and promotions to improve forecast accuracy.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Add New Daily Record</h3>
                        <form id="daily-record-form" class="space-y-4">
                            <div>
                                <label for="record-date" class="block font-semibold mb-1">Date</label>
                                <input type="date" id="record-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="record-sales" class="block font-semibold mb-1">Total Sales (₱)</label>
                                    <input type="number" id="record-sales" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-customers" class="block font-semibold mb-1">Customers</label>
                                    <input type="number" id="record-customers" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                            </div>
                             <button type="submit" class="w-full bg-[#DA291C] text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition duration-300">Save Daily Record</button>
                        </form>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Add Future Activity/Promotion</h3>
                        <form id="activity-form" class="space-y-4">
                             <div>
                                <label for="activity-name" class="block font-semibold mb-1">Activity Name</label>
                                <input type="text" id="activity-name" placeholder="e.g., Twister Fries Launch" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="activity-date" class="block font-semibold mb-1">Date</label>
                                    <input type="date" id="activity-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="activity-sales" class="block font-semibold mb-1">Est. Sales Impact (₱)</label>
                                    <input type="number" id="activity-sales" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition duration-300">Save Activity</button>
                        </form>
                    </div>
                </div>
            </section>

        </main>
    </div>
    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- FIREBASE INITIALIZATION ---
            const firebaseConfig = {
              apiKey: "AIzaSyBlbxhzUp_TZd8oTrLxrY-E6gq-_XdiMCo",
              authDomain: "mcdonalds-san-carlos.firebaseapp.com",
              projectId: "mcdonalds-san-carlos",
              storageBucket: "mcdonalds-san-carlos.appspot.com",
              messagingSenderId: "1052052612983",
              appId: "1:1052052612983:web:8df02d65d12e99e0666372",
              measurementId: "G-EYSWHXTQ6F"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // --- GLOBAL STATE & CHARTS ---
            let charts = {};
            const appState = {
                currentView: 'dashboard',
                evalDays: 7,
                forecastData: null,
                evaluationData: null,
            };
            
            // --- TOAST NOTIFICATION ---
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }

            // --- DATA FETCHING & PROCESSING ---
            async function loadAppData() {
                try {
                    document.getElementById('loading-text').textContent = 'Loading Forecast Data...';
                    
                    const logSnapshot = await db.collection("forecast_log").orderBy("generated_on", "desc").limit(15).get();
                    if (logSnapshot.empty) {
                        throw new Error("No forecast data found in Firestore. Please run the Python forecasting script.");
                    }
                    
                    const forecastDocs = logSnapshot.docs.map(doc => doc.data()).reverse();
                    appState.forecastData = {
                        dates: forecastDocs.map(d => d.forecast_for_date.toDate()),
                        sales: forecastDocs.map(d => d.predicted_sales),
                        customers: forecastDocs.map(d => d.predicted_customers),
                    };

                    const evalSnapshot = await db.collection("forecast_log").orderBy("forecast_for_date", "desc").limit(30).get();
                    const historicalSnapshot = await db.collection("historical_data").get();
                    const historicalData = historicalSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const evalLogs = evalSnapshot.docs.map(doc => doc.data());
                    const mergedEvalData = [];
                    evalLogs.forEach(log => {
                        const logDate = log.forecast_for_date.toDate().toISOString().split('T')[0];
                        const actual = historicalData.find(h => h.date.toDate().toISOString().split('T')[0] === logDate);
                        if (actual) {
                            mergedEvalData.push({
                                date: log.forecast_for_date.toDate(),
                                actual_sales: actual.sales,
                                forecast_sales: log.predicted_sales,
                                actual_customers: actual.customers,
                                forecast_customers: log.predicted_customers,
                            });
                        }
                    });
                    appState.evaluationData = mergedEvalData.sort((a,b) => a.date - b.date);

                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('app-container').style.display = 'flex';
                    
                    updateView();

                } catch (error) {
                    let userMessage;
                    const lowerCaseError = error.message ? error.message.toLowerCase() : '';
                    if (error.code === 'permission-denied' || lowerCaseError.includes('permission') || lowerCaseError.includes('restricted to administrators')) {
                         userMessage = `
                            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                                <p class="font-bold text-lg">Firestore Security Rule Error</p>
                                <p>The application was denied access to the database. This usually happens after a successful sign-in.</p>
                                <p class="mt-4 text-sm">
                                    <strong>Action Required:</strong> Your Firestore Security Rules are too restrictive. Please go to your Firebase Console, navigate to the "Firestore Database" section, and click on the "Rules" tab.
                                </p>
                                <p class="mt-2 text-sm">
                                    For this app to work, your rules must allow authenticated users to read and write. Replace your current rules with this:
                                </p>
                                <pre class="bg-gray-200 text-gray-800 rounded p-2 mt-2 text-xs text-left"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}</code></pre>
                            </div>
                        `;
                    } else {
                        userMessage = `<div class="text-center p-8"><h2 class="text-2xl font-bold text-red-600">Error Loading Data</h2><p class="text-gray-700 mt-2">${error.message}</p><p class="mt-4 text-sm text-gray-500">Please check the browser console for more details.</p></div>`;
                    }
                    document.getElementById('loading-overlay').innerHTML = `<div class="p-8">${userMessage}</div>`;
                    console.error("Firebase Error:", error);
                }
            }

            // --- NAVIGATION LOGIC ---
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    appState.currentView = button.dataset.view;
                    updateView();
                });
            });

            function updateView() {
                document.querySelectorAll('.view').forEach(section => section.classList.add('hidden'));
                document.getElementById(`${appState.currentView}-section`).classList.remove('hidden');

                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === appState.currentView);
                });

                switch(appState.currentView) {
                    case 'dashboard': renderDashboard(); break;
                    case 'insights': renderInsights(); break;
                    case 'evaluator': renderEvaluator(); break;
                }
            }
            
            // --- RENDERING FUNCTIONS ---
            function renderDashboard() {
                if (!appState.forecastData) return;
                const { dates, sales, customers } = appState.forecastData;

                const ctx = document.getElementById('forecastChart').getContext('2d');
                if(charts.forecast) charts.forecast.destroy();

                charts.forecast = new Chart(ctx, {
                    type: 'line',
                    data: { labels: dates, datasets: [
                        { label: 'Predicted Sales (₱)', data: sales, borderColor: '#DA291C', backgroundColor: 'rgba(218, 41, 28, 0.1)', yAxisID: 'ySales', tension: 0.3, fill: true },
                        { label: 'Predicted Customers', data: customers, borderColor: '#FFC72C', backgroundColor: 'rgba(255, 199, 44, 0.1)', yAxisID: 'yCustomers', tension: 0.3 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' }, grid: { display: false } },
                            ySales: { type: 'linear', position: 'left', title: { display: true, text: 'Sales (₱)', font: {weight: 'bold'} }, grid: { color: '#E5E7EB' } },
                            yCustomers: { type: 'linear', position: 'right', title: { display: true, text: 'Customers', font: {weight: 'bold'} }, grid: { display: false } }
                        },
                        plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                        interaction: { mode: 'index', intersect: false }
                    }
                });
                
                const weeklySales = sales.slice(0, 7).reduce((a, b) => a + b, 0) / 7;
                const weeklyCustomers = customers.slice(0, 7).reduce((a, b) => a + b, 0) / 7;
                document.getElementById('avg-sales').textContent = `₱${weeklySales.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                document.getElementById('avg-customers').textContent = `${Math.round(weeklyCustomers).toLocaleString()}`;
                document.getElementById('avg-atv').textContent = `₱${(weeklySales/weeklyCustomers).toFixed(2)}`;
            }

            function renderInsights() {
                showToast("Insights view requires pre-calculated component data, which is not available in this live version.", "error");
                document.getElementById('insight-summary').innerHTML = `<h4 class="font-bold text-lg mb-2">Unavailable</h4><p>The detailed forecast breakdown is generated by the Python script. This view can be built out to read component data if it's saved to Firestore.</p>`;
            }
            
            function renderEvaluator() {
                if (!appState.evaluationData || appState.evaluationData.length === 0) {
                    showToast("No evaluation data available.", "error");
                    return;
                }
                const days = appState.evalDays;
                const dataSlice = appState.evaluationData.slice(-days);
                
                const salesMape = dataSlice.reduce((sum, val) => sum + Math.abs((val.actual_sales - val.forecast_sales) / val.actual_sales), 0) / dataSlice.length * 100;
                const custMape = dataSlice.reduce((sum, val) => sum + Math.abs((val.actual_customers - val.forecast_customers) / val.actual_customers), 0) / dataSlice.length * 100;

                document.getElementById('sales-accuracy').textContent = `${(100 - salesMape).toFixed(2)}%`;
                document.getElementById('customer-accuracy').textContent = `${(100 - custMape).toFixed(2)}%`;

                const salesCtx = document.getElementById('salesEvalChart').getContext('2d');
                if(charts.salesEval) charts.salesEval.destroy();
                charts.salesEval = createEvalChart(salesCtx, dataSlice.map(d=>d.date), dataSlice.map(d=>d.actual_sales), dataSlice.map(d=>d.forecast_sales));

                const custCtx = document.getElementById('customersEvalChart').getContext('2d');
                if(charts.custEval) charts.custEval.destroy();
                charts.custEval = createEvalChart(custCtx, dataSlice.map(d=>d.date), dataSlice.map(d=>d.actual_customers), dataSlice.map(d=>d.forecast_customers));
            }
            
            function createEvalChart(ctx, dates, actuals, forecasts) {
                return new Chart(ctx, {
                    type: 'line',
                    data: { labels: dates, datasets: [
                        { label: 'Actual', data: actuals, borderColor: '#DA291C', tension: 0.1 },
                        { label: 'Forecast', data: forecasts, borderColor: '#FFC72C', borderDash: [5, 5], tension: 0.1 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false,
                        scales: { x: { type: 'time', time: { unit: 'day' } } },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            }

            document.querySelectorAll('.eval-toggle-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.eval-toggle-button').forEach(btn => {
                        btn.classList.remove('bg-[#DA291C]', 'text-white');
                        btn.classList.add('text-gray-600');
                    });
                    e.target.classList.add('bg-[#DA291C]', 'text-white');
                    e.target.classList.remove('text-gray-600');
                    appState.evalDays = e.target.id === 'eval-7-day' ? 7 : 30;
                    renderEvaluator();
                });
            });

            // --- FORM HANDLING ---
            document.getElementById('daily-record-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const record = {
                    date: firebase.firestore.Timestamp.fromDate(new Date(form['record-date'].value)),
                    sales: parseFloat(form['record-sales'].value),
                    customers: parseInt(form['record-customers'].value),
                    add_on_sales: 0,
                    weather: "Sunny"
                };
                try {
                    await db.collection("historical_data").add(record);
                    showToast("Daily record saved successfully!");
                    form.reset();
                } catch (error) {
                    showToast("Error saving record.", "error");
                    console.error("Error adding document: ", error);
                }
            });

            document.getElementById('activity-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const activity = {
                    activity_name: form['activity-name'].value,
                    date: firebase.firestore.Timestamp.fromDate(new Date(form['activity-date'].value)),
                    potential_sales: parseFloat(form['activity-sales'].value),
                    remarks: "Tentative"
                };
                 try {
                    await db.collection("future_activities").add(activity);
                    showToast("Activity saved successfully!");
                    form.reset();
                } catch (error) {
                    showToast("Error saving activity.", "error");
                    console.error("Error adding document: ", error);
                }
            });

            // --- INITIAL APP LOAD ---
            auth.signInAnonymously()
                .then(() => {
                    console.log("Signed in anonymously.");
                    document.getElementById('loading-text').textContent = 'Loading Forecast Data...';
                    loadAppData();
                })
                .catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                    let userMessage;
                    if (error.code === 'auth/operation-not-allowed' || (error.message && error.message.includes('CONFIGURATION_NOT_FOUND'))) {
                        userMessage = `
                            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                                <p class="font-bold text-lg">Configuration Error</p>
                                <p>Anonymous sign-in is not enabled for this project.</p>
                                <p class="mt-4 text-sm">
                                    <strong>Action Required:</strong> Please go to your Firebase Console, navigate to the "Authentication" section, click on the "Sign-in method" tab, and enable the "Anonymous" provider.
                                </p>
                            </div>
                        `;
                    } else {
                         userMessage = `
                            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                                <p class="font-bold text-lg">Authentication Error</p>
                                <p>${error.message}</p>
                                <p class="mt-4 text-sm">Could not connect to the database. Please check your Firebase settings and security rules.</p>
                            </div>
                        `;
                    }
                    document.getElementById('loading-overlay').innerHTML = `<div class="p-8">${userMessage}</div>`;
                });
        });
    </script>

</body>
</html>
