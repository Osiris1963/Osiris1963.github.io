<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>McDonald's San Carlos 688</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F7F7F7;
        }
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button.active {
            background-color: #DA291C; /* McDonald's Red */
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 50vh;
        }
        .stat-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #E5E7EB;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }
        /* Custom scrollbar for webkit browsers */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .month-tab.active {
            border-color: #DA291C;
            background-color: #DA291C;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex-col items-center justify-center z-50 hidden">
        <div class="text-center p-4">
            <svg class="animate-spin h-10 w-10 text-[#DA291C] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">Loading...</p>
        </div>
    </div>
    
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png" alt="Logo" class="h-12 w-auto mx-auto mb-6">
            <h2 class="text-2xl font-bold text-center mb-1">Welcome Back</h2>
            <p class="text-center text-gray-500 mb-6">Please sign in to access the forecaster.</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Username (Email)</label>
                    <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500">
                </div>
                <div id="login-error" class="text-sm text-red-600 h-auto"></div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#DA291C] hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Sign In
                </button>
            </form>
        </div>
    </div>


    <div id="app-container" class="min-h-screen flex-col hidden">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center space-x-4">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png" alt="Logo" class="h-8 w-auto">
                        <h1 class="text-xl md:text-2xl font-bold text-gray-800">McDonald's San Carlos 688</h1>
                    </div>
                     <nav id="main-nav" class="hidden md:flex flex-wrap items-center text-base justify-center">
                        <button data-view="dashboard" class="nav-button active px-3 py-2 rounded-lg font-semibold">Dashboard</button>
                        <button data-view="insights" class="nav-button px-3 py-2 rounded-lg font-semibold">Insights</button>
                        <button data-view="evaluator" class="nav-button px-3 py-2 rounded-lg font-semibold">Evaluator</button>
                        <button data-view="datamgmt" class="nav-button px-3 py-2 rounded-lg font-semibold">Add Data</button>
                        <button data-view="activities" class="nav-button px-3 py-2 rounded-lg font-semibold">Activities</button>
                        <button data-view="historical" class="nav-button px-3 py-2 rounded-lg font-semibold">History</button>
                        <button data-view="admin" class="nav-button px-3 py-2 rounded-lg font-semibold hidden">Admin</button>
                    </nav>
                     <div class="flex items-center space-x-4">
                        <p id="user-greeting" class="hidden md:block text-sm font-semibold"></p>
                        <button id="logout-btn" class="hidden md:flex items-center space-x-2 px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition">
                            <span>Logout</span>
                        </button>
                     </div>
                </div>
            </div>
        </header>
        
        <nav id="mobile-nav" class="md:hidden bg-white shadow-md p-2 grid grid-cols-3 gap-1 sticky top-0 z-10">
            <button data-view="dashboard" class="nav-button active flex-1 text-sm py-2 rounded-lg font-semibold">Dashboard</button>
            <button data-view="insights" class="nav-button flex-1 text-sm py-2 rounded-lg font-semibold">Insights</button>
            <button data-view="evaluator" class="nav-button flex-1 text-sm py-2 rounded-lg font-semibold">Evaluator</button>
            <button data-view="datamgmt" class="nav-button flex-1 text-sm py-2 rounded-lg font-semibold">Add Data</button>
            <button data-view="activities" class="nav-button flex-1 text-sm py-2 rounded-lg font-semibold">Activities</button>
            <button data-view="historical" class="nav-button flex-1 text-sm py-2 rounded-lg font-semibold">History</button>
            <button data-view="admin" class="nav-button flex-1 text-sm py-2 rounded-lg font-semibold hidden">Admin</button>
        </nav>


        <main id="content-area" class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="provisional-forecast-banner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
                <p class="font-bold">Provisional Forecast</p>
                <p>Displaying a basic forecast generated from historical data. For the advanced prediction, please run the backend Python engine.</p>
            </div>
            
            <section id="dashboard-section" class="view">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Dashboard</h2>
                    <p class="text-gray-600">This section presents the 15-day outlook for projected sales and customer traffic, providing a high-level overview of expected performance.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Daily Sales (7-Day)</h3>
                        <p id="avg-sales" class="text-4xl font-bold text-[#DA291C] mt-2">â‚±0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Daily Customers (7-Day)</h3>
                        <p id="avg-customers" class="text-4xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Transaction Value (7-Day)</h3>
                        <p id="avg-atv" class="text-4xl font-bold text-gray-800 mt-2">â‚±0.00</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                     <h3 class="text-xl font-bold mb-4">15-Day Performance Outlook</h3>
                    <div class="chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="insights-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Insights</h2>
                    <p class="text-gray-600">Explore the underlying drivers of the daily forecast. This waterfall chart breaks down how factors like the day of the week, seasonality, and holidays contribute to the final customer projection.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h3 class="text-xl font-bold mb-2 sm:mb-0">Daily Driver Analysis</h3>
                        <div>
                            <label for="insightDate" class="font-semibold mr-2">Select a Date:</label>
                            <select id="insightDate" class="p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
                        <div class="lg:col-span-2 chart-container">
                            <canvas id="waterfallChart"></canvas>
                        </div>
                        <div id="insight-summary" class="bg-gray-50 p-6 rounded-lg border">
                            <h4 class="font-bold text-lg mb-2">Summary</h4>
                            <p class="text-gray-700">Select a date to see a summary of its forecast drivers.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="evaluator-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Evaluator</h2>
                    <p class="text-gray-600">This section measures the model's historical accuracy by comparing past day-ahead forecasts against actual results. This helps build trust and identify areas for model improvement.</p>
                </div>
                <div class="flex justify-center mb-6">
                     <div class="inline-flex rounded-lg shadow-sm bg-white border">
                        <button id="eval-7-day" class="eval-toggle-button bg-[#DA291C] text-white px-4 py-2 rounded-l-lg font-semibold">Last 7 Days</button>
                        <button id="eval-30-day" class="eval-toggle-button px-4 py-2 font-semibold text-gray-600">Last 30 Days</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                     <div class="stat-card">
                         <h3 class="text-lg font-semibold text-gray-500">Sales Accuracy (vs MAPE)</h3>
                         <p id="sales-accuracy" class="text-3xl font-bold mt-1">0.00%</p>
                     </div>
                     <div class="stat-card">
                         <h3 class="text-lg font-semibold text-gray-500">Customer Accuracy (vs MAPE)</h3>
                         <p id="customer-accuracy" class="text-3xl font-bold mt-1">0.00%</p>
                     </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Actual vs. Forecasted Sales</h3>
                        <div class="chart-container">
                            <canvas id="salesEvalChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Actual vs. Forecasted Customers</h3>
                        <div class="chart-container">
                            <canvas id="customersEvalChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
             <section id="datamgmt-section" class="view hidden">
                 <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Add New Data</h2>
                    <p class="text-gray-600">Add new daily records and future activities to improve forecast accuracy.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Add New Daily Record</h3>
                        <form id="daily-record-form" class="space-y-4">
                            <div>
                                <label for="record-date" class="block font-semibold mb-1">Date</label>
                                <input type="date" id="record-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="record-sales" class="block font-semibold mb-1">Total Sales (â‚±)</label>
                                    <input type="number" step="0.01" id="record-sales" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-customers" class="block font-semibold mb-1">Customers</label>
                                    <input type="number" id="record-customers" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-addons" class="block font-semibold mb-1">Add-on Sales (â‚±)</label>
                                    <input type="number" step="0.01" id="record-addons" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-weather" class="block font-semibold mb-1">Weather</label>
                                    <select id="record-weather" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                        <option>Sunny</option>
                                        <option>Cloudy</option>
                                        <option>Rainy</option>
                                        <option>Storm</option>
                                    </select>
                                </div>
                            </div>
                             <button type="submit" class="w-full bg-[#DA291C] text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition duration-300">Save Daily Record</button>
                        </form>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Add Future Event</h3>
                        <form id="event-form" class="space-y-4">
                             <div>
                                <label for="event-name" class="block font-semibold mb-1">Event Name</label>
                                <input type="text" id="event-name" placeholder="e.g., San Carlos Charter Day" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                             <div>
                                <label for="event-date" class="block font-semibold mb-1">Date</label>
                                <input type="date" id="event-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                            <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition duration-300">Save Event</button>
                        </form>
                    </div>
                </div>
            </section>
            
            <section id="activities-section" class="view hidden">
                 <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Future Activities</h2>
                    <p class="text-gray-600">Add, browse, and manage all upcoming events and promotions.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-bold mb-4">Add New Activity</h3>
                        <form id="activity-form" class="space-y-4">
                             <div>
                                <label for="activity-name" class="block font-semibold mb-1">Activity Name</label>
                                <input type="text" id="activity-name" placeholder="e.g., Catering for Birthday" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                            <div>
                                <label for="customer-name" class="block font-semibold mb-1">Customer Name</label>
                                <input type="text" id="customer-name" placeholder="e.g., John Doe" class="w-full p-2 rounded-lg border-2 border-gray-200">
                            </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="activity-date" class="block font-semibold mb-1">Date</label>
                                    <input type="date" id="activity-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="activity-sales" class="block font-semibold mb-1">Est. Sales (â‚±)</label>
                                    <input type="number" step="0.01" id="activity-sales" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                            </div>
                             <div>
                                <label for="activity-status" class="block font-semibold mb-1">Status</label>
                                <select id="activity-status" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                    <option>Confirmed</option>
                                    <option>Needs Follow-up</option>
                                    <option>Tentative</option>
                                    <option>Cancelled</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition duration-300">Save Activity</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="flex space-x-4 mb-4 bg-white p-4 rounded-lg shadow-sm border">
                            <div>
                                <label for="activity-year" class="block text-sm font-medium text-gray-700">Year</label>
                                <select id="activity-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"></select>
                            </div>
                        </div>
                        <div id="activity-tabs-container" class="mb-4 border-b border-gray-300">
                            </div>
                        <div id="activity-content-container">
                            </div>
                    </div>
                </div>
            </section>

            <section id="historical-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Historical Data</h2>
                    <p class="text-gray-600">Browse and manage past daily records.</p>
                </div>
                <div class="flex space-x-4 mb-4 bg-white p-4 rounded-lg shadow-sm border">
                    <div>
                        <label for="hist-year" class="block text-sm font-medium text-gray-700">Year</label>
                        <select id="hist-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="hist-month" class="block text-sm font-medium text-gray-700">Month</label>
                        <select id="hist-month" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"></select>
                    </div>
                </div>
                <div id="historical-list" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                    </div>
            </section>

            <section id="admin-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">User Management</h2>
                    <p class="text-gray-600">View and manage user access levels. New users should be created securely in the Firebase Console.</p>
                </div>
                <div id="user-list" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 space-y-4">
                    </div>
            </section>

        </main>
    </div>
    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- FIREBASE INITIALIZATION ---
            const firebaseConfig = {
              apiKey: "AIzaSyBlbxhzUp_TZd8oTrLxrY-E6gq-_XdiMCo",
              authDomain: "mcdonalds-san-carlos.firebaseapp.com",
              projectId: "mcdonalds-san-carlos",
              storageBucket: "mcdonalds-san-carlos.appspot.com",
              messagingSenderId: "1052052612983",
              appId: "1:1052052612983:web:8df02d65d12e99e0666372",
              measurementId: "G-EYSWHXTQ6F"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // --- GLOBAL STATE & CHARTS ---
            let charts = {};
            const appState = {
                currentView: 'dashboard',
                evalDays: 7,
                forecastData: null,
                evaluationData: null,
                insightsData: null,
                activitiesData: null,
                historicalData: null,
                usersData: null,
                accessLevel: 3, // Default to viewer
            };
            
            // --- TOAST NOTIFICATION ---
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }

            // --- DATE HELPER FUNCTION ---
            /**
             * Converts a Date object to a 'YYYY-MM-DD' string based on the local date.
             * This is timezone-safe for matching dates.
             * @param {Date} date The date to convert.
             * @returns {string} The formatted date string.
             */
            function getLocalDateString(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // --- DATA FETCHING & PROCESSING ---
            async function loadAppData() {
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('loading-text').textContent = 'Loading All Application Data...';
                
                try {
                    // --- FIX: Separate queries for Dashboard (future) and Evaluator (past) ---
                    const thirtyFiveDaysAgo = new Date();
                    thirtyFiveDaysAgo.setDate(thirtyFiveDaysAgo.getDate() - 35);

                    const [
                        dashboardLogSnapshot,
                        allHistoricalSnapshot, // All historical data for the history tab
                        activitiesSnapshot,
                        usersSnapshot,
                        evalLogSnapshot, // Forecast logs for the evaluator
                        evalHistoricalSnapshot // Historical data for the evaluator
                    ] = await Promise.all([
                        // Query for Dashboard: latest 15 forecasts for the future
                        db.collection("forecast_log").orderBy("generated_on", "desc").limit(15).get(),
                        // Query for History Tab: all historical data
                        db.collection("historical_data").orderBy("date", "desc").get(),
                        // Query for Activities
                        db.collection("future_activities").orderBy("date", "asc").get(),
                        // Query for Users
                        db.collection("users").get(),
                        // Query for Evaluator: forecast logs from the last 35 days
                        db.collection("forecast_log").where("forecast_for_date", ">=", thirtyFiveDaysAgo).get(),
                        // Query for Evaluator: historical data from the last 35 days
                        // IMPORTANT: This query requires a composite index in Firestore. 
                        // The browser console will provide a link to create it automatically.
                        db.collection("historical_data").where("date", ">=", thirtyFiveDaysAgo).orderBy("date", "desc").get()
                    ]);

                    // Process data for general app use (History tab, etc.)
                    appState.historicalData = allHistoricalSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.activitiesData = activitiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.usersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // --- Process Dashboard Data ---
                    if (dashboardLogSnapshot.empty) {
                        document.getElementById('provisional-forecast-banner').classList.remove('hidden');
                        generateProvisionalForecast();
                    } else {
                        document.getElementById('provisional-forecast-banner').classList.add('hidden');
                        const forecastDocs = dashboardLogSnapshot.docs.map(doc => doc.data()).reverse();
                        appState.forecastData = {
                            dates: forecastDocs.map(d => d.forecast_for_date.toDate()),
                            sales: forecastDocs.map(d => d.predicted_sales),
                            customers: forecastDocs.map(d => d.predicted_customers),
                        };
                    }
                    
                    const recentHistoryForInsight = appState.historicalData.slice(0, 30).map(h => h.customers).reverse();
                    const trendMovingAverage = recentHistoryForInsight.length > 0 ? recentHistoryForInsight.slice(-7).reduce((a, b) => a + b, 0) / 7 : 250;
                    
                    if(appState.forecastData && appState.forecastData.dates.length > 0) {
                        appState.insightsData = appState.forecastData.dates.map((date, i) => {
                            const forecastCustomers = appState.forecastData.customers[i];
                            const effect = forecastCustomers - trendMovingAverage;
                            return {
                                date: date,
                                trend: trendMovingAverage,
                                seasonal_effect: effect,
                                total: forecastCustomers
                            };
                        });
                    }


                    // --- Process and Merge Data for Evaluator ---
                    const latestForecastsForEval = new Map();
                    evalLogSnapshot.docs.forEach(doc => {
                        const log = doc.data();
                        const logDateStr = getLocalDateString(log.forecast_for_date.toDate());
                        const existing = latestForecastsForEval.get(logDateStr);
                        // Only keep the most recently generated forecast for any given day
                        if (!existing || log.generated_on.toMillis() > existing.generated_on.toMillis()) {
                            latestForecastsForEval.set(logDateStr, log);
                        }
                    });

                    const actualsForEval = new Map();
                    evalHistoricalSnapshot.docs.forEach(doc => {
                        const actual = doc.data();
                        const actualDateStr = getLocalDateString(actual.date.toDate());
                        if (!actualsForEval.has(actualDateStr)) {
                            actualsForEval.set(actualDateStr, { id: doc.id, ...actual });
                        }
                    });

                    const mergedEvalData = [];
                    actualsForEval.forEach((actual, actualDateStr) => {
                        if (latestForecastsForEval.has(actualDateStr)) {
                            const forecast = latestForecastsForEval.get(actualDateStr);
                            mergedEvalData.push({
                                date: actual.date.toDate(),
                                actual_sales: Number(actual.sales),
                                forecast_sales: Number(forecast.predicted_sales) + Number(actual.add_on_sales || 0),
                                actual_customers: Number(actual.customers),
                                forecast_customers: Number(forecast.predicted_customers),
                            });
                        }
                    });
                    
                    appState.evaluationData = mergedEvalData.sort((a,b) => a.date - b.date);
                    
                    // --- Final UI Update ---
                    updateView();

                } catch (error) {
                    let userMessage;
                    const lowerCaseError = error.message ? error.message.toLowerCase() : '';
                    if (error.code === 'permission-denied' || lowerCaseError.includes('permission') || lowerCaseError.includes('restricted to administrators')) {
                         userMessage = `
                            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                                <p class="font-bold text-lg">Firestore Security Rule Error</p>
                                <p>The application was denied access to the database. This usually happens after a successful sign-in.</p>
                                <p class="mt-4 text-sm">
                                    <strong>Action Required:</strong> Your Firestore Security Rules are too restrictive. Please go to your Firebase Console, navigate to the "Firestore Database" section, and click on the "Rules" tab.
                                </p>
                                <p class="mt-2 text-sm">
                                    For this app to work, your rules must allow authenticated users to read and write. Replace your current rules with this:
                                </p>
                                <pre class="bg-gray-200 text-gray-800 rounded p-2 mt-2 text-xs text-left"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}</code></pre>
                            </div>
                        `;
                    } else if (error.code === 'failed-precondition') {
                         userMessage = `
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                                <p class="font-bold text-lg">Firestore Index Required</p>
                                <p>A database index is required for the Evaluator to work. This is a one-time setup.</p>
                                <p class="mt-4 text-sm">
                                    <strong>Action Required:</strong> Open the browser's developer console (usually by pressing F12). You will find an error message from Firebase containing a long URL.
                                </p>
                                <p class="mt-2 text-sm">
                                   Copy that full URL, paste it into a new browser tab, and click the "Create Index" button on the page that loads. Then, reload this application.
                                </p>
                            </div>
                        `;
                    } else {
                        userMessage = `<div class="text-center p-8"><h2 class="text-2xl font-bold text-red-600">Error Loading Data</h2><p class="text-gray-700 mt-2">${error.message}</p><p class="mt-4 text-sm text-gray-500">Please check the browser console for more details.</p></div>`;
                    }
                    document.getElementById('loading-overlay').innerHTML = `<div class="p-8">${userMessage}</div>`;
                    console.error("Firebase Error:", error);
                } finally {
                    if(!document.getElementById('loading-overlay').innerHTML.includes('Error')) {
                       document.getElementById('loading-overlay').style.display = 'none';
                    }
                }
            }
            
            function generateProvisionalForecast() {
                const dates = Array.from({length: 15}, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() + i + 1);
                    return d;
                });

                if (!appState.historicalData || appState.historicalData.length < 7) {
                    showToast("Not enough historical data for a provisional forecast.", "error");
                    appState.forecastData = { dates: dates, sales: [], customers: [] };
                    return;
                }
                const last7DaysCustomers = appState.historicalData.slice(0, 7).map(d => d.customers);
                const avgCustomers = last7DaysCustomers.reduce((a, b) => a + b, 0) / 7;
                const last7DaysATV = appState.historicalData.slice(0, 7).map(d => (d.sales / d.customers));
                const avgATV = last7DaysATV.reduce((a,b) => a+b, 0) / 7;

                appState.forecastData = {
                    dates: dates,
                    customers: Array(15).fill(avgCustomers),
                    sales: Array(15).fill(avgCustomers * avgATV)
                };
            }

            // --- NAVIGATION LOGIC ---
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    appState.currentView = button.dataset.view;
                    updateView();
                });
            });

            function updateView() {
                document.querySelectorAll('.view').forEach(section => section.classList.add('hidden'));
                document.getElementById(`${appState.currentView}-section`).classList.remove('hidden');

                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === appState.currentView);
                });

                switch(appState.currentView) {
                    case 'dashboard': renderDashboard(); break;
                    case 'insights': renderInsights(); break;
                    case 'evaluator': renderEvaluator(); break;
                    case 'activities': renderActivities(); break;
                    case 'historical': renderHistorical(); break;
                    case 'admin': renderAdmin(); break;
                }
            }
            
            // --- RENDERING FUNCTIONS ---
            function renderDashboard() {
                if (!appState.forecastData) return;
                const { dates, sales, customers } = appState.forecastData;

                const ctx = document.getElementById('forecastChart').getContext('2d');
                if(charts.forecast) charts.forecast.destroy();

                charts.forecast = new Chart(ctx, {
                    type: 'line',
                    data: { labels: dates, datasets: [
                        { label: 'Predicted Sales (â‚±)', data: sales, borderColor: '#DA291C', backgroundColor: 'rgba(218, 41, 28, 0.1)', yAxisID: 'ySales', tension: 0.3, fill: true },
                        { label: 'Predicted Customers', data: customers, borderColor: '#FFC72C', backgroundColor: 'rgba(255, 199, 44, 0.1)', yAxisID: 'yCustomers', tension: 0.3 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' }, grid: { display: false } },
                            ySales: { type: 'linear', position: 'left', title: { display: true, text: 'Sales (â‚±)', font: {weight: 'bold'} }, grid: { color: '#E5E7EB' } },
                            yCustomers: { type: 'linear', position: 'right', title: { display: true, text: 'Customers', font: {weight: 'bold'} }, grid: { display: false } }
                        },
                        plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                        interaction: { mode: 'index', intersect: false }
                    }
                });
                
                const weeklySales = sales.slice(0, 7).reduce((a, b) => a + b, 0) / 7;
                const weeklyCustomers = customers.slice(0, 7).reduce((a, b) => a + b, 0) / 7;
                document.getElementById('avg-sales').textContent = `â‚±${weeklySales.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                document.getElementById('avg-customers').textContent = `${Math.round(weeklyCustomers).toLocaleString()}`;
                document.getElementById('avg-atv').textContent = `â‚±${(weeklySales/weeklyCustomers).toFixed(2)}`;
            }

            function renderInsights() {
                if (!appState.insightsData) {
                    showToast("No insights data available to display.", "error");
                    return;
                }
                const select = document.getElementById('insightDate');
                select.innerHTML = '';
                appState.insightsData.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.date.toISOString().split('T')[0];
                    option.textContent = d.date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    select.appendChild(option);
                });
                
                select.removeEventListener('change', handleInsightDateChange); 
                select.addEventListener('change', handleInsightDateChange);
                if (appState.insightsData.length > 0) {
                    updateWaterfallChart(select.value);
                }
            }

            function handleInsightDateChange(e) {
                updateWaterfallChart(e.target.value);
            }

            function updateWaterfallChart(dateString) {
                const data = appState.insightsData.find(d => d.date.toISOString().split('T')[0] === dateString);
                if (!data) return;

                const ctx = document.getElementById('waterfallChart').getContext('2d');
                if (charts.waterfall) charts.waterfall.destroy();

                charts.waterfall = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Baseline Trend', 'Seasonal & Event Effects', 'Final Forecast'],
                        datasets: [{
                            data: [data.trend, data.seasonal_effect, data.total],
                            backgroundColor: ['#3B82F6', data.seasonal_effect >= 0 ? '#10B981' : '#EF4444', '#4B5563'],
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: { x: { title: { display: true, text: 'Customer Count Impact' } } }
                    }
                });
                
                const summaryEl = document.getElementById('insight-summary');
                summaryEl.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">Summary for ${new Date(dateString + 'T08:00:00').toLocaleDateString('en-US', {month: 'long', day: 'numeric'})}</h4>
                    <p class="mb-2">The forecast starts with a baseline trend of <strong>${data.trend.toFixed(0)}</strong> customers.</p>
                    <p class="mb-2">Seasonal and event effects are ${data.seasonal_effect >= 0 ? 'positive' : 'negative'}, adjusting by <strong>${data.seasonal_effect.toFixed(0)}</strong> customers.</p>
                    <hr class="my-3 border-gray-300">
                    <p class="font-bold">Resulting in a final forecast of <strong>${data.total.toFixed(0)}</strong> customers.</p>
                `;
            }
            
            function renderEvaluator() {
                // Get elements and clear previous state
                const salesAccuracyEl = document.getElementById('sales-accuracy');
                const customerAccuracyEl = document.getElementById('customer-accuracy');
                const salesChartCtx = document.getElementById('salesEvalChart')?.getContext('2d');
                const custChartCtx = document.getElementById('customersEvalChart')?.getContext('2d');

                if (charts.salesEval) charts.salesEval.destroy();
                if (charts.custEval) charts.custEval.destroy();
                salesAccuracyEl.textContent = 'N/A';
                customerAccuracyEl.textContent = 'N/A';

                // Check if there is any evaluation data at all
                if (!appState.evaluationData || appState.evaluationData.length === 0) {
                    showToast("No matching historical and forecast data found for evaluation.", "error");
                    return;
                }

                const days = appState.evalDays;
                const dataSlice = appState.evaluationData.slice(-days);
                
                // Check if there is data for the selected time slice (e.g., last 7 days)
                if (dataSlice.length === 0) {
                    showToast(`No evaluation data available for the last ${days} days.`, "error");
                    return;
                }
                
                // --- MAPE Calculation with protection against division by zero ---
                const salesMapeData = dataSlice.filter(d => d.actual_sales > 0);
                const salesMape = salesMapeData.length > 0 
                    ? (salesMapeData.reduce((sum, val) => sum + Math.abs((val.actual_sales - val.forecast_sales) / val.actual_sales), 0) / salesMapeData.length) * 100
                    : 0;

                const custMapeData = dataSlice.filter(d => d.actual_customers > 0);
                const custMape = custMapeData.length > 0
                    ? (custMapeData.reduce((sum, val) => sum + Math.abs((val.actual_customers - val.forecast_customers) / val.actual_customers), 0) / custMapeData.length) * 100
                    : 0;

                salesAccuracyEl.textContent = `${(100 - salesMape).toFixed(2)}%`;
                customerAccuracyEl.textContent = `${(100 - custMape).toFixed(2)}%`;

                // Render charts if the context is available
                if (salesChartCtx) {
                    charts.salesEval = createEvalChart(salesChartCtx, dataSlice.map(d=>d.date), dataSlice.map(d=>d.actual_sales), dataSlice.map(d=>d.forecast_sales));
                }
                
                if (custChartCtx) {
                    charts.custEval = createEvalChart(custChartCtx, dataSlice.map(d=>d.date), dataSlice.map(d=>d.actual_customers), dataSlice.map(d=>d.forecast_customers));
                }
            }
            
            function createEvalChart(ctx, dates, actuals, forecasts) {
                return new Chart(ctx, {
                    type: 'line',
                    data: { labels: dates, datasets: [
                        { label: 'Actual', data: actuals, borderColor: '#DA291C', tension: 0.1 },
                        { label: 'Forecast', data: forecasts, borderColor: '#FFC72C', borderDash: [5, 5], tension: 0.1 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false,
                        scales: { x: { type: 'time', time: { unit: 'day' } } },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            }

            function setupActivityFilters() {
                const yearSelect = document.getElementById('activity-year');
                if (!appState.activitiesData || appState.activitiesData.length === 0) {
                    yearSelect.innerHTML = `<option>${new Date().getFullYear()}</option>`;
                    return;
                }

                const years = [...new Set(appState.activitiesData.map(d => d.date.toDate().getFullYear()))].sort((a,b) => b - a);
                const currentYear = new Date().getFullYear();

                if (!years.includes(currentYear)) {
                    years.push(currentYear);
