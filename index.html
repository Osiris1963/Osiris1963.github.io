<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>McDonald's San Carlos 688</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Using Firebase v8 as in the original file to maintain compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        /* Light Mode (default) */
        :root {
            --bg-primary: #F7F7F7;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #f8fafc;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --input-bg: #FFFFFF;
            --input-border: #d1d5db;
            --hover-bg: #f3f4f6;
        }
        
        /* Dark Mode */
        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.2);
            --input-bg: #374151;
            --input-border: #4b5563;
            --hover-bg: #374151;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: env(safe-area-inset-bottom);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Dark mode overrides */
        .dark #login-screen {
            background-color: var(--bg-primary);
        }
        .dark #login-screen > div {
            background-color: var(--bg-secondary);
            border-color: var(--border-color);
        }
        .dark #app-container {
            background-color: var(--bg-primary);
        }
        .dark header {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        .dark .stat-card,
        .dark .bg-white {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        .dark .text-gray-800,
        .dark .text-gray-700,
        .dark .text-gray-900 {
            color: var(--text-primary) !important;
        }
        .dark .text-gray-600,
        .dark .text-gray-500 {
            color: var(--text-secondary) !important;
        }
        .dark .text-gray-400 {
            color: var(--text-muted) !important;
        }
        .dark .bg-gray-50,
        .dark .bg-gray-100 {
            background-color: var(--bg-tertiary) !important;
        }
        .dark .border-gray-200,
        .dark .border-gray-300 {
            border-color: var(--border-color) !important;
        }
        .dark input,
        .dark select,
        .dark textarea {
            background-color: var(--input-bg) !important;
            border-color: var(--input-border) !important;
            color: var(--text-primary) !important;
        }
        .dark input::placeholder {
            color: var(--text-muted) !important;
        }
        .dark .schedule-table th {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
        }
        .dark .schedule-table td {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        .dark .schedule-cell:hover {
            background-color: var(--hover-bg) !important;
        }
        .dark .calendar-header {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
        }
        .dark .calendar-day {
            background-color: var(--bg-secondary) !important;
        }
        .dark .calendar-day.other-month {
            background-color: var(--bg-tertiary) !important;
        }
        .dark #mobile-nav,
        .dark #main-nav,
        .dark #more-menu-popup > div {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        .dark .nav-button:not(.active) {
            color: var(--text-secondary) !important;
        }
        .dark .schedule-tab:not(.active) {
            color: var(--text-secondary) !important;
        }
        .dark .schedule-tab:hover:not(.active) {
            background-color: var(--bg-tertiary) !important;
        }
        .dark #schedule-modal > div,
        .dark #leave-modal > div,
        .dark #confirm-modal > div,
        .dark #leave-request-modal > div {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button.active {
            background-color: #DA291C;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 50vh;
        }
        @media (max-width: 640px) {
            .chart-container {
                height: 280px;
                max-height: 40vh;
            }
        }
        .stat-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #E5E7EB;
        }
        @media (max-width: 640px) {
            .stat-card {
                padding: 1rem;
            }
            .stat-card p {
                font-size: 1.5rem !important;
            }
        }
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
            max-width: 90%;
            text-align: center;
        }
        .toast.show {
            opacity: 1;
            bottom: 100px;
        }
        @media (min-width: 768px) {
            .toast {
                bottom: 20px;
            }
            .toast.show {
                bottom: 40px;
            }
        }
        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .month-tab.active {
            border-color: #DA291C;
            background-color: #DA291C;
            color: white;
        }
        .schedule-tab {
            color: #4b5563;
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        @media (max-width: 640px) {
            .schedule-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
        }
        .schedule-tab:hover {
            background-color: #f3f4f6;
            border-bottom: 3px solid #d1d5db;
        }
        .schedule-tab.active {
            background-color: #4A5568;
            color: white;
            font-weight: 600;
            border-color: transparent;
            border-radius: 6px 6px 0 0;
        }
        .schedule-tab.active:hover {
             background-color: #4A5568;
        }
        .schedule-table th, .schedule-table td {
            text-align: center;
            padding: 0.25rem;
            border: 1px solid #e2e8f0;
            vertical-align: middle;
            height: 70px;
        }
        @media (max-width: 640px) {
            .schedule-table th, .schedule-table td {
                padding: 0.15rem;
                height: 50px;
                font-size: 0.7rem;
            }
        }
        .schedule-table th {
            background-color: #f8fafc;
            padding: 0.75rem;
        }
        @media (max-width: 640px) {
            .schedule-table th {
                padding: 0.35rem;
            }
        }
        .schedule-cell {
            cursor: pointer;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .schedule-cell:hover {
            background-color: #f7fafc;
        }
        .schedule-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            background-color: white;
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .schedule-input:focus {
            outline: none;
            border-color: #DA291C;
            box-shadow: 0 0 0 2px rgba(218, 41, 28, 0.2);
        }
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
            border: 1px solid #e2e8f0;
        }
        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 0.5rem 0;
            background-color: #f8fafc;
        }
        @media (max-width: 640px) {
            .calendar-header {
                padding: 0.25rem 0;
                font-size: 0.65rem;
            }
        }
        .calendar-day {
            min-height: 100px;
            padding: 0.5rem;
            background-color: white;
            transition: background-color 0.2s;
        }
        @media (max-width: 640px) {
            .calendar-day {
                min-height: 60px;
                padding: 0.25rem;
            }
        }
        .calendar-day:not(.other-month):hover {
            background-color: #f7fafc;
        }
        .calendar-day.other-month {
            background-color: #f1f5f9;
            color: #94a3b8;
        }
        .calendar-day .day-number {
            font-weight: 500;
        }
        @media (max-width: 640px) {
            .calendar-day .day-number {
                font-size: 0.7rem;
            }
        }
        .leave-entry {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 4px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        @media (max-width: 640px) {
            .leave-entry {
                font-size: 0.55rem;
                padding: 1px 2px;
                margin-top: 2px;
            }
        }
        .leave-vl { background-color: #3b82f6; }
        .leave-hl { background-color: #10b981; }
        .leave-sl { background-color: #f59e0b; }
        .planned-leave-cell {
            border: 2px dashed #a5b4fc;
            background-color: #f0f2ff;
        }
        .view-only-hard {
            pointer-events: none !important;
            opacity: 0.6 !important;
        }
        .view-only-hard button, .view-only-hard input, .view-only-hard select {
            cursor: not-allowed !important;
        }
        
        /* Mobile Navigation Improvements */
        #mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding-bottom: env(safe-area-inset-bottom);
        }
        @media (max-width: 767px) {
            #app-container {
                padding-bottom: 70px;
            }
            #main-nav {
                display: none !important;
            }
            #mobile-nav {
                display: grid !important;
            }
            header {
                position: sticky;
                top: 0;
                z-index: 40;
            }
        }
        @media (min-width: 768px) {
            #mobile-nav {
                position: relative;
                border-top: none;
            }
        }
        
        /* Improved touch targets for mobile */
        @media (max-width: 640px) {
            button, input, select, .nav-button {
                min-height: 44px;
            }
            input[type="date"], input[type="text"], input[type="number"], input[type="email"], input[type="password"], input[type="tel"], select {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }
        }
        
        /* Hide scrollbar but allow scrolling */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Schedule tabs horizontal scroll on mobile */
        #manager-schedule-tabs nav {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        @media (max-width: 640px) {
            #manager-schedule-tabs nav {
                flex-wrap: nowrap !important;
                padding-bottom: 0.5rem;
            }
        }
        
        /* Modal improvements for mobile */
        @media (max-width: 640px) {
            #schedule-modal > div,
            #leave-modal > div,
            #confirm-modal > div {
                margin: 0;
                top: auto;
                bottom: 0;
                position: fixed;
                width: 100%;
                max-width: 100%;
                border-radius: 1rem 1rem 0 0;
            }
        }
        
        /* Form improvements */
        @media (max-width: 640px) {
            form .grid-cols-2 {
                grid-template-columns: 1fr;
            }
            .lg\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex-col items-center justify-center z-50 hidden">
        <div class="text-center p-4">
            <svg class="animate-spin h-10 w-10 text-[#DA291C] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">Loading...</p>
        </div>
    </div>
    
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png" alt="Logo" class="h-12 w-auto mx-auto mb-6">
            <h2 class="text-2xl font-bold text-center mb-1">Welcome Back</h2>
            <p class="text-center text-gray-500 mb-6">Please sign in to access the forecaster.</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Username (Email)</label>
                    <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500">
                </div>
                <div id="login-error" class="text-sm text-red-600 h-auto"></div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#DA291C] hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Sign In
                </button>
            </form>
        </div>
    </div>


    <div id="app-container" class="min-h-screen flex-col hidden">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center space-x-4">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png" alt="Logo" class="h-8 w-auto">
                        <h1 class="text-xl md:text-2xl font-bold text-gray-800">McDonald's San Carlos 688</h1>
                    </div>
                     <nav id="main-nav" class="hidden md:flex flex-wrap items-center text-base justify-center">
                        <button data-view="dashboard" class="nav-button active px-3 py-2 rounded-lg font-semibold">Dashboard</button>
                        <button data-view="insights" class="nav-button px-3 py-2 rounded-lg font-semibold">Insights</button>
                        <button data-view="evaluator" class="nav-button px-3 py-2 rounded-lg font-semibold">Evaluator</button>
                        <button data-view="manager-schedule" class="nav-button px-3 py-2 rounded-lg font-semibold">Manager Schedule</button>
                        <button data-view="datamgmt" class="nav-button px-3 py-2 rounded-lg font-semibold">Add Data</button>
                        <button data-view="activities" class="nav-button px-3 py-2 rounded-lg font-semibold">Activities</button>
                        <button data-view="historical" class="nav-button px-3 py-2 rounded-lg font-semibold">History</button>
                        <button data-view="admin" class="nav-button px-3 py-2 rounded-lg font-semibold hidden">Admin</button>
                    </nav>
                     <div class="flex items-center space-x-2 md:space-x-4">
                        <!-- Birthday/Anniversary Notification Bell -->
                        <div class="relative">
                            <button id="notification-bell" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition relative">
                                <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                                </svg>
                                <span id="notification-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold hidden">0</span>
                            </button>
                            <!-- Notification Dropdown -->
                            <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 hidden z-50">
                                <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="font-bold text-gray-800 dark:text-white">üéÇ Celebrations</h3>
                                </div>
                                <div id="notification-list" class="max-h-64 overflow-y-auto">
                                    <p class="p-4 text-gray-500 text-sm text-center">No celebrations today</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dark Mode Toggle -->
                        <button id="dark-mode-toggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition" title="Toggle Dark Mode">
                            <svg id="dark-mode-icon-sun" class="w-6 h-6 text-gray-600 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                            <svg id="dark-mode-icon-moon" class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                            </svg>
                        </button>
                        
                        <p id="user-greeting" class="hidden md:block text-sm font-semibold"></p>
                        <button id="logout-btn" class="hidden md:flex items-center space-x-2 px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition">
                            <span>Logout</span>
                        </button>
                     </div>
                </div>
            </div>
        </header>
        
        <nav id="mobile-nav" class="md:hidden bg-white shadow-lg p-2 grid grid-cols-4 gap-1">
            <button data-view="dashboard" class="nav-button active flex flex-col items-center justify-center text-xs py-2 px-1 rounded-lg font-semibold">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
                <span>Dashboard</span>
            </button>
            <button data-view="manager-schedule" class="nav-button flex flex-col items-center justify-center text-xs py-2 px-1 rounded-lg font-semibold">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                <span>Schedule</span>
            </button>
            <button data-view="activities" class="nav-button flex flex-col items-center justify-center text-xs py-2 px-1 rounded-lg font-semibold">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                <span>Activities</span>
            </button>
            <button id="more-menu-trigger" class="nav-button flex flex-col items-center justify-center text-xs py-2 px-1 rounded-lg font-semibold">
                <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                <span>More</span>
            </button>
        </nav>

        <!-- More Menu Popup for Mobile -->
        <div id="more-menu-popup" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden md:hidden">
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl p-4 pb-8">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
                <div class="grid grid-cols-4 gap-3">
                    <button data-view="insights" class="nav-button flex flex-col items-center justify-center text-xs py-3 px-1 rounded-lg font-semibold">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                        <span>Insights</span>
                    </button>
                    <button data-view="evaluator" class="nav-button flex flex-col items-center justify-center text-xs py-3 px-1 rounded-lg font-semibold">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>Evaluator</span>
                    </button>
                    <button data-view="datamgmt" class="nav-button flex flex-col items-center justify-center text-xs py-3 px-1 rounded-lg font-semibold">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        <span>Add Data</span>
                    </button>
                    <button data-view="historical" class="nav-button flex flex-col items-center justify-center text-xs py-3 px-1 rounded-lg font-semibold">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span>History</span>
                    </button>
                    <button data-view="admin" class="nav-button flex flex-col items-center justify-center text-xs py-3 px-1 rounded-lg font-semibold hidden" id="admin-more-btn">
                        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <span>Admin</span>
                    </button>
                </div>
                <button id="close-more-menu" class="w-full mt-4 py-3 bg-gray-100 rounded-lg font-semibold text-gray-700">Close</button>
            </div>
        </div>


        <main id="content-area" class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="provisional-forecast-banner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
                <p class="font-bold">Provisional Forecast</p>
                <p>Displaying a basic forecast generated from historical data. For the advanced prediction, please run the backend Python engine.</p>
            </div>
            
            <section id="dashboard-section" class="view">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Dashboard</h2>
                    <p class="text-gray-600">This section presents the 15-day outlook for projected sales and customer traffic, providing a high-level overview of expected performance.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Daily Sales (7-Day)</h3>
                        <p id="avg-sales" class="text-4xl font-bold text-[#DA291C] mt-2">‚Ç±0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Daily Customers (7-Day)</h3>
                        <p id="avg-customers" class="text-4xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Transaction Value (7-Day)</h3>
                        <p id="avg-atv" class="text-4xl font-bold text-gray-800 mt-2">‚Ç±0.00</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                     <h3 class="text-xl font-bold mb-4">15-Day Performance Outlook</h3>
                    <div class="chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="insights-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Insights</h2>
                    <p class="text-gray-600">Explore the underlying drivers of the daily forecast. This waterfall chart breaks down how factors like the day of the week, seasonality, and holidays contribute to the final customer projection.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h3 class="text-xl font-bold mb-2 sm:mb-0">Daily Driver Analysis</h3>
                        <div>
                            <label for="insightDate" class="font-semibold mr-2">Select a Date:</label>
                            <select id="insightDate" class="p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
                        <div class="lg:col-span-2 chart-container">
                            <canvas id="waterfallChart"></canvas>
                        </div>
                        <div id="insight-summary" class="bg-gray-50 p-6 rounded-lg border">
                            <h4 class="font-bold text-lg mb-2">Summary</h4>
                            <p class="text-gray-700">Select a date to see a summary of its forecast drivers.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="evaluator-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Evaluator</h2>
                    <p class="text-gray-600">This section measures the model's historical accuracy by comparing past day-ahead forecasts against actual results. This helps build trust and identify areas for model improvement.</p>
                </div>
                <div class="flex justify-center mb-6">
                     <div class="inline-flex rounded-lg shadow-sm bg-white border">
                        <button id="eval-7-day" class="eval-toggle-button bg-[#DA291C] text-white px-4 py-2 rounded-l-lg font-semibold">Last 7 Days</button>
                        <button id="eval-30-day" class="eval-toggle-button px-4 py-2 font-semibold text-gray-600">Last 30 Days</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                     <div class="stat-card">
                         <h3 class="text-lg font-semibold text-gray-500">Sales Accuracy (vs MAPE)</h3>
                         <p id="sales-accuracy" class="text-3xl font-bold mt-1">0.00%</p>
                     </div>
                     <div class="stat-card">
                         <h3 class="text-lg font-semibold text-gray-500">Customer Accuracy (vs MAPE)</h3>
                         <p id="customer-accuracy" class="text-3xl font-bold mt-1">0.00%</p>
                     </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Actual vs. Forecasted Sales</h3>
                        <div class="chart-container">
                            <canvas id="salesEvalChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Actual vs. Forecasted Customers</h3>
                        <div class="chart-container">
                            <canvas id="customersEvalChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="manager-schedule-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Manager Schedule</h2>
                    <p class="text-gray-600">Plot daily shifts and track leaves for managers. Planned leaves from the "HL & VL Schedule" will appear here with a dashed border; click to confirm them.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <!-- Dropdown Navigation + Request Button -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6 pb-4 border-b border-gray-200">
                        <div class="flex items-center gap-3 w-full sm:w-auto">
                            <label for="schedule-tab-select" class="font-semibold text-gray-700 whitespace-nowrap">View:</label>
                            <select id="schedule-tab-select" class="flex-1 sm:w-64 p-2.5 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none font-medium bg-white">
                                <option value="my-schedule">üìÖ My Schedule</option>
                                <option value="weekly-schedule">üìä Weekly Schedule</option>
                                <option value="shift-schedule">üîÑ Shift Schedule</option>
                                <option value="leave-schedule">üèñÔ∏è HL & VL Schedule</option>
                                <option value="leave-tracking">üìã Leave Tracking</option>
                                <option value="gy-ot">üåô GY & OT</option>
                                <option value="schedule-requests">üìù Schedule Requests</option>
                                <option value="manage-managers">‚öôÔ∏è Manage Managers</option>
                            </select>
                        </div>
                        <button id="new-schedule-request-btn" class="w-full sm:w-auto px-4 py-2.5 bg-[#DA291C] text-white rounded-lg font-semibold text-sm hover:bg-red-700 transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            New Request
                        </button>
                    </div>

                    <div id="my-schedule-content" class="schedule-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-[#DA291C] rounded-full flex items-center justify-center text-white font-bold mr-3">
                                    <span id="my-schedule-avatar">M</span>
                                </div>
                                <div>
                                    <h3 id="my-schedule-name" class="text-lg font-bold">My Schedule</h3>
                                    <p class="text-sm text-gray-500">Your weekly duty assignments</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex items-center">
                                    <label for="my-schedule-week-picker" class="font-semibold mr-2 text-sm">Week:</label>
                                    <input type="date" id="my-schedule-week-picker" class="p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manager Profile Selector (shown when not auto-matched) -->
                        <div id="my-schedule-profile-selector" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                                <div class="flex-1">
                                    <p class="font-semibold text-blue-800">Select Your Profile</p>
                                    <p class="text-sm text-blue-600">Choose your manager profile to view your schedule</p>
                                </div>
                                <div class="flex items-center gap-2 w-full sm:w-auto">
                                    <select id="my-schedule-manager-select" class="flex-1 sm:w-48 p-2 rounded-lg border-2 border-blue-300 focus:border-blue-500 focus:outline-none text-sm">
                                        <option value="">-- Select Manager --</option>
                                    </select>
                                    <button id="my-schedule-save-profile" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold text-sm hover:bg-blue-700">
                                        Save
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- My Schedule Cards -->
                        <div id="my-schedule-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        
                        <!-- Weekly Summary -->
                        <div id="my-schedule-summary" class="mt-6 p-4 bg-gray-50 rounded-xl">
                            <h4 class="font-bold text-gray-700 mb-3">Weekly Summary</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                                <div class="bg-white p-3 rounded-lg shadow-sm">
                                    <p class="text-2xl font-bold text-[#DA291C]" id="my-schedule-total-days">0</p>
                                    <p class="text-xs text-gray-500">Working Days</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg shadow-sm">
                                    <p class="text-2xl font-bold text-blue-600" id="my-schedule-off-days">0</p>
                                    <p class="text-xs text-gray-500">Days Off</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg shadow-sm">
                                    <p class="text-2xl font-bold text-green-600" id="my-schedule-leave-days">0</p>
                                    <p class="text-xs text-gray-500">Leave Days</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg shadow-sm">
                                    <p class="text-2xl font-bold text-purple-600" id="my-schedule-gy-days">0</p>
                                    <p class="text-xs text-gray-500">GY Shifts</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="weekly-schedule-content" class="schedule-content hidden">
                        <div class="flex justify-end items-center mb-4">
                            <label for="week-picker" class="font-semibold mr-2">Select Week:</label>
                            <input type="date" id="week-picker" class="p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                        </div>
                        <div class="overflow-x-auto hidden md:block">
                            <table id="weekly-schedule-table" class="min-w-full bg-white border schedule-table"></table>
                        </div>
                        <div id="weekly-schedule-mobile" class="block md:hidden space-y-4"></div>
                    </div>

                    <div id="shift-schedule-content" class="schedule-content hidden">
                        <div class="overflow-x-auto hidden md:block">
                            <table id="shift-schedule-table" class="min-w-full bg-white border schedule-table"></table>
                        </div>
                        <div id="shift-schedule-mobile" class="block md:hidden space-y-4"></div>
                    </div>

                    <div id="leave-schedule-content" class="schedule-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-2">
                                <button id="prev-month-btn" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300">&lt;</button>
                                <h3 id="calendar-month-year" class="text-xl font-bold text-center w-48"></h3>
                                <button id="next-month-btn" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300">&gt;</button>
                            </div>
                            <button id="add-leave-btn" class="px-4 py-2 bg-[#DA291C] text-white font-semibold rounded-lg hover:bg-red-700">Add Leave</button>
                        </div>
                        <div id="leave-calendar-container"></div>
                    </div>

                    <div id="leave-tracking-content" class="schedule-content hidden">
                        <h3 class="text-xl font-bold mb-4">Manager Leave Summary (Consumed)</h3>
                        <p class="text-sm text-gray-500 mb-4">This tab shows leaves that have been confirmed in the Weekly Schedule.</p>
                        <div id="leave-records-container" class="space-y-4"></div>
                    </div>

                    <div id="gy-ot-content" class="schedule-content hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <div class="flex items-center space-x-2">
                                <button id="gy-ot-prev-month-btn" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300">&lt;</button>
                                <h3 id="gy-ot-month-year" class="text-xl font-bold text-center w-48"></h3>
                                <button id="gy-ot-next-month-btn" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300">&gt;</button>
                            </div>
                            <div>
                                <label for="gy-ot-cutoff-select" class="sr-only">Select Cut-off Period</label>
                                <select id="gy-ot-cutoff-select" class="p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                                    <option value="all" selected>All Month</option>
                                    <option value="1-15">Days 1-15</option>
                                    <option value="16-31">Days 16-31</option>
                                </select>
                            </div>
                        </div>
                        <div id="gy-ot-records-container" class="space-y-6"></div>
                    </div>

                    <div id="manage-managers-content" class="schedule-content hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <!-- Add New Manager Form -->
                            <div class="lg:col-span-1">
                                <h3 class="text-xl font-bold mb-4">Add New Manager</h3>
                                <form id="add-manager-form" class="space-y-4">
                                    <div>
                                        <label for="manager-name" class="block font-semibold mb-1">Manager Name</label>
                                        <input type="text" id="manager-name" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none" required>
                                    </div>
                                    <div>
                                        <label for="manager-birthday" class="block font-semibold mb-1">Birthday</label>
                                        <input type="date" id="manager-birthday" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                                    </div>
                                    <div>
                                        <label for="manager-hire-date" class="block font-semibold mb-1">Hire Date (Work Anniversary)</label>
                                        <input type="date" id="manager-hire-date" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                                    </div>
                                    <div>
                                        <label for="manager-position" class="block font-semibold mb-1">Position</label>
                                        <select id="manager-position" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                                            <option value="RGM">Restaurant General Manager (RGM)</option>
                                            <option value="PDM">People Development Manager (PDM)</option>
                                            <option value="FQM">Food Quality Manager (FQM)</option>
                                            <option value="CEM">Customer Experience Manager (CEM)</option>
                                            <option value="ADM">Admin Manager (ADM)</option>
                                            <option value="SL">Shift Leader (SL)</option>
                                            <option value="MT">Manager Trainee (MT)</option>
                                            <option value="TL">Team Leader (TL)</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="w-full bg-[#DA291C] text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition duration-300">Add Manager</button>
                                </form>
                            </div>
                            
                            <!-- Current Managers List -->
                            <div class="lg:col-span-2">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold">Team Members</h3>
                                </div>
                                <div id="manager-list-container" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schedule Requests Tab Content -->
                    <div id="schedule-requests-content" class="schedule-content hidden">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-2">Schedule Requests</h3>
                            <p class="text-gray-500 text-sm">View and manage schedule change requests from team members.</p>
                        </div>
                        
                        <!-- Pending Requests (Admin View) -->
                        <div id="pending-requests-section" class="mb-8">
                            <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                                <span class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></span>
                                Pending Approval
                            </h4>
                            <div id="pending-requests-container" class="space-y-3">
                                <p class="text-gray-500 text-center py-4 bg-gray-50 rounded-lg">No pending requests</p>
                            </div>
                        </div>
                        
                        <!-- My Requests (User View) -->
                        <div id="my-requests-section">
                            <h4 class="font-bold text-lg mb-3">My Requests</h4>
                            <div id="my-requests-container" class="space-y-3">
                                <p class="text-gray-500 text-center py-4 bg-gray-50 rounded-lg">You haven't made any requests yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="datamgmt-section" class="view hidden">
                 <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Add New Data</h2>
                    <p class="text-gray-600">Add new daily records and future activities to improve forecast accuracy.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Add New Daily Record</h3>
                        <form id="daily-record-form" class="space-y-4">
                            <div>
                                <label for="record-date" class="block font-semibold mb-1">Date</label>
                                <input type="date" id="record-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="record-sales" class="block font-semibold mb-1">Total Sales (‚Ç±)</label>
                                    <input type="number" step="0.01" id="record-sales" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-customers" class="block font-semibold mb-1">Customers</label>
                                    <input type="number" id="record-customers" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-addons" class="block font-semibold mb-1">Add-on Sales (‚Ç±)</label>
                                    <input type="number" step="0.01" id="record-addons" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-weather" class="block font-semibold mb-1">Weather</label>
                                    <select id="record-weather" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                        <option>Sunny</option>
                                        <option>Cloudy</option>
                                        <option>Rainy</option>
                                        <option>Storm</option>
                                    </select>
                                </div>
                            </div>
                             <button type="submit" class="w-full bg-[#DA291C] text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition duration-300">Save Daily Record</button>
                        </form>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Add Future Event</h3>
                        <form id="event-form" class="space-y-4">
                             <div>
                                <label for="event-name" class="block font-semibold mb-1">Event Name</label>
                                <input type="text" id="event-name" placeholder="e.g., San Carlos Charter Day" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                             <div>
                                <label for="event-date" class="block font-semibold mb-1">Date</label>
                                <input type="date" id="event-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                            <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition duration-300">Save Event</button>
                        </form>
                    </div>
                </div>
            </section>
            
            <section id="activities-section" class="view hidden">
                 <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Future Activities</h2>
                    <p class="text-gray-600">Add, browse, and manage all upcoming events and promotions.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-bold mb-4">Add New Activity</h3>
                        <form id="activity-form" class="space-y-4">
                             <div>
                                <label for="activity-name" class="block font-semibold mb-1">Activity Name</label>
                                <select id="activity-name" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                    <option>BP</option>
                                    <option>LFO</option>
                                    <option>Funday</option>
                                </select>
                            </div>
                            <div>
                                <label for="event-venue" class="block font-semibold mb-1">Event Venue</label>
                                <select id="event-venue" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                    <option>In-Store</option>
                                    <option>Take-out</option>
                                    <option>Pick-up</option>
                                    <option>Delivery</option>
                                </select>
                            </div>
                            <div>
                                <label for="customer-name" class="block font-semibold mb-1">Customer Name</label>
                                <input type="text" id="customer-name" placeholder="e.g., John Doe" class="w-full p-2 rounded-lg border-2 border-gray-200">
                            </div>
                            <div>
                                <label for="contact-number" class="block font-semibold mb-1">Contact Number</label>
                                <input type="tel" id="contact-number" placeholder="e.g., 09123456789" class="w-full p-2 rounded-lg border-2 border-gray-200">
                            </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="activity-date" class="block font-semibold mb-1">Date</label>
                                    <input type="date" id="activity-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="activity-time" class="block font-semibold mb-1">Time</label>
                                    <div class="flex">
                                        <input type="text" id="activity-time" placeholder="e.g., 10:30" class="w-full p-2 rounded-l-lg border-2 border-r-0 border-gray-200">
                                        <select id="activity-ampm" class="p-2 rounded-r-lg border-2 border-l-0 border-gray-200 bg-gray-50">
                                            <option>AM</option>
                                            <option>PM</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="activity-sales" class="block font-semibold mb-1">Est. Sales (‚Ç±)</label>
                                    <input type="number" step="0.01" id="activity-sales" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="activity-status" class="block font-semibold mb-1">Status</label>
                                    <select id="activity-status" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                        <option>Confirmed</option>
                                        <option>Needs Follow-up</option>
                                        <option>Tentative</option>
                                        <option>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="for-follow-up" class="block font-semibold mb-1">For Follow-up</label>
                                <input type="text" id="for-follow-up" list="follow-up-options" class="w-full p-2 rounded-lg border-2 border-gray-200">
                                <datalist id="follow-up-options">
                                    <option value="time"></option>
                                    <option value="food"></option>
                                    <option value="pax"></option>
                                </datalist>
                            </div>
                             <div>
                                <label for="handled-by" class="block font-semibold mb-1">Handled by</label>
                                <input type="text" id="handled-by" class="w-full p-2 rounded-lg border-2 border-gray-200">
                            </div>
                             <div>
                                <label for="character" class="block font-semibold mb-1">Character</label>
                                <select id="character" class="w-full p-2 rounded-lg border-2 border-gray-200">
                                    <option>None</option>
                                    <option>1</option>
                                    <option>2</option>
                                    <option>Full</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition duration-300">Save Activity</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="flex space-x-4 mb-4 bg-white p-4 rounded-lg shadow-sm border">
                            <div>
                                <label for="activity-year" class="block text-sm font-medium text-gray-700">Year</label>
                                <select id="activity-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"></select>
                            </div>
                        </div>
                        <div id="activity-tabs-container" class="mb-4 border-b border-gray-300">
                            </div>
                        <div id="activity-content-container">
                            </div>
                    </div>
                </div>
            </section>

            <section id="historical-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Historical Data</h2>
                    <p class="text-gray-600">Browse and manage past daily records.</p>
                </div>
                <div class="flex space-x-4 mb-4 bg-white p-4 rounded-lg shadow-sm border">
                    <div>
                        <label for="hist-year" class="block text-sm font-medium text-gray-700">Year</label>
                        <select id="hist-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="hist-month" class="block text-sm font-medium text-gray-700">Month</label>
                        <select id="hist-month" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"></select>
                    </div>
                </div>
                <div id="historical-list" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                    </div>
            </section>

            <section id="admin-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">User Management</h2>
                    <p class="text-gray-600">View and manage user access levels. New users should be created securely in the Firebase Console.</p>
                </div>
                <div id="user-list" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 space-y-4">
                    </div>
            </section>

        </main>
    </div>
    <div id="toast-container"></div>

    <!-- Schedule Editing Modal -->
    <div id="schedule-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="modal-title">Edit Schedule</h3>
            <div class="space-y-4">
                <div>
                    <label for="modal-shift-select" class="block text-sm font-medium text-gray-700">Shift</label>
                    <select id="modal-shift-select" class="mt-1 block w-full schedule-input"></select>
                </div>
                <div id="modal-time-container">
                    <label for="modal-time-input" class="block text-sm font-medium text-gray-700">Time of Duty</label>
                    <input type="text" id="modal-time-input" list="time-choices" class="mt-1 block w-full schedule-input" placeholder="e.g., 9am-6pm or select">
                    <datalist id="time-choices">
                        <option value="6am-3pm"></option>
                        <option value="7am-4pm"></option>
                        <option value="2pm-11pm"></option>
                        <option value="4pm-1am"></option>
                        <option value="8am-5pm"></option>
                        <option value="10pm-7am"></option>
                        <option value="10am-7pm"></option>
                    </datalist>
                </div>
            </div>
            <div class="mt-6 space-y-2">
                <button id="modal-save-btn" class="w-full px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Save
                </button>
                 <button id="modal-delete-btn" class="w-full px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Clear Schedule
                </button>
                <button id="modal-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Leave Plotting Modal -->
    <div id="leave-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="leave-modal-title">Plot Leave</h3>
            <div class="space-y-4">
                <div>
                    <label for="leave-manager-select" class="block text-sm font-medium text-gray-700">Manager</label>
                    <select id="leave-manager-select" class="mt-1 block w-full schedule-input"></select>
                </div>
                 <div>
                    <label for="leave-type-select" class="block text-sm font-medium text-gray-700">Leave Type</label>
                    <select id="leave-type-select" class="mt-1 block w-full schedule-input">
                        <option value="VL">Vacation Leave (VL)</option>
                        <option value="HL">Holiday Leave (HL)</option>
                        <option value="SL">Sick Leave (SL)</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="leave-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="leave-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="leave-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="leave-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            </div>
            <div class="mt-6 space-y-2">
                <button id="leave-save-btn" class="w-full px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-700">Save Leave</button>
                <button id="leave-delete-btn" class="w-full px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 hidden">Delete Leave</button>
                <button id="leave-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-2">Confirm Action</h3>
            <p id="confirm-modal-text" class="text-sm text-gray-600 mb-4">Are you sure?</p>
            <div class="flex justify-end space-x-2">
                <button id="confirm-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">
                    Cancel
                </button>
                <button id="confirm-modal-confirm-btn" class="w-full px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Manager Modal -->
    <div id="edit-manager-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Edit Manager</h3>
                <button id="edit-manager-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="edit-manager-name" class="block font-semibold mb-1">Manager Name</label>
                    <input type="text" id="edit-manager-name" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none" required>
                </div>
                <div>
                    <label for="edit-manager-birthday" class="block font-semibold mb-1">Birthday</label>
                    <input type="date" id="edit-manager-birthday" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                </div>
                <div>
                    <label for="edit-manager-hire-date" class="block font-semibold mb-1">Hire Date (Work Anniversary)</label>
                    <input type="date" id="edit-manager-hire-date" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                </div>
                <div>
                    <label for="edit-manager-position" class="block font-semibold mb-1">Position</label>
                    <select id="edit-manager-position" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                        <option value="RGM">Restaurant General Manager (RGM)</option>
                        <option value="PDM">People Development Manager (PDM)</option>
                        <option value="FQM">Food Quality Manager (FQM)</option>
                        <option value="CEM">Customer Experience Manager (CEM)</option>
                        <option value="ADM">Admin Manager (ADM)</option>
                        <option value="SL">Shift Leader (SL)</option>
                        <option value="MT">Manager Trainee (MT)</option>
                        <option value="TL">Team Leader (TL)</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 space-y-2">
                <button id="edit-manager-save-btn" class="w-full px-4 py-3 bg-[#DA291C] text-white text-base font-bold rounded-lg hover:bg-red-700 transition">Save Changes</button>
                <button id="edit-manager-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-lg hover:bg-gray-300 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Schedule Request Modal -->
    <div id="schedule-request-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-md shadow-lg rounded-xl bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">üìù New Schedule Request</h3>
                <button id="schedule-request-modal-close" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            
            <!-- Info Box -->
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">üìå Your request will be reviewed by the admin. Once approved, it will automatically appear in the Weekly Schedule.</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block font-semibold mb-1">Request Type</label>
                    <select id="schedule-request-type" class="w-full p-2.5 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                        <option value="">-- Select Request Type --</option>
                        <option value="rest-day">üè† Request Rest Day (OFF)</option>
                        <option value="pull-out">üö™ Request Pull-out</option>
                        <option value="swap-shift">üîÑ Request Shift Swap</option>
                        <option value="others">üìã Others</option>
                    </select>
                </div>
                
                <div>
                    <label class="block font-semibold mb-1">Requesting For</label>
                    <select id="schedule-request-manager" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none"></select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-1">Date</label>
                        <input type="date" id="schedule-request-date" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                    </div>
                    <div id="schedule-request-end-date-container">
                        <label class="block font-semibold mb-1">End Date <span class="text-gray-400 text-xs">(if multiple days)</span></label>
                        <input type="date" id="schedule-request-end-date" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                    </div>
                </div>
                
                <!-- Swap With (shown only for shift swap) -->
                <div id="schedule-request-swap-container" class="hidden">
                    <label class="block font-semibold mb-1">Swap Shift With</label>
                    <select id="schedule-request-swap-with" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none"></select>
                </div>
                
                <!-- Preferred Time (shown for time change) -->
                <div id="schedule-request-time-container" class="hidden">
                    <label class="block font-semibold mb-1">Preferred Time</label>
                    <input type="text" id="schedule-request-time" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none" placeholder="e.g., 6am-3pm">
                </div>
                
                <div>
                    <label class="block font-semibold mb-1">Reason / Details</label>
                    <textarea id="schedule-request-reason" rows="3" class="w-full p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none resize-none" placeholder="Please explain your request..."></textarea>
                </div>
            </div>
            
            <div class="mt-6 space-y-2">
                <button id="schedule-request-submit-btn" class="w-full px-4 py-3 bg-[#DA291C] text-white text-base font-bold rounded-lg hover:bg-red-700 transition">Submit Request</button>
                <button id="schedule-request-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-lg hover:bg-gray-300 transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ****** FULLY IMPLEMENTED SCRIPT WITH ALL FIXES ****** -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- FIREBASE INITIALIZATION ---
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded. Please check your internet connection.');
                alert('Error: Could not load Firebase. Please refresh the page.');
                return;
            }
            
            const firebaseConfig = {
              apiKey: "AIzaSyBlbxhzUp_TZd8oTrLxrY-E6gq-_XdiMCo",
              authDomain: "mcdonalds-san-carlos.firebaseapp.com",
              projectId: "mcdonalds-san-carlos",
              storageBucket: "mcdonalds-san-carlos.appspot.com",
              messagingSenderId: "1052052612983",
              appId: "1:1052052612983:web:8df02d65d12e99e0666372",
              measurementId: "G-EYSWHXTQ6F"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // --- GLOBAL STATE & CHARTS ---
            let charts = {};
            const appState = {
                currentView: 'dashboard',
                evalDays: 7,
                forecastData: null,
                evaluationData: null,
                insightsData: null,
                activitiesData: null,
                historicalData: null,
                usersData: null,
                managers: [],
                managerSchedules: {},
                plottedLeaves: [],
                calendarDate: new Date(),
                accessLevel: 3, // Default to viewer
                currentUserEmail: null,
                currentUserManagerId: null,
                currentUserManagerName: null,
                leaveRequests: [],
                darkMode: localStorage.getItem('darkMode') === 'true',
            };
            
            // --- DARK MODE INITIALIZATION ---
            if (appState.darkMode) {
                document.documentElement.classList.add('dark');
                document.getElementById('dark-mode-icon-sun')?.classList.remove('hidden');
                document.getElementById('dark-mode-icon-moon')?.classList.add('hidden');
            }
            
            // --- UI ELEMENT SELECTORS ---
            const UI = {
                loadingOverlay: document.getElementById('loading-overlay'),
                loadingText: document.getElementById('loading-text'),
                loginScreen: document.getElementById('login-screen'),
                appContainer: document.getElementById('app-container'),
                loginForm: document.getElementById('login-form'),
                loginError: document.getElementById('login-error'),
                logoutBtn: document.getElementById('logout-btn'),
                userGreeting: document.getElementById('user-greeting'),
                navButtons: document.querySelectorAll('.nav-button'),
            };

            // --- UTILITY FUNCTIONS ---
            function showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 100);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }

            function getLocalDateString(date) {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = (d.getMonth() + 1).toString().padStart(2, '0');
                const day = d.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            function createUTCDate(dateString) {
                const parts = dateString.split('-');
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed in JavaScript
                const day = parseInt(parts[2], 10);
                return new Date(Date.UTC(year, month, day));
            }

            function getWeekDateStrings(date) {
                const startOfWeek = new Date(date);
                const dayOfWeek = startOfWeek.getDay();
                const diff = startOfWeek.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                startOfWeek.setDate(diff);
                return Array.from({ length: 7 }).map((_, i) => {
                    const weekDay = new Date(startOfWeek);
                    weekDay.setDate(startOfWeek.getDate() + i);
                    return getLocalDateString(weekDay);
                });
            }
            
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
            const cancelBtn = document.getElementById('confirm-modal-cancel-btn');
            let confirmCallback = null;

            function showConfirm(message, onConfirm) {
                confirmModalText.textContent = message;
                confirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
            }

            confirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                confirmModal.classList.add('hidden');
            });

            cancelBtn.addEventListener('click', () => {
                confirmModal.classList.add('hidden');
            });


            // --- DATA LOADING ---
            async function loadInitialData() {
                UI.loadingText.textContent = 'Loading All Application Data...';
                
                try {
                    const thirtyFiveDaysAgo = new Date();
                    thirtyFiveDaysAgo.setDate(thirtyFiveDaysAgo.getDate() - 35);

                    const [
                        dashboardLogSnapshot,
                        allHistoricalSnapshot,
                        activitiesSnapshot,
                        usersSnapshot,
                        evalLogSnapshot,
                        evalHistoricalSnapshot,
                        managersSnapshot,
                        leavesSnapshot,
                        scheduleRequestsSnapshot
                    ] = await Promise.all([
                        db.collection("forecast_log").orderBy("generated_on", "desc").limit(15).get(),
                        db.collection("historical_data").orderBy("date", "desc").get(),
                        db.collection("future_activities").orderBy("date", "asc").get(),
                        db.collection("users").get(),
                        db.collection("forecast_log").where("forecast_for_date", ">=", thirtyFiveDaysAgo).get(),
                        db.collection("historical_data").where("date", ">=", thirtyFiveDaysAgo).orderBy("date", "desc").get(),
                        db.collection("managers").orderBy("sortOrder").get(),
                        db.collection("plotted_leaves").get(),
                        db.collection("schedule_requests").orderBy("createdAt", "desc").get()
                    ]);

                    appState.historicalData = allHistoricalSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.activitiesData = activitiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.usersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.managers = managersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.plottedLeaves = leavesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.leaveRequests = scheduleRequestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    processForecastData(dashboardLogSnapshot);
                    processEvaluationData(evalLogSnapshot, evalHistoricalSnapshot);
                    
                    // Check for birthdays and anniversaries
                    checkCelebrations();
                    
                    updateView();
                    setupDynamicContent();

                } catch (error) {
                    console.error("Firebase Error:", error);
                    showToast("Error loading application data. Some features may not work.", "error");
                } finally {
                    UI.loadingOverlay.style.display = 'none';
                }
            }
            
            // --- BIRTHDAY & ANNIVERSARY CELEBRATIONS ---
            function checkCelebrations() {
                const today = new Date();
                const todayMonth = today.getMonth() + 1;
                const todayDay = today.getDate();
                const celebrations = [];
                
                appState.managers.forEach(manager => {
                    // Check birthday
                    if (manager.birthday) {
                        const bday = new Date(manager.birthday + 'T00:00:00');
                        if (bday.getMonth() + 1 === todayMonth && bday.getDate() === todayDay) {
                            celebrations.push({
                                type: 'birthday',
                                name: manager.name,
                                icon: 'üéÇ',
                                message: `Happy Birthday, ${manager.name}!`
                            });
                        }
                        // Check upcoming (next 7 days)
                        for (let i = 1; i <= 7; i++) {
                            const futureDate = new Date(today);
                            futureDate.setDate(today.getDate() + i);
                            if (bday.getMonth() === futureDate.getMonth() && bday.getDate() === futureDate.getDate()) {
                                celebrations.push({
                                    type: 'birthday-upcoming',
                                    name: manager.name,
                                    icon: 'üéÇ',
                                    message: `${manager.name}'s birthday in ${i} day${i > 1 ? 's' : ''}`
                                });
                            }
                        }
                    }
                    
                    // Check work anniversary
                    if (manager.hireDate) {
                        const hireDate = new Date(manager.hireDate + 'T00:00:00');
                        if (hireDate.getMonth() + 1 === todayMonth && hireDate.getDate() === todayDay) {
                            const years = today.getFullYear() - hireDate.getFullYear();
                            if (years > 0) {
                                celebrations.push({
                                    type: 'anniversary',
                                    name: manager.name,
                                    icon: 'üéâ',
                                    message: `${manager.name}'s ${years}-year work anniversary!`
                                });
                            }
                        }
                    }
                });
                
                // Update notification bell
                const badge = document.getElementById('notification-badge');
                const notificationList = document.getElementById('notification-list');
                
                if (celebrations.length > 0) {
                    badge?.classList.remove('hidden');
                    badge.textContent = celebrations.length;
                    
                    notificationList.innerHTML = celebrations.map(c => `
                        <div class="p-3 border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700">
                            <div class="flex items-center space-x-3">
                                <span class="text-2xl">${c.icon}</span>
                                <div>
                                    <p class="font-semibold text-gray-800 dark:text-white">${c.message}</p>
                                    <p class="text-xs text-gray-500">${c.type === 'birthday' || c.type === 'anniversary' ? 'Today!' : 'Upcoming'}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    badge?.classList.add('hidden');
                    notificationList.innerHTML = '<p class="p-4 text-gray-500 text-sm text-center">No celebrations this week</p>';
                }
            }

            function processForecastData(snapshot) {
                const provisionalBanner = document.getElementById('provisional-forecast-banner');
                if (snapshot.empty) {
                    provisionalBanner?.classList.remove('hidden');
                    generateProvisionalForecast();
                } else {
                    provisionalBanner?.classList.add('hidden');
                    const forecastDocs = snapshot.docs.map(doc => doc.data()).reverse();
                    appState.forecastData = {
                        dates: forecastDocs.map(d => d.forecast_for_date.toDate()),
                        sales: forecastDocs.map(d => d.predicted_sales),
                        customers: forecastDocs.map(d => d.predicted_customers),
                    };
                }

                if (appState.forecastData && appState.forecastData.dates.length > 0) {
                    const recentHistoryForInsight = appState.historicalData.slice(0, 30).map(h => h.customers).reverse();
                    const trendMovingAverage = recentHistoryForInsight.length > 0 ? recentHistoryForInsight.slice(-7).reduce((a, b) => a + b, 0) / 7 : 250;
                    appState.insightsData = appState.forecastData.dates.map((date, i) => {
                        const forecastCustomers = appState.forecastData.customers[i];
                        return { date, trend: trendMovingAverage, seasonal_effect: forecastCustomers - trendMovingAverage, total: forecastCustomers };
                    });
                }
            }
            
            function generateProvisionalForecast() {
                if (!appState.historicalData || appState.historicalData.length < 7) return;
                const dates = Array.from({length: 15}, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() + i + 1);
                    return d;
                });
                const last7DaysCustomers = appState.historicalData.slice(0, 7).map(d => d.customers);
                const avgCustomers = last7DaysCustomers.reduce((a, b) => a + b, 0) / 7;
                const last7DaysATV = appState.historicalData.slice(0, 7).map(d => (d.sales / d.customers));
                const avgATV = last7DaysATV.reduce((a,b) => a+b, 0) / 7;

                appState.forecastData = {
                    dates: dates,
                    customers: Array(15).fill(avgCustomers),
                    sales: Array(15).fill(avgCustomers * avgATV)
                };
            }

            function processEvaluationData(evalLogSnapshot, evalHistoricalSnapshot) {
                const latestForecastsForEval = new Map();
                evalLogSnapshot.docs.forEach(doc => {
                    const log = doc.data();
                    const logDateStr = getLocalDateString(log.forecast_for_date.toDate());
                    const existing = latestForecastsForEval.get(logDateStr);
                    if (!existing || log.generated_on.toMillis() > existing.generated_on.toMillis()) {
                        latestForecastsForEval.set(logDateStr, log);
                    }
                });

                const actualsForEval = new Map();
                evalHistoricalSnapshot.docs.forEach(doc => {
                    const actual = doc.data();
                    actualsForEval.set(getLocalDateString(actual.date.toDate()), { id: doc.id, ...actual });
                });

                const mergedEvalData = [];
                actualsForEval.forEach((actual, actualDateStr) => {
                    if (latestForecastsForEval.has(actualDateStr)) {
                        const forecast = latestForecastsForEval.get(actualDateStr);
                        mergedEvalData.push({
                            date: actual.date.toDate(),
                            actual_sales: Number(actual.sales),
                            forecast_sales: Number(forecast.predicted_sales) + Number(actual.add_on_sales || 0), 
                            actual_customers: Number(actual.customers),
                            forecast_customers: Number(forecast.predicted_customers),
                        });
                    }
                });
                appState.evaluationData = mergedEvalData.sort((a,b) => a.date - b.date);
            }

            // --- NAVIGATION & VIEW RENDERING ---
            function updateView() {
                document.querySelectorAll('.view').forEach(section => section.classList.add('hidden'));
                const currentSection = document.getElementById(`${appState.currentView}-section`);
                if(currentSection) currentSection.classList.remove('hidden');

                UI.navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === appState.currentView);
                });
                
                applyAccessControl();

                switch(appState.currentView) {
                    case 'dashboard': renderDashboard(); break;
                    case 'insights': renderInsights(); break;
                    case 'evaluator': renderEvaluator(); break;
                    case 'manager-schedule': renderManagerSchedule(); break;
                    case 'activities': renderActivities(); break;
                    case 'historical': renderHistorical(); break;
                    case 'admin': renderAdmin(); break;
                }
            }

            function setupDynamicContent() {
                setupHistoricalFilters();
                setupActivityFilters();
                const weekPicker = document.getElementById('week-picker');
                if (weekPicker) weekPicker.value = getLocalDateString(new Date());
            }

            // --- ACCESS CONTROL ---
            function applyAccessControl() {
                document.querySelectorAll('.nav-button').forEach(btn => btn.style.display = 'inline-flex');
                document.querySelectorAll('section.view').forEach(sec => sec.classList.remove('view-only-hard'));
                const scheduleSection = document.getElementById('manager-schedule-section');
                if(scheduleSection){
                    scheduleSection.querySelector('#add-manager-form')?.classList.remove('view-only-hard');
                    scheduleSection.querySelectorAll('.delete-manager-btn').forEach(btn => btn.style.display = 'inline-block');
                    scheduleSection.querySelector('#add-leave-btn')?.classList.remove('view-only-hard');
                }

                const level = appState.accessLevel;

                if (level === 1) { // Admin
                    document.querySelector('button[data-view="admin"]')?.classList.remove('hidden');
                } else if (level === 2) { // Manager
                    document.querySelectorAll('button[data-view="admin"]').forEach(btn => btn.style.display = 'none');
                    if (scheduleSection) {
                        scheduleSection.querySelector('#add-manager-form')?.classList.add('view-only-hard');
                        scheduleSection.querySelectorAll('.delete-manager-btn').forEach(btn => btn.style.display = 'none');
                        scheduleSection.querySelector('#add-leave-btn')?.classList.add('view-only-hard');
                    }
                } else if (level === 3) { // Viewer/Staff
                    document.querySelectorAll('.nav-button').forEach(btn => {
                        if (btn.dataset.view !== 'activities') {
                            btn.style.display = 'none';
                        }
                    });
                    document.querySelectorAll('section.view').forEach(sec => {
                        if (sec.id !== 'activities-section') {
                            sec.classList.add('view-only-hard');
                        }
                    });
                }
            }

            // --- FULL RENDER FUNCTIONS ---
            function renderDashboard() {
                if (!appState.forecastData) return;
                const { dates, sales, customers } = appState.forecastData;

                const ctx = document.getElementById('forecastChart')?.getContext('2d');
                if(!ctx) return;
                if(charts.forecast) charts.forecast.destroy();

                charts.forecast = new Chart(ctx, {
                    type: 'line',
                    data: { labels: dates, datasets: [
                        { label: 'Predicted Sales (‚Ç±)', data: sales, borderColor: '#DA291C', backgroundColor: 'rgba(218, 41, 28, 0.1)', yAxisID: 'ySales', tension: 0.3, fill: true },
                        { label: 'Predicted Customers', data: customers, borderColor: '#FFC72C', backgroundColor: 'rgba(255, 199, 44, 0.1)', yAxisID: 'yCustomers', tension: 0.3 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' }, grid: { display: false } },
                            ySales: { type: 'linear', position: 'left', title: { display: true, text: 'Sales (‚Ç±)', font: {weight: 'bold'} }, grid: { color: '#E5E7EB' } },
                            yCustomers: { type: 'linear', position: 'right', title: { display: true, text: 'Customers', font: {weight: 'bold'} }, grid: { display: false } }
                        },
                        plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                        interaction: { mode: 'index', intersect: false }
                    }
                });
                
                const weeklySales = sales.slice(0, 7).reduce((a, b) => a + b, 0) / 7;
                const weeklyCustomers = customers.slice(0, 7).reduce((a, b) => a + b, 0) / 7;
                document.getElementById('avg-sales').textContent = `‚Ç±${weeklySales.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                document.getElementById('avg-customers').textContent = `${Math.round(weeklyCustomers).toLocaleString()}`;
                document.getElementById('avg-atv').textContent = `‚Ç±${(weeklySales/weeklyCustomers || 0).toFixed(2)}`;
            }

            function renderInsights() {
                if (!appState.insightsData) {
                    showToast("No insights data available to display.", "error");
                    return;
                }
                const select = document.getElementById('insightDate');
                if(!select) return;
                select.innerHTML = '';
                appState.insightsData.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.date.toISOString().split('T')[0];
                    option.textContent = d.date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    select.appendChild(option);
                });
                
                select.removeEventListener('change', handleInsightDateChange); 
                select.addEventListener('change', handleInsightDateChange);
                if (appState.insightsData.length > 0) {
                    updateWaterfallChart(select.value);
                }
            }

            function handleInsightDateChange(e) {
                updateWaterfallChart(e.target.value);
            }

            function updateWaterfallChart(dateString) {
                const data = appState.insightsData.find(d => d.date.toISOString().split('T')[0] === dateString);
                if (!data) return;

                const ctx = document.getElementById('waterfallChart')?.getContext('2d');
                if(!ctx) return;
                if (charts.waterfall) charts.waterfall.destroy();

                charts.waterfall = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Baseline Trend', 'Seasonal & Event Effects', 'Final Forecast'],
                        datasets: [{
                            data: [data.trend, data.seasonal_effect, data.total],
                            backgroundColor: ['#3B82F6', data.seasonal_effect >= 0 ? '#10B981' : '#EF4444', '#4B5563'],
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: { x: { title: { display: true, text: 'Customer Count Impact' } } }
                    }
                });
                
                const summaryEl = document.getElementById('insight-summary');
                summaryEl.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">Summary for ${new Date(dateString + 'T08:00:00').toLocaleDateString('en-US', {month: 'long', day: 'numeric'})}</h4>
                    <p class="mb-2">The forecast starts with a baseline trend of <strong>${data.trend.toFixed(0)}</strong> customers.</p>
                    <p class="mb-2">Seasonal and event effects are ${data.seasonal_effect >= 0 ? 'positive' : 'negative'}, adjusting by <strong>${data.seasonal_effect.toFixed(0)}</strong> customers.</p>
                    <hr class="my-3 border-gray-300">
                    <p class="font-bold">Resulting in a final forecast of <strong>${data.total.toFixed(0)}</strong> customers.</p>
                `;
            }

            function renderEvaluator() {
                const salesAccuracyEl = document.getElementById('sales-accuracy');
                const customerAccuracyEl = document.getElementById('customer-accuracy');
                const salesChartCtx = document.getElementById('salesEvalChart')?.getContext('2d');
                const custChartCtx = document.getElementById('customersEvalChart')?.getContext('2d');

                if (charts.salesEval) charts.salesEval.destroy();
                if (charts.custEval) charts.custEval.destroy();
                if(salesAccuracyEl) salesAccuracyEl.textContent = 'N/A';
                if(customerAccuracyEl) customerAccuracyEl.textContent = 'N/A';

                if (!appState.evaluationData || appState.evaluationData.length === 0) {
                    showToast("No matching historical and forecast data found for evaluation.", "error");
                    return;
                }

                const days = appState.evalDays;
                const dataSlice = appState.evaluationData.slice(-days);
                
                if (dataSlice.length === 0) {
                    showToast(`No evaluation data available for the last ${days} days.`, "error");
                    return;
                }
                
                const salesMapeData = dataSlice.filter(d => d.actual_sales > 0);
                const salesMape = salesMapeData.length > 0 
                    ? (salesMapeData.reduce((sum, val) => sum + Math.abs((val.actual_sales - val.forecast_sales) / val.actual_sales), 0) / salesMapeData.length) * 100
                    : 0;

                const custMapeData = dataSlice.filter(d => d.actual_customers > 0);
                const custMape = custMapeData.length > 0
                    ? (custMapeData.reduce((sum, val) => sum + Math.abs((val.actual_customers - val.forecast_customers) / val.actual_customers), 0) / custMapeData.length) * 100
                    : 0;

                if(salesAccuracyEl) salesAccuracyEl.textContent = `${(100 - salesMape).toFixed(2)}%`;
                if(customerAccuracyEl) customerAccuracyEl.textContent = `${(100 - custMape).toFixed(2)}%`;

                if (salesChartCtx) {
                    charts.salesEval = createEvalChart(salesChartCtx, dataSlice.map(d=>d.date), dataSlice.map(d=>d.actual_sales), dataSlice.map(d=>d.forecast_sales));
                }
                
                if (custChartCtx) {
                    charts.custEval = createEvalChart(custChartCtx, dataSlice.map(d=>d.date), dataSlice.map(d=>d.actual_customers), dataSlice.map(d=>d.forecast_customers));
                }
            }
            
            function createEvalChart(ctx, dates, actuals, forecasts) {
                return new Chart(ctx, {
                    type: 'line',
                    data: { labels: dates, datasets: [
                        { label: 'Actual', data: actuals, borderColor: '#DA291C', tension: 0.1 },
                        { label: 'Forecast', data: forecasts, borderColor: '#FFC72C', borderDash: [5, 5], tension: 0.1 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false,
                        scales: { x: { type: 'time', time: { unit: 'day' } } },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            }

            function renderManagerSchedule() {
                const dropdown = document.getElementById('schedule-tab-select');
                const activeTab = dropdown?.value || 'my-schedule';
                
                // Hide all content sections first
                document.querySelectorAll('.schedule-content').forEach(content => content.classList.add('hidden'));
                
                // Show selected content
                const selectedContent = document.getElementById(`${activeTab}-content`);
                if (selectedContent) {
                    selectedContent.classList.remove('hidden');
                }
                
                // Hide manage-managers option for non-admins
                const manageManagersOption = dropdown?.querySelector('option[value="manage-managers"]');
                if (manageManagersOption) {
                    manageManagersOption.style.display = appState.accessLevel === 1 ? 'block' : 'none';
                }
                
                switch(activeTab) {
                    case 'my-schedule':
                        // Load schedule data for current week first, then render
                        const myWeekPicker = document.getElementById('my-schedule-week-picker');
                        if (!myWeekPicker.value) {
                            myWeekPicker.value = getLocalDateString(new Date());
                        }
                        const myWeekDates = getWeekDateStrings(new Date(myWeekPicker.value + 'T00:00:00'));
                        loadScheduleForWeek(myWeekDates).then(() => {
                            renderMySchedule();
                        });
                        break;
                    case 'weekly-schedule':
                        const weekPicker = document.getElementById('week-picker');
                        const weekDates = getWeekDateStrings(new Date(weekPicker.value + 'T00:00:00'));
                        loadScheduleForWeek(weekDates);
                        break;
                    case 'shift-schedule':
                        renderShiftSchedule();
                        break;
                    case 'leave-schedule':
                        loadPlottedLeavesForMonth();
                        break;
                    case 'leave-tracking':
                        loadAndRenderLeaveTracking();
                        break;
                    case 'gy-ot':
                        renderGyOtTracking();
                        break;
                    case 'schedule-requests':
                        renderScheduleRequests();
                        break;
                    case 'manage-managers':
                        renderManagerList();
                        break;
                }
            }

            function renderManagerList() {
                const container = document.getElementById('manager-list-container');
                if (!container) return;
                container.innerHTML = '';
                if (appState.managers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No managers added yet.</p>';
                    return;
                }
                appState.managers.forEach(manager => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600';
                    
                    // Calculate tenure
                    let tenureText = '';
                    if (manager.hireDate) {
                        const hireDate = new Date(manager.hireDate);
                        const today = new Date();
                        const months = (today.getFullYear() - hireDate.getFullYear()) * 12 + (today.getMonth() - hireDate.getMonth());
                        tenureText = months >= 12 ? `${Math.floor(months/12)}y ${months%12}m` : `${months}m`;
                    }
                    
                    div.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-[#DA291C] rounded-full flex items-center justify-center text-white font-bold text-lg">
                                    ${manager.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800 dark:text-white">${manager.name}</p>
                                    <p class="text-sm text-gray-500">${manager.position || 'SL'} ${tenureText ? '‚Ä¢ ' + tenureText : ''}</p>
                                    ${manager.birthday ? `<p class="text-xs text-gray-400">üéÇ ${new Date(manager.birthday + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <button data-id="${manager.id}" class="edit-manager-btn px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition">
                                ‚úèÔ∏è Edit
                            </button>
                            <button data-id="${manager.id}" class="delete-manager-btn px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200 transition">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
            
            // --- EDIT MANAGER FUNCTIONS ---
            function openEditManagerModal(managerId) {
                const manager = appState.managers.find(m => m.id === managerId);
                if (!manager) return;
                
                const modal = document.getElementById('edit-manager-modal');
                modal.dataset.managerId = managerId;
                
                // Populate form with current values
                document.getElementById('edit-manager-name').value = manager.name || '';
                document.getElementById('edit-manager-birthday').value = manager.birthday || '';
                document.getElementById('edit-manager-hire-date').value = manager.hireDate || '';
                document.getElementById('edit-manager-position').value = manager.position || 'SL';
                
                modal.classList.remove('hidden');
            }
            
            async function saveEditManager() {
                const modal = document.getElementById('edit-manager-modal');
                const managerId = modal.dataset.managerId;
                
                const name = document.getElementById('edit-manager-name').value.trim();
                if (!name) {
                    return showToast('Manager name is required', 'error');
                }
                
                const updateData = {
                    name: name,
                    birthday: document.getElementById('edit-manager-birthday').value || null,
                    hireDate: document.getElementById('edit-manager-hire-date').value || null,
                    position: document.getElementById('edit-manager-position').value || 'SL'
                };
                
                try {
                    await db.collection('managers').doc(managerId).update(updateData);
                    showToast('Manager updated successfully!', 'success');
                    modal.classList.add('hidden');
                    loadInitialData();
                } catch (error) {
                    console.error(error);
                    showToast('Error updating manager', 'error');
                }
            }
            
            // --- SCHEDULE REQUEST FUNCTIONS ---
            function openScheduleRequestModal() {
                const modal = document.getElementById('schedule-request-modal');
                const managerSelect = document.getElementById('schedule-request-manager');
                const swapSelect = document.getElementById('schedule-request-swap-with');
                
                // Populate manager dropdowns
                managerSelect.innerHTML = appState.managers.map(m => 
                    `<option value="${m.id}" ${m.id === appState.currentUserManagerId ? 'selected' : ''}>${m.name}</option>`
                ).join('');
                
                swapSelect.innerHTML = '<option value="">-- Select Manager --</option>' + appState.managers.map(m => 
                    `<option value="${m.id}">${m.name}</option>`
                ).join('');
                
                // Set default date
                const today = getLocalDateString(new Date());
                document.getElementById('schedule-request-date').value = today;
                document.getElementById('schedule-request-end-date').value = '';
                document.getElementById('schedule-request-type').value = '';
                document.getElementById('schedule-request-reason').value = '';
                document.getElementById('schedule-request-time').value = '';
                
                // Hide conditional fields
                document.getElementById('schedule-request-swap-container').classList.add('hidden');
                document.getElementById('schedule-request-time-container').classList.add('hidden');
                
                modal.classList.remove('hidden');
            }
            
            function handleScheduleRequestTypeChange() {
                const type = document.getElementById('schedule-request-type').value;
                const swapContainer = document.getElementById('schedule-request-swap-container');
                const timeContainer = document.getElementById('schedule-request-time-container');
                const endDateContainer = document.getElementById('schedule-request-end-date-container');
                
                // Reset visibility
                swapContainer.classList.add('hidden');
                timeContainer.classList.add('hidden');
                endDateContainer.style.display = 'block';
                
                switch(type) {
                    case 'swap-shift':
                        swapContainer.classList.remove('hidden');
                        endDateContainer.style.display = 'none';
                        break;
                    case 'change-time':
                        timeContainer.classList.remove('hidden');
                        endDateContainer.style.display = 'none';
                        break;
                    case 'pull-out':
                    case 'rest-day':
                        endDateContainer.style.display = 'none';
                        break;
                }
            }
            
            async function submitScheduleRequest() {
                const requestType = document.getElementById('schedule-request-type').value;
                const managerId = document.getElementById('schedule-request-manager').value;
                const requestDate = document.getElementById('schedule-request-date').value;
                const endDate = document.getElementById('schedule-request-end-date').value;
                const reason = document.getElementById('schedule-request-reason').value;
                
                if (!requestType) {
                    return showToast('Please select a request type', 'error');
                }
                if (!managerId || !requestDate) {
                    return showToast('Please fill all required fields', 'error');
                }
                
                const manager = appState.managers.find(m => m.id === managerId);
                
                // Get request type label
                const typeLabels = {
                    'rest-day': 'Rest Day (OFF)',
                    'pull-out': 'Pull-out',
                    'swap-shift': 'Shift Swap',
                    'others': 'Other Request'
                };
                
                const requestData = {
                    type: requestType,
                    typeLabel: typeLabels[requestType] || requestType,
                    managerId,
                    managerName: manager?.name,
                    requestDate,
                    endDate: endDate || requestDate,
                    reason,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: appState.currentUserEmail
                };
                
                // Add extra fields based on type
                if (requestType === 'swap-shift') {
                    const swapWithId = document.getElementById('schedule-request-swap-with').value;
                    const swapWithManager = appState.managers.find(m => m.id === swapWithId);
                    requestData.swapWithId = swapWithId;
                    requestData.swapWithName = swapWithManager?.name;
                }
                if (requestType === 'change-time') {
                    requestData.preferredTime = document.getElementById('schedule-request-time').value;
                }
                
                try {
                    await db.collection('schedule_requests').add(requestData);
                    showToast('Request submitted successfully!', 'success');
                    document.getElementById('schedule-request-modal').classList.add('hidden');
                    loadInitialData();
                } catch (error) {
                    console.error(error);
                    showToast('Error submitting request', 'error');
                }
            }
            
            function renderScheduleRequests() {
                const pendingContainer = document.getElementById('pending-requests-container');
                const myContainer = document.getElementById('my-requests-container');
                const pendingSection = document.getElementById('pending-requests-section');
                
                if (!pendingContainer || !myContainer) return;
                
                // Show pending section only for admins
                if (pendingSection) {
                    pendingSection.style.display = appState.accessLevel === 1 ? 'block' : 'none';
                }
                
                // Filter requests
                const pendingRequests = appState.leaveRequests.filter(r => r.status === 'pending');
                const myRequests = appState.leaveRequests.filter(r => 
                    r.managerId === appState.currentUserManagerId || 
                    r.createdBy === appState.currentUserEmail
                );
                
                // Render pending requests (admin view)
                if (pendingRequests.length === 0) {
                    pendingContainer.innerHTML = '<p class="text-gray-500 text-center py-4 bg-gray-50 rounded-lg">No pending requests</p>';
                } else {
                    pendingContainer.innerHTML = pendingRequests.map(req => `
                        <div class="bg-yellow-50 border border-yellow-300 p-4 rounded-xl">
                            <div class="flex flex-col sm:flex-row justify-between items-start gap-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-2 py-0.5 bg-yellow-200 text-yellow-800 rounded text-xs font-semibold">${req.typeLabel || req.leaveType || 'Request'}</span>
                                        <span class="text-xs text-gray-500">${req.requestDate || req.startDate}</span>
                                    </div>
                                    <p class="font-bold text-gray-800">${req.managerName}</p>
                                    ${req.reason ? `<p class="text-sm text-gray-600 mt-1">"${req.reason}"</p>` : ''}
                                    ${req.swapWithName ? `<p class="text-sm text-gray-500">Swap with: ${req.swapWithName}</p>` : ''}
                                    ${req.preferredTime ? `<p class="text-sm text-gray-500">Preferred: ${req.preferredTime}</p>` : ''}
                                </div>
                                <div class="flex gap-2 w-full sm:w-auto">
                                    <button onclick="approveScheduleRequest('${req.id}')" class="flex-1 sm:flex-none px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold hover:bg-green-600 transition">
                                        ‚úì Approve
                                    </button>
                                    <button onclick="rejectScheduleRequest('${req.id}')" class="flex-1 sm:flex-none px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition">
                                        ‚úó Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Render my requests
                if (myRequests.length === 0) {
                    myContainer.innerHTML = '<p class="text-gray-500 text-center py-4 bg-gray-50 rounded-lg">You haven\'t made any requests yet</p>';
                } else {
                    myContainer.innerHTML = myRequests.map(req => {
                        const statusColors = {
                            'pending': 'bg-yellow-100 text-yellow-800',
                            'approved': 'bg-green-100 text-green-800',
                            'rejected': 'bg-red-100 text-red-800'
                        };
                        const statusIcons = {
                            'pending': '‚è≥',
                            'approved': '‚úÖ',
                            'rejected': '‚ùå'
                        };
                        return `
                            <div class="bg-white border border-gray-200 p-4 rounded-xl">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-2 py-0.5 bg-gray-200 text-gray-700 rounded text-xs font-semibold">${req.typeLabel || req.leaveType || 'Request'}</span>
                                            <span class="px-2 py-0.5 ${statusColors[req.status]} rounded text-xs font-semibold">${statusIcons[req.status]} ${req.status}</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${req.requestDate || req.startDate}${req.endDate && req.endDate !== req.requestDate ? ' ‚Üí ' + req.endDate : ''}</p>
                                        ${req.reason ? `<p class="text-xs text-gray-500 mt-1">"${req.reason}"</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            window.approveScheduleRequest = async function(requestId) {
                const request = appState.leaveRequests.find(r => r.id === requestId);
                if (!request) return;
                
                try {
                    // Update request status
                    await db.collection('schedule_requests').doc(requestId).update({
                        status: 'approved',
                        approvedBy: appState.currentUserEmail,
                        approvedDate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Auto-populate the weekly schedule based on request type
                    const requestDate = request.requestDate || request.startDate;
                    const endDate = request.endDate || requestDate;
                    const weekDates = getWeekDateStrings(new Date(requestDate + 'T00:00:00'));
                    const weekKey = weekDates[0];
                    
                    // Get current schedule for the week
                    const scheduleDoc = await db.collection("manager_schedules").doc(weekKey).get();
                    let scheduleData = scheduleDoc.exists ? scheduleDoc.data() : {};
                    
                    // Update schedule based on request type
                    const start = new Date(requestDate + 'T00:00:00');
                    const end = new Date(endDate + 'T00:00:00');
                    
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        const dateStr = getLocalDateString(d);
                        const scheduleKey = `${request.managerId}_${dateStr}`;
                        
                        switch(request.type || request.leaveType) {
                            case 'rest-day':
                                scheduleData[scheduleKey] = { shift: 'OFF', time: '' };
                                break;
                            case 'vl':
                            case 'VL':
                                scheduleData[scheduleKey] = { shift: 'VL', time: '' };
                                break;
                            case 'sl':
                            case 'SL':
                                scheduleData[scheduleKey] = { shift: 'SL', time: '' };
                                break;
                            case 'pull-out':
                                // For pull-out, just update the note
                                if (scheduleData[scheduleKey]) {
                                    scheduleData[scheduleKey].time = (scheduleData[scheduleKey].time || '') + ' (Pull-out)';
                                }
                                break;
                            case 'change-time':
                                if (scheduleData[scheduleKey]) {
                                    scheduleData[scheduleKey].time = request.preferredTime || scheduleData[scheduleKey].time;
                                }
                                break;
                        }
                    }
                    
                    // Save updated schedule
                    await db.collection("manager_schedules").doc(weekKey).set(scheduleData, { merge: true });
                    
                    showToast('Request approved and schedule updated!', 'success');
                    loadInitialData();
                } catch (error) {
                    console.error(error);
                    showToast('Error approving request', 'error');
                }
            };
            
            window.rejectScheduleRequest = async function(requestId) {
                try {
                    await db.collection('schedule_requests').doc(requestId).update({
                        status: 'rejected',
                        rejectedBy: appState.currentUserEmail,
                        rejectedDate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Request rejected', 'success');
                    loadInitialData();
                } catch (error) {
                    console.error(error);
                    showToast('Error rejecting request', 'error');
                }
            };

            async function loadScheduleForWeek(week) {
                const weekKey = week[0];
                try {
                    const doc = await db.collection("manager_schedules").doc(weekKey).get();
                    appState.managerSchedules = doc.exists ? doc.data() : {};
                } catch (error) {
                    console.error("Error loading schedule:", error);
                    showToast("Could not load schedule data.", "error");
                }
                renderWeeklySchedule();
                renderShiftSchedule();
            }

            function renderMySchedule() {
                const container = document.getElementById('my-schedule-container');
                const nameEl = document.getElementById('my-schedule-name');
                const avatarEl = document.getElementById('my-schedule-avatar');
                const weekPicker = document.getElementById('my-schedule-week-picker');
                const profileSelector = document.getElementById('my-schedule-profile-selector');
                const managerSelect = document.getElementById('my-schedule-manager-select');
                
                if (!container) return;
                
                // Set the week picker to current week if not set
                if (!weekPicker.value) {
                    weekPicker.value = getLocalDateString(new Date());
                }
                
                const selectedDate = new Date(weekPicker.value + 'T00:00:00');
                const weekDates = getWeekDateStrings(selectedDate);
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const daysShort = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                
                // Check if user is linked to a manager - try localStorage first
                if (!appState.currentUserManagerId) {
                    const savedManagerId = localStorage.getItem('myScheduleManagerId');
                    if (savedManagerId) {
                        const savedManager = appState.managers.find(m => m.id === savedManagerId);
                        if (savedManager) {
                            appState.currentUserManagerId = savedManagerId;
                            appState.currentUserManagerName = savedManager.name;
                        }
                    }
                }
                
                // If still not linked, try email match
                if (!appState.currentUserManagerId) {
                    const emailUsername = (appState.currentUserEmail || '').split('@')[0].toLowerCase();
                    const matchedManager = appState.managers.find(m => 
                        m.name.toLowerCase().replace(/\s+/g, '') === emailUsername ||
                        m.name.toLowerCase().split(' ')[0] === emailUsername ||
                        m.name.toLowerCase() === emailUsername
                    );
                    if (matchedManager) {
                        appState.currentUserManagerId = matchedManager.id;
                        appState.currentUserManagerName = matchedManager.name;
                    }
                }
                
                // Populate the manager selector dropdown
                if (managerSelect) {
                    managerSelect.innerHTML = '<option value="">-- Select Your Profile --</option>' + 
                        appState.managers.map(m => 
                            `<option value="${m.id}" ${m.id === appState.currentUserManagerId ? 'selected' : ''}>${m.name}</option>`
                        ).join('');
                }
                
                // Show/hide profile selector based on whether manager is linked
                if (!appState.currentUserManagerId && profileSelector) {
                    profileSelector.classList.remove('hidden');
                } else if (profileSelector) {
                    profileSelector.classList.add('hidden');
                }
                
                // Update header with manager name
                if (appState.currentUserManagerName) {
                    nameEl.textContent = appState.currentUserManagerName + "'s Schedule";
                    avatarEl.textContent = appState.currentUserManagerName.charAt(0).toUpperCase();
                } else {
                    nameEl.textContent = "My Schedule";
                    avatarEl.textContent = "M";
                }
                
                // If no manager linked, show message
                if (!appState.currentUserManagerId) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-8 bg-gray-50 rounded-xl">
                            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-500 mb-2">Select Your Profile Above</h3>
                            <p class="text-gray-400 text-sm max-w-md mx-auto">Choose your manager profile from the dropdown above to view your weekly schedule.</p>
                        </div>
                    `;
                    // Reset summary
                    document.getElementById('my-schedule-total-days').textContent = '0';
                    document.getElementById('my-schedule-off-days').textContent = '0';
                    document.getElementById('my-schedule-leave-days').textContent = '0';
                    document.getElementById('my-schedule-gy-days').textContent = '0';
                    return;
                }
                
                // Build schedule cards
                let html = '';
                let workingDays = 0;
                let offDays = 0;
                let leaveDays = 0;
                let gyDays = 0;
                
                weekDates.forEach((date, i) => {
                    const scheduleKey = `${appState.currentUserManagerId}_${date}`;
                    let scheduleData = appState.managerSchedules[scheduleKey] || { shift: '', time: '' };
                    let isPlanned = false;
                    
                    // Check for planned leaves
                    if (!scheduleData.shift) {
                        const plannedLeave = appState.plottedLeaves.find(leave => {
                            const leaveStart = createUTCDate(leave.startDate);
                            const leaveEnd = createUTCDate(leave.endDate);
                            const currentDate = createUTCDate(date);
                            return leave.managerId === appState.currentUserManagerId && currentDate >= leaveStart && currentDate <= leaveEnd;
                        });
                        
                        if (plannedLeave) {
                            scheduleData = { shift: plannedLeave.leaveType, time: 'Planned' };
                            isPlanned = true;
                        }
                    }
                    
                    // Count days for summary
                    if (scheduleData.shift) {
                        if (scheduleData.shift === 'OFF') {
                            offDays++;
                        } else if (['VL', 'HL', 'SL', 'Leave'].includes(scheduleData.shift)) {
                            leaveDays++;
                        } else if (scheduleData.shift === 'GY') {
                            gyDays++;
                            workingDays++;
                        } else {
                            workingDays++;
                        }
                    }
                    
                    // Determine card styling based on shift
                    let cardBg = 'bg-gray-50';
                    let shiftColor = 'text-gray-600';
                    let borderColor = 'border-gray-200';
                    let icon = '';
                    
                    if (scheduleData.shift) {
                        switch(scheduleData.shift) {
                            case 'Opening':
                            case 'Open SM':
                            case 'Open SL':
                                cardBg = 'bg-yellow-50';
                                shiftColor = 'text-yellow-700';
                                borderColor = 'border-yellow-300';
                                icon = 'üåÖ';
                                break;
                            case 'Mid':
                            case 'Mid SM':
                                cardBg = 'bg-blue-50';
                                shiftColor = 'text-blue-700';
                                borderColor = 'border-blue-300';
                                icon = '‚òÄÔ∏è';
                                break;
                            case 'Closing':
                            case 'Close SM':
                            case 'Close SL':
                                cardBg = 'bg-purple-50';
                                shiftColor = 'text-purple-700';
                                borderColor = 'border-purple-300';
                                icon = 'üåô';
                                break;
                            case 'GY':
                                cardBg = 'bg-gray-700';
                                shiftColor = 'text-white';
                                borderColor = 'border-gray-600';
                                icon = 'üåÉ';
                                break;
                            case 'OFF':
                                cardBg = 'bg-red-50';
                                shiftColor = 'text-red-600';
                                borderColor = 'border-red-300';
                                icon = 'üè†';
                                break;
                            case 'VL':
                                cardBg = 'bg-blue-100';
                                shiftColor = 'text-blue-700';
                                borderColor = 'border-blue-400';
                                icon = 'üèñÔ∏è';
                                break;
                            case 'HL':
                                cardBg = 'bg-green-100';
                                shiftColor = 'text-green-700';
                                borderColor = 'border-green-400';
                                icon = 'üéâ';
                                break;
                            case 'SL':
                                cardBg = 'bg-orange-100';
                                shiftColor = 'text-orange-700';
                                borderColor = 'border-orange-400';
                                icon = 'üè•';
                                break;
                        }
                    }
                    
                    const dateObj = new Date(date + 'T00:00:00');
                    const isToday = getLocalDateString(new Date()) === date;
                    const todayBorder = isToday ? 'ring-2 ring-[#DA291C] ring-offset-2' : '';
                    const plannedStyle = isPlanned ? 'opacity-70' : '';
                    
                    html += `
                        <div class="relative ${cardBg} ${plannedStyle} rounded-xl p-4 border-2 ${borderColor} ${todayBorder} transition-all hover:shadow-md">
                            ${isToday ? '<span class="absolute -top-2 -right-2 bg-[#DA291C] text-white text-xs px-2 py-0.5 rounded-full font-semibold">Today</span>' : ''}
                            <div class="text-center">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">${daysShort[i]}</p>
                                <p class="text-2xl font-bold ${scheduleData.shift === 'GY' ? 'text-white' : 'text-gray-800'}">${dateObj.getDate()}</p>
                                <p class="text-xs text-gray-400">${dateObj.toLocaleDateString('en-US', { month: 'short' })}</p>
                            </div>
                            <div class="mt-3 text-center">
                                ${scheduleData.shift ? `
                                    <p class="text-2xl mb-1">${icon}</p>
                                    <p class="font-bold ${shiftColor}">${scheduleData.shift}</p>
                                    ${scheduleData.time && scheduleData.time !== 'Planned' ? `<p class="text-xs ${scheduleData.shift === 'GY' ? 'text-gray-300' : 'text-gray-500'} mt-1">${scheduleData.time}</p>` : ''}
                                    ${isPlanned ? `<p class="text-xs italic text-gray-400 mt-1">(Planned)</p>` : ''}
                                ` : `
                                    <p class="text-gray-400 text-sm mt-2">No schedule</p>
                                `}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Update summary
                document.getElementById('my-schedule-total-days').textContent = workingDays;
                document.getElementById('my-schedule-off-days').textContent = offDays;
                document.getElementById('my-schedule-leave-days').textContent = leaveDays;
                document.getElementById('my-schedule-gy-days').textContent = gyDays;
            }

            function renderWeeklySchedule() {
                const table = document.getElementById('weekly-schedule-table');
                const mobileContainer = document.getElementById('weekly-schedule-mobile');
                if (!table || !mobileContainer) return;

                const weekPicker = document.getElementById('week-picker');
                const selectedDate = new Date(weekPicker.value + 'T00:00:00');
                const weekDates = getWeekDateStrings(selectedDate);

                let thead = '<thead><tr><th class="w-48">Manager</th>';
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                weekDates.forEach((date, i) => {
                    thead += `<th>${days[i]}<br><span class="font-normal text-sm">${date.split('-')[2]}</span></th>`;
                });
                thead += '</tr></thead>';

                let tbody = '<tbody>';
                if (appState.managers.length === 0) {
                    tbody += '<tr><td colspan="8" class="text-center text-gray-500 py-4">Please add managers first.</td></tr>';
                } else {
                    appState.managers.forEach(manager => {
                        tbody += `<tr><td class="font-semibold px-2 text-left">${manager.name}</td>`;
                        weekDates.forEach(date => {
                            const scheduleKey = `${manager.id}_${date}`;
                            let scheduleData = appState.managerSchedules[scheduleKey] || { shift: '', time: '' };
                            let isPlanned = false;
                            let cellClass = '';

                            if (!scheduleData.shift) {
                                const plannedLeave = appState.plottedLeaves.find(leave => {
                                    const leaveStart = createUTCDate(leave.startDate);
                                    const leaveEnd = createUTCDate(leave.endDate);
                                    const currentDate = createUTCDate(date);
                                    return leave.managerId === manager.id && currentDate >= leaveStart && currentDate <= leaveEnd;
                                });

                                if (plannedLeave) {
                                    scheduleData = { shift: plannedLeave.leaveType, time: 'Planned' };
                                    isPlanned = true;
                                    cellClass = 'planned-leave-cell';
                                }
                            }

                            let offClass = scheduleData.shift === 'OFF' ? 'text-red-500' : '';
                            let plannedStyle = isPlanned ? 'text-gray-500 italic' : '';
                            let cellContent = scheduleData.shift ? `<div class="text-sm ${plannedStyle}"><p class="font-semibold ${offClass}">${scheduleData.shift}</p><p class="text-xs">${scheduleData.time || ''}</p></div>` : '<span class="text-2xl font-light text-gray-400">+</span>';
                            tbody += `<td class="p-1 ${cellClass}"><div class="schedule-cell" data-manager-id="${manager.id}" data-date="${date}">${cellContent}</div></td>`;
                        });
                        tbody += '</tr>';
                    });
                }
                table.innerHTML = thead + '<tbody>' + tbody + '</tbody>';

                let mobileHTML = '';
                if (appState.managers.length > 0) {
                    weekDates.forEach((date, i) => {
                        const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                        mobileHTML += `<div class="bg-white rounded-lg shadow p-4 mt-4"><h4 class="font-bold text-lg mb-2 border-b pb-2">${days[i]} - ${formattedDate}</h4><div class="space-y-2">`;
                        appState.managers.forEach(manager => {
                            const scheduleKey = `${manager.id}_${date}`;
                            const scheduleData = appState.managerSchedules[scheduleKey] || { shift: '', time: '' };
                            let offClass = scheduleData.shift === 'OFF' ? 'text-red-500' : '';
                            let shiftContent = scheduleData.shift ? `<div class="text-right"><p class="font-semibold ${offClass}">${scheduleData.shift}</p><p class="text-gray-500 text-xs">${scheduleData.time || ''}</p></div>` : '<span class="text-xl font-light text-gray-400">+</span>';
                            mobileHTML += `<div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 schedule-cell" data-manager-id="${manager.id}" data-date="${date}"><p class="font-medium">${manager.name}</p>${shiftContent}</div>`;
                        });
                        mobileHTML += `</div></div>`;
                    });
                }
                mobileContainer.innerHTML = mobileHTML;
            }

            function renderShiftSchedule() {
                const table = document.getElementById('shift-schedule-table');
                const mobileContainer = document.getElementById('shift-schedule-mobile');
                if (!table || !mobileContainer) return;

                const weekPicker = document.getElementById('week-picker');
                const selectedDate = new Date(weekPicker.value + 'T00:00:00');
                const weekDates = getWeekDateStrings(selectedDate);
                
                const shiftCategories = { "Open SL": ["Open SL"], "Open SM": ["Open SM"], "Mid SM": ["Mid SM"], "Close SL": ["Close SL"], "Close SM": ["Close SM"], "GY": ["GY"] };

                let thead = '<thead><tr><th class="w-48">Shift</th>';
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                weekDates.forEach((date, i) => {
                    thead += `<th>${days[i]}<br><span class="font-normal text-sm">${date.split('-')[2]}</span></th>`;
                });
                thead += '</tr></thead>';

                let tbody = '<tbody>';
                for (const category in shiftCategories) {
                    tbody += `<tr><td class="font-semibold px-2 text-left">${category}</td>`;
                    weekDates.forEach(date => {
                        let cellContent = '';
                        appState.managers.forEach(manager => {
                            const scheduleKey = `${manager.id}_${date}`;
                            const scheduleData = appState.managerSchedules[scheduleKey];
                            if (scheduleData && shiftCategories[category].includes(scheduleData.shift)) {
                                cellContent += `<div class="text-xs p-1">${manager.name}</div>`;
                            }
                        });
                        tbody += `<td class="p-1 align-top text-xs">${cellContent || ''}</td>`;
                    });
                    tbody += '</tr>';
                }
                table.innerHTML = thead + '<tbody>' + tbody + '</tbody>';
                
                let mobileHTML = '';
                weekDates.forEach((date, i) => {
                    const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    mobileHTML += `<div class="bg-white rounded-lg shadow p-4 mt-4"><h4 class="font-bold text-lg mb-2 border-b pb-2">${days[i]} - ${formattedDate}</h4><div class="space-y-3">`;
                    for (const category in shiftCategories) {
                        let managerNames = '';
                        appState.managers.forEach(manager => {
                            const scheduleKey = `${manager.id}_${date}`;
                            const scheduleData = appState.managerSchedules[scheduleKey];
                            if (scheduleData && shiftCategories[category].includes(scheduleData.shift)) {
                                managerNames += `<div class="text-sm">${manager.name}</div>`;
                            }
                        });

                        mobileHTML += `<div class="flex justify-between items-start"><p class="font-semibold text-sm w-1/3 text-left">${category}</p><div class="w-2/3 text-right">${managerNames || '<span class="text-gray-400">None</span>'}</div></div>`;
                    }
                    mobileHTML += `</div></div>`;
                });
                mobileContainer.innerHTML = mobileHTML;
            }

            function renderLeaveCalendar() {
                const container = document.getElementById('leave-calendar-container');
                if (!container) return;

                const monthYearEl = document.getElementById('calendar-month-year');
                const currentMonth = appState.calendarDate.getMonth();
                const currentYear = appState.calendarDate.getFullYear();
                
                monthYearEl.textContent = `${appState.calendarDate.toLocaleString('default', { month: 'long' })} ${currentYear}`;

                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const dayOffset = firstDay === 0 ? 6 : firstDay - 1;

                let calendarHTML = '<div class="calendar-header">Mon</div><div class="calendar-header">Tue</div><div class="calendar-header">Wed</div><div class="calendar-header">Thu</div><div class="calendar-header">Fri</div><div class="calendar-header">Sat</div><div class="calendar-header">Sun</div>';

                for (let i = 0; i < dayOffset; i++) {
                    calendarHTML += '<div class="calendar-day other-month"></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = getLocalDateString(new Date(currentYear, currentMonth, day));
                    let leaveEntriesHTML = '';
                    appState.plottedLeaves.forEach(leave => {
                        const leaveStart = new Date(leave.startDate + 'T00:00:00');
                        const leaveEnd = new Date(leave.endDate + 'T00:00:00');
                        const currentDate = new Date(dateStr + 'T00:00:00');

                        if (currentDate >= leaveStart && currentDate <= leaveEnd) {
                            leaveEntriesHTML += `<div class="leave-entry ${leave.leaveType === 'VL' ? 'leave-vl' : 'leave-hl'}" data-leave-id="${leave.id}">${leave.managerName}</div>`;
                        }
                    });

                    calendarHTML += `<div class="calendar-day" data-date="${dateStr}"><div class="day-number">${day}</div><div class="leave-entries">${leaveEntriesHTML}</div></div>`;
                }
                
                container.innerHTML = `<div class="calendar">${calendarHTML}</div>`;
            }

            async function loadPlottedLeavesForMonth() {
                const year = appState.calendarDate.getFullYear();
                try {
                    const snapshot = await db.collection('plotted_leaves').where('year', '==', year).get();
                    appState.plottedLeaves = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    renderLeaveCalendar();
                } catch(error) {
                    console.error("Error fetching leaves:", error);
                    showToast("Could not load leave data.", "error");
                }
            }

            async function loadAndRenderLeaveTracking() {
                const container = document.getElementById('leave-records-container');
                if (!container) return;
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Loading leave records...</p>';
                
                try {
                    const plottedLeavesSnapshot = await db.collection('plotted_leaves').get();
                    const allPlottedLeaves = plottedLeavesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    const scheduleSnapshots = await db.collection('manager_schedules').get();
                    const allSchedules = scheduleSnapshots.docs.reduce((acc, doc) => {
                        return { ...acc, ...doc.data() };
                    }, {});

                    const leaveSummary = {};

                    allPlottedLeaves.forEach(leave => {
                        const start = createUTCDate(leave.startDate);
                        const end = createUTCDate(leave.endDate);

                        for (let d = new Date(start); d <= end; d.setUTCDate(d.getUTCDate() + 1)) {
                            const dateStr = getLocalDateString(d);
                            const scheduleKey = `${leave.managerId}_${dateStr}`;
                            
                            if (allSchedules[scheduleKey] && (allSchedules[scheduleKey].shift === leave.leaveType || allSchedules[scheduleKey].shift === 'SL')) {
                                const leaveType = allSchedules[scheduleKey].shift;
                                if (!leaveSummary[leave.managerName]) {
                                    leaveSummary[leave.managerName] = { VL: 0, HL: 0, SL: 0 };
                                }
                                if (!leaveSummary[leave.managerName][leaveType]) {
                                    leaveSummary[leave.managerName][leaveType] = 0;
                                }
                                leaveSummary[leave.managerName][leaveType]++;
                            }
                        }
                    });

                    if (Object.keys(leaveSummary).length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">No consumed leave records found.</p>';
                        return;
                    }

                    let content = '';
                    const sortedManagerNames = Object.keys(leaveSummary).sort();

                    for (const managerName of sortedManagerNames) {
                        const leaves = leaveSummary[managerName];
                        const VL = leaves.VL || 0;
                        const HL = leaves.HL || 0;
                        const SL = leaves.SL || 0;
                        content += `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-lg">${managerName}</h4>
                                <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                                    <div><p class="text-2xl font-bold text-blue-600">${VL}</p><p class="text-sm text-gray-500">VL</p></div>
                                    <div><p class="text-2xl font-bold text-green-600">${HL}</p><p class="text-sm text-gray-500">HL</p></div>
                                    <div><p class="text-2xl font-bold text-yellow-500">${SL}</p><p class="text-sm text-gray-500">SL</p></div>
                                    <div><p class="text-2xl font-bold text-gray-800">${VL + HL + SL}</p><p class="text-sm text-gray-500">Total</p></div>
                                </div>
                            </div>
                        `;
                    }
                    container.innerHTML = content;

                } catch (error) {
                    console.error("Error loading leave records:", error);
                    container.innerHTML = '<p class="text-red-500 text-center py-4">Could not load leave records.</p>';
                }
            }

            async function renderGyOtTracking() {
                const container = document.getElementById('gy-ot-records-container');
                const monthYearEl = document.getElementById('gy-ot-month-year');
                if (!container || !monthYearEl) return;

                const cutoffSelect = document.getElementById('gy-ot-cutoff-select');
                const selectedCutoff = cutoffSelect ? cutoffSelect.value : 'all';

                monthYearEl.textContent = appState.calendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Loading records...</p>';

                try {
                    const scheduleSnapshots = await db.collection('manager_schedules').get();
                    const allSchedules = scheduleSnapshots.docs.reduce((acc, doc) => ({ ...acc, ...doc.data() }), {});

                    const summary = {};
                    appState.managers.forEach(m => {
                        summary[m.name] = {
                            cutoff1: { GY: 0, OT: 0 },
                            cutoff2: { GY: 0, OT: 0 }
                        };
                    });

                    const year = appState.calendarDate.getFullYear();
                    const month = appState.calendarDate.getMonth();

                    for (const key in allSchedules) {
                        const [managerId, dateStr] = key.split('_');
                        const scheduleDate = new Date(dateStr + 'T00:00:00');
                        
                        if (scheduleDate.getFullYear() === year && scheduleDate.getMonth() === month) {
                            const manager = appState.managers.find(m => m.id === managerId);
                            if (manager) {
                                const day = scheduleDate.getDate();
                                const cutoff = day <= 15 ? 'cutoff1' : 'cutoff2';
                                const shift = allSchedules[key].shift;

                                if (shift === 'GY' || shift === 'OT') {
                                    summary[manager.name][cutoff][shift]++;
                                }
                            }
                        }
                    }

                    
                    const managersWithShifts = Object.keys(summary).filter(name => {
                        const data = summary[name];
                        const hasCutoff1Data = data.cutoff1.GY > 0 || data.cutoff1.OT > 0;
                        const hasCutoff2Data = data.cutoff2.GY > 0 || data.cutoff2.OT > 0;

                        if (selectedCutoff === '1-15') return hasCutoff1Data;
                        if (selectedCutoff === '16-31') return hasCutoff2Data;
                        return hasCutoff1Data || hasCutoff2Data; // 'all' case
                    }).sort();

                    if (managersWithShifts.length === 0) {
                        container.innerHTML = `<p class="text-gray-500 text-center py-4">No managers with GY or OT shifts for this period.</p>`;
                        return;
                    }

                    let tableHTML = `
                        <div class="overflow-x-auto bg-white rounded-lg shadow border">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manager</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cut-off</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">GY</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">OT</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                    `;

                    managersWithShifts.forEach(name => {
                        const data = summary[name];
                        const hasCutoff1Data = data.cutoff1.GY > 0 || data.cutoff1.OT > 0;
                        const hasCutoff2Data = data.cutoff2.GY > 0 || data.cutoff2.OT > 0;

                        if ((selectedCutoff === '1-15' || selectedCutoff === 'all') && hasCutoff1Data) {
                            tableHTML += `
                                <tr class="divide-x divide-gray-200">
                                    <td class="px-4 py-4 whitespace-nowrap font-medium text-gray-900">${name}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">1-15</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-lg font-bold text-gray-900 text-center">${data.cutoff1.GY}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-lg font-bold text-gray-900 text-center">${data.cutoff1.OT}</td>
                                </tr>
                            `;
                        }
                        if ((selectedCutoff === '16-31' || selectedCutoff === 'all') && hasCutoff2Data) {
                            tableHTML += `
                                <tr class="divide-x divide-gray-200">
                                    <td class="px-4 py-4 whitespace-nowrap font-medium text-gray-900">${name}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">16-31</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-lg font-bold text-gray-900 text-center">${data.cutoff2.GY}</td>
                                    <td class="px-4 py-4 whitespace-nowrap text-lg font-bold text-gray-900 text-center">${data.cutoff2.OT}</td>
                                </tr>
                            `;
                        }
                    });

                    tableHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML = tableHTML;

                } catch (error) {
                    console.error("Error loading GY/OT records:", error);
                    container.innerHTML = '<p class="text-red-500 text-center py-4">Could not load records.</p>';
                }
            }
            
            function renderActivities() {
                const tabsContainer = document.getElementById('activity-tabs-container');
                const contentContainer = document.getElementById('activity-content-container');
                const yearSelect = document.getElementById('activity-year');
                if(!tabsContainer || !contentContainer || !yearSelect) return;

                tabsContainer.innerHTML = '';
                contentContainer.innerHTML = '';
                const selectedYear = parseInt(yearSelect.value);

                if (!appState.activitiesData || appState.activitiesData.length === 0) {
                    contentContainer.innerHTML = `<p class="text-gray-500 text-center py-4">No future activities found.</p>`;
                    return;
                }
                
                const yearActivities = appState.activitiesData.filter(d => d.date.toDate().getFullYear() === selectedYear);
                if (yearActivities.length === 0) {
                    contentContainer.innerHTML = `<p class="text-gray-500 text-center py-4">No activities found for ${selectedYear}.</p>`;
                    return;
                }

                const activitiesByMonth = yearActivities.reduce((acc, activity) => {
                    const month = activity.date.toDate().toLocaleString('default', { month: 'long' });
                    const monthKey = `${activity.date.toDate().getMonth()}_${month}`;
                    if (!acc[monthKey]) acc[monthKey] = [];
                    acc[monthKey].push(activity);
                    return acc;
                }, {});
                
                const sortedMonthKeys = Object.keys(activitiesByMonth).sort((a, b) => parseInt(a.split('_')[0]) - parseInt(b.split('_')[0]));

                sortedMonthKeys.forEach((monthKey, index) => {
                    const tab = document.createElement('button');
                    tab.textContent = monthKey.split('_')[1];
                    tab.className = `month-tab px-4 py-2 font-semibold border-b-2 transition-colors duration-300 ${index === 0 ? 'active' : 'border-transparent'}`;
                    tab.dataset.month = monthKey;
                    tabsContainer.appendChild(tab);
                });

                function displayMonth(monthKey) {
                    contentContainer.innerHTML = '';
                    if (!activitiesByMonth[monthKey]) return;
                    const monthActivities = activitiesByMonth[monthKey];
                    
                    const totalSales = monthActivities.reduce((sum, act) => sum + (act.potential_sales || 0), 0);
                    const unconfirmed = monthActivities.filter(act => act.remarks !== 'Confirmed').length;

                    contentContainer.innerHTML = `
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="stat-card text-center"><h3 class="text-lg font-semibold text-gray-500">Total Expected Sales</h3><p class="text-3xl font-bold text-green-600 mt-2">‚Ç±${totalSales.toLocaleString()}</p></div>
                            <div class="stat-card text-center"><h3 class="text-lg font-semibold text-gray-500">Unconfirmed Activities</h3><p class="text-3xl font-bold text-yellow-600 mt-2">${unconfirmed}</p></div>
                        </div>
                    `;
                    
                    const listContainer = document.createElement('div');
                    listContainer.className = 'space-y-4';
                    monthActivities.forEach(activity => listContainer.appendChild(createActivityCard(activity)));
                    contentContainer.appendChild(listContainer);
                }

                tabsContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('month-tab')) {
                        tabsContainer.querySelector('.active')?.classList.remove('active');
                        e.target.classList.add('active');
                        displayMonth(e.target.dataset.month);
                    }
                });

                if (sortedMonthKeys.length > 0) {
                    displayMonth(sortedMonthKeys[0]);
                }
            }

            function createActivityCard(activity) {
                const date = activity.date.toDate();
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border';
                card.innerHTML = `
                    <div id="view-activity-${activity.id}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-lg">${activity.activity_name}</p>
                                <p class="text-gray-600">${date.toLocaleDateString('en-US', { dateStyle: 'full' })} at ${activity.activity_time || 'N/A'}</p>
                            </div>
                            <div>
                                <button data-id="${activity.id}" class="edit-activity-btn text-blue-500 hover:text-blue-700 font-semibold mr-4">Edit</button>
                                <button data-id="${activity.id}" class="delete-activity-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                            <p><strong>Venue:</strong> ${activity.event_venue || 'N/A'}</p>
                            <p><strong>Customer:</strong> ${activity.customer_name || 'N/A'}</p>
                            <p><strong>Contact:</strong> ${activity.contact_number || 'N/A'}</p>
                            <p><strong>Est. Sales:</strong> ‚Ç±${(activity.potential_sales || 0).toLocaleString()}</p>
                            <p><strong>Status:</strong> ${activity.remarks || 'N/A'}</p>
                            <p><strong>Follow-up:</strong> ${activity.for_follow_up || 'N/A'}</p>
                            <p><strong>Handled by:</strong> ${activity.handled_by || 'N/A'}</p>
                            <p><strong>Character:</strong> ${activity.character || 'N/A'}</p>
                        </div>
                    </div>
                    <form id="edit-form-activity-${activity.id}" class="hidden space-y-2 mt-4">
                        <!-- Edit form fields will be added here by the edit handler -->
                    </form>
                `;
                return card;
            }

            function setupActivityFilters() {
                const yearSelect = document.getElementById('activity-year');
                if(!yearSelect || !appState.activitiesData) return;
                
                const years = [...new Set(appState.activitiesData.map(d => d.date.toDate().getFullYear()))].sort((a,b) => b - a);
                const currentYear = new Date().getFullYear();
                if (!years.includes(currentYear)) years.unshift(currentYear);
                
                yearSelect.innerHTML = years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
                yearSelect.addEventListener('change', renderActivities);
            }

            function renderHistorical(year, month) {
                const container = document.getElementById('historical-list');
                if(!container) return;
                container.innerHTML = '';
                if (!appState.historicalData) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">No historical data found.</p>`;
                    return;
                }

                let filteredData = appState.historicalData;
                if (year) filteredData = filteredData.filter(d => d.date.toDate().getFullYear() === year);
                if (month !== null && month !== undefined && month !== '') filteredData = filteredData.filter(d => d.date.toDate().getMonth() === month);

                 filteredData.forEach(record => container.appendChild(createHistoricalCard(record)));
            }

            function createHistoricalCard(record) {
                const date = record.date.toDate();
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border';
                card.innerHTML = `
                    <div id="view-hist-${record.id}">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-lg">${date.toLocaleDateString('en-US', { dateStyle: 'full' })}</p>
                            <div>
                                <button data-id="${record.id}" class="edit-historical-btn text-blue-500 hover:text-blue-700 font-semibold mr-4">Edit</button>
                                <button data-id="${record.id}" class="delete-historical-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                            <p><strong>Sales:</strong> ‚Ç±${record.sales.toLocaleString()}</p>
                            <p><strong>Customers:</strong> ${record.customers}</p>
                            <p><strong>Add-on:</strong> ‚Ç±${(record.add_on_sales || 0).toLocaleString()}</p>
                            <p><strong>Weather:</strong> ${record.weather || 'N/A'}</p>
                        </div>
                    </div>
                    <form id="edit-form-hist-${record.id}" class="hidden space-y-2 mt-4">
                        <div class="grid grid-cols-2 gap-4">
                             <input type="number" step="0.01" value="${record.sales}" class="w-full p-2 border rounded" placeholder="Sales">
                             <input type="number" value="${record.customers}" class="w-full p-2 border rounded" placeholder="Customers">
                             <input type="number" step="0.01" value="${record.add_on_sales || 0}" class="w-full p-2 border rounded" placeholder="Add-on Sales">
                             <select class="w-full p-2 border rounded">
                                <option ${record.weather === 'Sunny' ? 'selected' : ''}>Sunny</option>
                                <option ${record.weather === 'Cloudy' ? 'selected' : ''}>Cloudy</option>
                                <option ${record.weather === 'Rainy' ? 'selected' : ''}>Rainy</option>
                                <option ${record.weather === 'Storm' ? 'selected' : ''}>Storm</option>
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" data-id="${record.id}" class="update-historical-btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                            <button type="button" data-id="${record.id}" class="cancel-edit-hist-btn w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                        </div>
                    </form>
                `;
                return card;
            }

            function setupHistoricalFilters() {
                const yearSelect = document.getElementById('hist-year');
                const monthSelect = document.getElementById('hist-month');
                if(!yearSelect || !monthSelect || !appState.historicalData) return;
                
                const years = [...new Set(appState.historicalData.map(d => d.date.toDate().getFullYear()))].sort((a,b) => b - a);
                yearSelect.innerHTML = '<option value="">All Years</option>';
                years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                monthSelect.innerHTML = '<option value="">All Months</option>';
                monthNames.forEach((m, i) => monthSelect.innerHTML += `<option value="${i}">${m}</option>`);
                
                const updateFilter = () => {
                    const year = yearSelect.value ? parseInt(yearSelect.value) : null;
                    const month = monthSelect.value !== "" ? parseInt(monthSelect.value) : null;
                    renderHistorical(year, month);
                };

                yearSelect.addEventListener('change', updateFilter);
                monthSelect.addEventListener('change', updateFilter);
            }

            function renderAdmin() {
                const container = document.getElementById('user-list');
                if(!container) return;
                container.innerHTML = '';
                 if (!appState.usersData || appState.usersData.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">No users found.</p>`;
                    return;
                }

                appState.usersData.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 p-4 rounded-lg border flex justify-between items-center';
                    card.innerHTML = `
                        <div><p class="font-bold text-lg">${user.username}</p></div>
                        <div class="flex items-center space-x-4">
                            <select data-id="${user.id}" class="user-access-level-select w-full p-2 border rounded">
                                <option value="1" ${user.access_level === 1 ? 'selected' : ''}>Admin</option>
                                <option value="2" ${user.access_level === 2 ? 'selected' : ''}>Manager</option>
                                <option value="3" ${user.access_level === 3 ? 'selected' : ''}>Viewer</option>
                            </select>
                            <button data-id="${user.id}" class="delete-user-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // --- EVENT LISTENERS ---
            function setupAllEventListeners() {
                UI.navButtons.forEach(button => button.addEventListener('click', () => {
                    appState.currentView = button.dataset.view;
                    updateView();
                    // Close more menu popup if open
                    document.getElementById('more-menu-popup')?.classList.add('hidden');
                }));
                UI.logoutBtn.addEventListener('click', () => auth.signOut());

                // More menu popup handlers
                document.getElementById('more-menu-trigger')?.addEventListener('click', () => {
                    document.getElementById('more-menu-popup')?.classList.remove('hidden');
                });
                document.getElementById('close-more-menu')?.addEventListener('click', () => {
                    document.getElementById('more-menu-popup')?.classList.add('hidden');
                });
                document.getElementById('more-menu-popup')?.addEventListener('click', (e) => {
                    if (e.target.id === 'more-menu-popup') {
                        document.getElementById('more-menu-popup')?.classList.add('hidden');
                    }
                });
                // Handle nav buttons inside the more menu popup
                document.querySelectorAll('#more-menu-popup [data-view]').forEach(button => {
                    button.addEventListener('click', () => {
                        appState.currentView = button.dataset.view;
                        updateView();
                        document.getElementById('more-menu-popup')?.classList.add('hidden');
                    });
                });

                document.getElementById('daily-record-form')?.addEventListener('submit', handleDailyRecordSave);
                document.getElementById('event-form')?.addEventListener('submit', handleEventSave);
                document.getElementById('activity-form')?.addEventListener('submit', handleActivitySave);
                document.getElementById('add-manager-form')?.addEventListener('submit', handleAddManager);

                document.getElementById('content-area')?.addEventListener('click', handleContentAreaClicks);
                document.getElementById('admin-section')?.addEventListener('change', handleAdminClicks);
                document.getElementById('schedule-modal')?.addEventListener('click', handleScheduleModalClicks);
                document.getElementById('leave-modal')?.addEventListener('click', handleLeaveModalClicks);
                
                document.querySelectorAll('.eval-toggle-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        document.querySelectorAll('.eval-toggle-button').forEach(btn => {
                            btn.classList.remove('bg-[#DA291C]', 'text-white');
                            btn.classList.add('text-gray-600');
                        });
                        e.target.classList.add('bg-[#DA291C]', 'text-white');
                        e.target.classList.remove('text-gray-600');
                        
                        appState.evalDays = e.target.id === 'eval-7-day' ? 7 : 30;
                        renderEvaluator();
                    });
                });

                const weekPicker = document.getElementById('week-picker');
                weekPicker?.addEventListener('change', () => {
                    const selectedDate = new Date(weekPicker.value + 'T00:00:00');
                    const weekDates = getWeekDateStrings(selectedDate);
                    loadScheduleForWeek(weekDates);
                });

                // My Schedule week picker
                const myScheduleWeekPicker = document.getElementById('my-schedule-week-picker');
                myScheduleWeekPicker?.addEventListener('change', () => {
                    const selectedDate = new Date(myScheduleWeekPicker.value + 'T00:00:00');
                    const weekDates = getWeekDateStrings(selectedDate);
                    loadScheduleForWeek(weekDates).then(() => {
                        renderMySchedule();
                    });
                });

                // My Schedule profile save button
                document.getElementById('my-schedule-save-profile')?.addEventListener('click', () => {
                    const select = document.getElementById('my-schedule-manager-select');
                    const managerId = select?.value;
                    if (managerId) {
                        const manager = appState.managers.find(m => m.id === managerId);
                        if (manager) {
                            appState.currentUserManagerId = managerId;
                            appState.currentUserManagerName = manager.name;
                            // Save to localStorage for persistence
                            localStorage.setItem('myScheduleManagerId', managerId);
                            showToast(`Profile set to ${manager.name}`, 'success');
                            renderMySchedule();
                        }
                    } else {
                        showToast('Please select a manager profile', 'error');
                    }
                });

                // My Schedule manager select change - auto-save
                document.getElementById('my-schedule-manager-select')?.addEventListener('change', (e) => {
                    const managerId = e.target.value;
                    if (managerId) {
                        const manager = appState.managers.find(m => m.id === managerId);
                        if (manager) {
                            appState.currentUserManagerId = managerId;
                            appState.currentUserManagerName = manager.name;
                            localStorage.setItem('myScheduleManagerId', managerId);
                            renderMySchedule();
                        }
                    }
                });

                document.getElementById('modal-shift-select')?.addEventListener('change', (e) => {
                    const timeContainer = document.getElementById('modal-time-container');
                    if (['VL', 'HL', 'SL', 'OFF', 'Leave', ''].includes(e.target.value)) {
                        timeContainer.style.display = 'none';
                    } else {
                        timeContainer.style.display = 'block';
                    }
                });
                
                // Add event listener for the new GY/OT cutoff dropdown
                document.getElementById('gy-ot-cutoff-select')?.addEventListener('change', renderGyOtTracking);
                
                // --- DARK MODE TOGGLE ---
                document.getElementById('dark-mode-toggle')?.addEventListener('click', () => {
                    appState.darkMode = !appState.darkMode;
                    document.documentElement.classList.toggle('dark', appState.darkMode);
                    localStorage.setItem('darkMode', appState.darkMode);
                    
                    // Toggle icons
                    document.getElementById('dark-mode-icon-sun')?.classList.toggle('hidden', !appState.darkMode);
                    document.getElementById('dark-mode-icon-moon')?.classList.toggle('hidden', appState.darkMode);
                    
                    showToast(appState.darkMode ? 'üåô Dark mode enabled' : '‚òÄÔ∏è Light mode enabled', 'success');
                });
                
                // --- NOTIFICATION BELL ---
                document.getElementById('notification-bell')?.addEventListener('click', () => {
                    const dropdown = document.getElementById('notification-dropdown');
                    dropdown?.classList.toggle('hidden');
                });
                // Close notification dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('notification-dropdown');
                    const bell = document.getElementById('notification-bell');
                    if (dropdown && !dropdown.contains(e.target) && !bell?.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
                
                // --- EDIT MANAGER MODAL ---
                document.getElementById('edit-manager-modal-close')?.addEventListener('click', () => {
                    document.getElementById('edit-manager-modal')?.classList.add('hidden');
                });
                document.getElementById('edit-manager-cancel-btn')?.addEventListener('click', () => {
                    document.getElementById('edit-manager-modal')?.classList.add('hidden');
                });
                document.getElementById('edit-manager-save-btn')?.addEventListener('click', saveEditManager);
                
                // --- SCHEDULE TAB DROPDOWN ---
                document.getElementById('schedule-tab-select')?.addEventListener('change', (e) => {
                    renderManagerSchedule();
                });
                
                // --- SCHEDULE REQUEST MODAL ---
                document.getElementById('new-schedule-request-btn')?.addEventListener('click', () => {
                    openScheduleRequestModal();
                });
                document.getElementById('schedule-request-modal-close')?.addEventListener('click', () => {
                    document.getElementById('schedule-request-modal')?.classList.add('hidden');
                });
                document.getElementById('schedule-request-cancel-btn')?.addEventListener('click', () => {
                    document.getElementById('schedule-request-modal')?.classList.add('hidden');
                });
                document.getElementById('schedule-request-submit-btn')?.addEventListener('click', submitScheduleRequest);
                document.getElementById('schedule-request-type')?.addEventListener('change', handleScheduleRequestTypeChange);
            }
            
            // --- EVENT HANDLER FUNCTIONS ---
            function handleContentAreaClicks(e) {
                const target = e.target;
                
                if(target.closest('#historical-list')) handleHistoricalListClicks(e);
                if(target.closest('#activity-content-container')) handleActivityListClicks(e);
                if(target.closest('#manager-schedule-section')) handleManagerScheduleClicks(e);
                if(target.closest('#admin-section') && e.type === 'click') handleAdminClicks(e);
            }

            async function handleDailyRecordSave(e) {
                e.preventDefault();
                const form = e.target;
                const data = {
                    date: firebase.firestore.Timestamp.fromDate(createUTCDate(form['record-date'].value)),
                    sales: parseFloat(form['record-sales'].value),
                    customers: parseInt(form['record-customers'].value),
                    add_on_sales: parseFloat(form['record-addons'].value),
                    weather: form['record-weather'].value,
                };
                if (!data.date || isNaN(data.sales) || isNaN(data.customers) || isNaN(data.add_on_sales)) return showToast("Please fill all fields correctly.", "error");
                
                try {
                    await db.collection("historical_data").add(data);
                    showToast("Daily record saved!", "success");
                    form.reset();
                    loadInitialData();
                } catch (error) { showToast("Failed to save record.", "error"); }
            }
            
            async function handleEventSave(e) {
                e.preventDefault();
                const form = e.target;
                const data = {
                    activity_name: form['event-name'].value,
                    date: firebase.firestore.Timestamp.fromDate(createUTCDate(form['event-date'].value)),
                    potential_sales: 0, remarks: 'Event', customer_name: ''
                };
                if (!data.activity_name || !data.date) return showToast("Please fill all fields.", "error");
                
                try {
                    await db.collection("future_activities").add(data);
                    showToast("Event saved!", "success");
                    form.reset();
                    loadInitialData();
                } catch (error) { showToast("Failed to save event.", "error"); }
            }

            async function handleActivitySave(e) {
                e.preventDefault();
                const form = e.target;
                const data = {
                    activity_name: form['activity-name'].value,
                    event_venue: form['event-venue'].value,
                    customer_name: form['customer-name'].value,
                    contact_number: form['contact-number'].value,
                    date: firebase.firestore.Timestamp.fromDate(createUTCDate(form['activity-date'].value)),
                    activity_time: `${form['activity-time'].value} ${form['activity-ampm'].value}`,
                    potential_sales: parseFloat(form['activity-sales'].value),
                    remarks: form['activity-status'].value,
                    for_follow_up: form['for-follow-up'].value,
                    handled_by: form['handled-by'].value,
                    character: form['character'].value
                };
                if (!data.activity_name || !data.date || isNaN(data.potential_sales)) return showToast("Please fill all required fields.", "error");

                try {
                    await db.collection("future_activities").add(data);
                    showToast("Activity saved!", "success");
                    form.reset();
                    loadInitialData();
                } catch (error) { showToast("Failed to save activity.", "error"); }
            }

            async function handleAddManager(e) {
                e.preventDefault();
                const nameInput = document.getElementById('manager-name');
                const birthdayInput = document.getElementById('manager-birthday');
                const hireDateInput = document.getElementById('manager-hire-date');
                const positionInput = document.getElementById('manager-position');
                
                const name = nameInput.value.trim();
                if (name) {
                    try {
                        const managerData = { 
                            name: name, 
                            sortOrder: appState.managers.length,
                            birthday: birthdayInput?.value || null,
                            hireDate: hireDateInput?.value || null,
                            position: positionInput?.value || 'SL',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        await db.collection("managers").add(managerData);
                        showToast("Manager added!", "success");
                        nameInput.value = '';
                        if (birthdayInput) birthdayInput.value = '';
                        if (hireDateInput) hireDateInput.value = '';
                        loadInitialData();
                    } catch (error) { 
                        console.error(error);
                        showToast("Error adding manager.", "error"); 
                    }
                }
            }
            
            function handleHistoricalListClicks(e) {
                const target = e.target;
                const id = target.closest('[data-id]')?.dataset.id;
                if (!id) return;

                const viewDiv = document.getElementById(`view-hist-${id}`);
                const editForm = document.getElementById(`edit-form-hist-${id}`);

                if (target.closest('.edit-historical-btn')) {
                    viewDiv.classList.add('hidden');
                    editForm.classList.remove('hidden');
                }
                else if (target.closest('.cancel-edit-hist-btn')) {
                    viewDiv.classList.remove('hidden');
                    editForm.classList.add('hidden');
                }
                else if (target.closest('.delete-historical-btn')) {
                    showConfirm('Are you sure you want to delete this record?', () => {
                        db.collection('historical_data').doc(id).delete()
                            .then(() => { showToast('Record deleted.', 'success'); loadInitialData(); })
                            .catch(err => showToast('Error deleting record.', 'error'));
                    });
                }
                else if (target.closest('.update-historical-btn')) {
                    const [sales, customers, addons, weather] = editForm.elements;
                    const data = {
                        sales: parseFloat(sales.value), customers: parseInt(customers.value),
                        add_on_sales: parseFloat(addons.value), weather: weather.value
                    };
                    db.collection('historical_data').doc(id).update(data)
                        .then(() => { showToast('Record updated.', 'success'); loadInitialData(); })
                        .catch(err => showToast('Error updating record.', 'error'));
                }
            }

            function handleActivityListClicks(e) {
                const target = e.target;
                const id = target.closest('[data-id]')?.dataset.id;
                if (!id) return;

                const viewDiv = document.getElementById(`view-activity-${id}`);
                const editForm = document.getElementById(`edit-form-activity-${id}`);
                const activity = appState.activitiesData.find(a => a.id === id);

                if (target.closest('.edit-activity-btn')) {
                    if (!activity) return;
                    
                    const [time, ampm] = (activity.activity_time || ' AM').split(' ');
                    editForm.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block font-semibold mb-1">Activity Name</label>
                                <select class="w-full p-2 border rounded edit-activity-name">
                                    <option ${activity.activity_name === 'BP' ? 'selected' : ''}>BP</option>
                                    <option ${activity.activity_name === 'LFO' ? 'selected' : ''}>LFO</option>
                                    <option ${activity.activity_name === 'Funday' ? 'selected' : ''}>Funday</option>
                                </select>
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Event Venue</label>
                                <select class="w-full p-2 border rounded edit-event-venue">
                                    <option ${activity.event_venue === 'In-Store' ? 'selected' : ''}>In-Store</option>
                                    <option ${activity.event_venue === 'Take-out' ? 'selected' : ''}>Take-out</option>
                                    <option ${activity.event_venue === 'Pick-up' ? 'selected' : ''}>Pick-up</option>
                                    <option ${activity.event_venue === 'Delivery' ? 'selected' : ''}>Delivery</option>
                                </select>
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Customer Name</label>
                                <input type="text" value="${activity.customer_name || ''}" class="w-full p-2 border rounded edit-customer-name">
                            </div>
                             <div>
                                <label class="block font-semibold mb-1">Contact Number</label>
                                <input type="tel" value="${activity.contact_number || ''}" class="w-full p-2 border rounded edit-contact-number">
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Date</label>
                                <input type="date" value="${getLocalDateString(activity.date.toDate())}" class="w-full p-2 border rounded edit-activity-date">
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Time</label>
                                <div class="flex">
                                    <input type="text" value="${time}" class="w-full p-2 rounded-l-lg border-2 border-r-0 border-gray-200 edit-activity-time">
                                    <select class="p-2 rounded-r-lg border-2 border-l-0 border-gray-200 bg-gray-50 edit-activity-ampm">
                                        <option ${ampm === 'AM' ? 'selected' : ''}>AM</option>
                                        <option ${ampm === 'PM' ? 'selected' : ''}>PM</option>
                                    </select>
                                </div>
                            </div>
                             <div>
                                <label class="block font-semibold mb-1">Est. Sales (‚Ç±)</label>
                                <input type="number" step="0.01" value="${activity.potential_sales || 0}" class="w-full p-2 border rounded edit-activity-sales">
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Status</label>
                                <select class="w-full p-2 border rounded edit-activity-status">
                                    <option ${activity.remarks === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option ${activity.remarks === 'Needs Follow-up' ? 'selected' : ''}>Needs Follow-up</option>
                                    <option ${activity.remarks === 'Tentative' ? 'selected' : ''}>Tentative</option>
                                    <option ${activity.remarks === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">For Follow-up</label>
                                <input type="text" list="follow-up-options" value="${activity.for_follow_up || ''}" class="w-full p-2 border rounded edit-for-follow-up">
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Handled by</label>
                                <input type="text" value="${activity.handled_by || ''}" class="w-full p-2 border rounded edit-handled-by">
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Character</label>
                                <select class="w-full p-2 border rounded edit-character">
                                    <option ${activity.character === 'None' ? 'selected' : ''}>None</option>
                                    <option ${activity.character === '1' ? 'selected' : ''}>1</option>
                                    <option ${activity.character === '2' ? 'selected' : ''}>2</option>
                                    <option ${activity.character === 'Full' ? 'selected' : ''}>Full</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-4">
                            <button type="button" data-id="${id}" class="update-activity-btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                            <button type="button" data-id="${id}" class="cancel-edit-activity-btn w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                        </div>
                    `;
                    
                    viewDiv.classList.add('hidden');
                    editForm.classList.remove('hidden');

                } else if (target.closest('.cancel-edit-activity-btn')) {
                    viewDiv.classList.remove('hidden');
                    editForm.classList.add('hidden');
                    editForm.innerHTML = ''; // Clear the form content
                } else if (target.closest('.delete-activity-btn')) {
                    showConfirm('Are you sure you want to delete this activity?', () => {
                        db.collection('future_activities').doc(id).delete()
                            .then(() => { showToast('Activity deleted.', 'success'); loadInitialData(); })
                            .catch(err => showToast('Error deleting activity.', 'error'));
                    });
                } else if (target.closest('.update-activity-btn')) {
                    const form = target.closest('form');
                    const timeValue = form.querySelector('.edit-activity-time').value;
                    const ampmValue = form.querySelector('.edit-activity-ampm').value;
                    const data = {
                        activity_name: form.querySelector('.edit-activity-name').value,
                        event_venue: form.querySelector('.edit-event-venue').value,
                        customer_name: form.querySelector('.edit-customer-name').value,
                        contact_number: form.querySelector('.edit-contact-number').value,
                        date: firebase.firestore.Timestamp.fromDate(createUTCDate(form.querySelector('.edit-activity-date').value)),
                        activity_time: `${timeValue} ${ampmValue}`,
                        potential_sales: parseFloat(form.querySelector('.edit-activity-sales').value),
                        remarks: form.querySelector('.edit-activity-status').value,
                        for_follow_up: form.querySelector('.edit-for-follow-up').value,
                        handled_by: form.querySelector('.edit-handled-by').value,
                        character: form.querySelector('.edit-character').value,
                    };
                    db.collection('future_activities').doc(id).update(data)
                        .then(() => { showToast('Activity updated.', 'success'); loadInitialData(); })
                        .catch(err => showToast('Error updating activity.', 'error'));
                }
            }

            function handleManagerScheduleClicks(e) {
                const target = e.target;
                if (target.classList.contains('delete-manager-btn')) {
                    const managerId = target.dataset.id;
                    showConfirm('Are you sure you want to delete this manager? This cannot be undone.', () => {
                        db.collection("managers").doc(managerId).delete()
                            .then(() => { showToast("Manager deleted."); loadInitialData(); })
                            .catch(error => showToast("Error deleting manager.", "error"));
                    });
                }
                 else if (target.classList.contains('edit-manager-btn')) {
                    const managerId = target.dataset.id;
                    openEditManagerModal(managerId);
                }
                 else if (target.closest('.schedule-cell')) {
                    if (appState.accessLevel === 2) return;
                    const cell = target.closest('.schedule-cell');
                    if (cell.dataset.managerId) {
                        openScheduleModal(cell.dataset.managerId, cell.dataset.date);
                    }
                } else if(target.id === 'add-leave-btn') {
                    openLeaveModal();
                } else if(target.id === 'prev-month-btn' || target.id === 'gy-ot-prev-month-btn') {
                    appState.calendarDate.setMonth(appState.calendarDate.getMonth() - 1);
                    renderManagerSchedule();
                } else if(target.id === 'next-month-btn' || target.id === 'gy-ot-next-month-btn') {
                    appState.calendarDate.setMonth(appState.calendarDate.getMonth() + 1);
                    renderManagerSchedule();
                } else if (target.classList.contains('leave-entry')) {
                    if (appState.accessLevel === 2) return;
                    const leaveId = target.dataset.leaveId;
                    if (leaveId) {
                        openLeaveModal(null, leaveId);
                    }
                }
            }

            function handleAdminClicks(e) {
                const target = e.target;
                const id = target.dataset.id;
                if(!id) return;

                if (target.classList.contains('delete-user-btn')) {
                    showConfirm('Are you sure? This deletes the user record but not their login.', () => {
                        db.collection('users').doc(id).delete()
                            .then(() => { showToast('User record deleted.', 'success'); loadInitialData(); })
                            .catch(err => showToast('Error deleting user record.', 'error'));
                    });
                } else if (target.classList.contains('user-access-level-select')) {
                    const newLevel = parseInt(target.value);
                    db.collection('users').doc(id).update({ access_level: newLevel })
                        .then(() => showToast('Access level updated.', 'success'))
                        .catch(err => showToast('Error updating access level.', 'error'));
                }
            }
            
            function handleScheduleModalClicks(e) {
                const target = e.target;
                if(target.id === 'modal-cancel-btn') {
                    document.getElementById('schedule-modal').classList.add('hidden');
                } else if (target.id === 'modal-save-btn') {
                    saveScheduleFromModal();
                } else if (target.id === 'modal-delete-btn') {
                    clearScheduleFromModal();
                }
            }

            function handleLeaveModalClicks(e) {
                const target = e.target;
                if(target.id === 'leave-cancel-btn') {
                    document.getElementById('leave-modal').classList.add('hidden');
                } else if (target.id === 'leave-save-btn') {
                    saveLeaveFromModal();
                } else if (target.id === 'leave-delete-btn') {
                    deleteLeaveFromModal();
                }
            }

            function openScheduleModal(managerId, date) {
                const modal = document.getElementById('schedule-modal');
                const manager = appState.managers.find(m => m.id === managerId);
                if(!modal || !manager) return;

                modal.dataset.managerId = managerId;
                modal.dataset.date = date;

                document.getElementById('modal-title').textContent = `Edit Schedule for ${manager.name} on ${new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'long', day: 'numeric' })}`;
                
                const shiftSelect = document.getElementById('modal-shift-select');
                const timeInput = document.getElementById('modal-time-input');
                const timeContainer = document.getElementById('modal-time-container');
                const shiftOptions = ["", "Open SL", "Open SM", "Mid SM", "Close SL", "Close SM", "GY", "OT", "Scheduling", "VL", "HL", "SL", "OFF", "Ordering", "People Day", "MDP", "Pull-out", "Marketing", "Store Day", "Travel", "Class", "Payroll", "Inventory", "Meeting", "Leave"];
                shiftSelect.innerHTML = shiftOptions.map(o => `<option value="${o}">${o}</option>`).join('');

                let scheduleData = appState.managerSchedules[`${managerId}_${date}`] || { shift: '', time: '' };

                if (!scheduleData.shift) {
                    const plannedLeave = appState.plottedLeaves.find(leave => {
                        const leaveStart = createUTCDate(leave.startDate);
                        const leaveEnd = createUTCDate(leave.endDate);
                        const currentDate = createUTCDate(date);
                        return leave.managerId === managerId && currentDate >= leaveStart && currentDate <= leaveEnd;
                    });
                    if (plannedLeave) {
                        scheduleData = { shift: plannedLeave.leaveType, time: '' };
                    }
                }

                shiftSelect.value = scheduleData.shift;
                timeInput.value = scheduleData.time;
                
                timeContainer.style.display = ['VL', 'HL', 'SL', 'OFF', 'Leave', ''].includes(scheduleData.shift) ? 'none' : 'block';
                
                modal.classList.remove('hidden');
            }

            async function saveScheduleFromModal() {
                const modal = document.getElementById('schedule-modal');
                const { managerId, date } = modal.dataset;
                const shift = document.getElementById('modal-shift-select').value;
                const time = document.getElementById('modal-time-input').value;
                const managerName = appState.managers.find(m => m.id === managerId)?.name;

                const scheduleKey = `${managerId}_${date}`;
                const weekKey = getWeekDateStrings(new Date(date + 'T00:00:00'))[0];
                const scheduleData = { shift, time: ['VL', 'HL', 'SL', 'OFF', 'Leave', ''].includes(shift) ? '' : time };

                try {
                    await db.collection("manager_schedules").doc(weekKey).set({ [scheduleKey]: scheduleData }, { merge: true });
                    showToast("Schedule saved!", "success");
                    appState.managerSchedules[scheduleKey] = scheduleData;
                    renderWeeklySchedule();
                    renderShiftSchedule();
                    modal.classList.add('hidden');
                } catch (error) { showToast("Failed to save schedule.", "error"); }
            }

            async function clearScheduleFromModal() {
                const modal = document.getElementById('schedule-modal');
                const { managerId, date } = modal.dataset;
                const scheduleKey = `${managerId}_${date}`;
                const weekKey = getWeekDateStrings(new Date(date + 'T00:00:00'))[0];
                
                try {
                    await db.collection("manager_schedules").doc(weekKey).update({
                        [scheduleKey]: firebase.firestore.FieldValue.delete()
                    });

                    showToast("Schedule cleared!", "success");
                    delete appState.managerSchedules[scheduleKey];
                    renderWeeklySchedule();
                    renderShiftSchedule();
                    modal.classList.add('hidden');
                } catch (error) { showToast("Failed to clear schedule.", "error"); }
            }
            
            function openLeaveModal(date = null, leaveId = null) {
                const modal = document.getElementById('leave-modal');
                const title = document.getElementById('leave-modal-title');
                const managerSelect = document.getElementById('leave-manager-select');
                const typeSelect = document.getElementById('leave-type-select');
                const startDateInput = document.getElementById('leave-start-date');
                const endDateInput = document.getElementById('leave-end-date');
                const deleteBtn = document.getElementById('leave-delete-btn');

                modal.dataset.leaveId = '';
                deleteBtn.classList.add('hidden');
                
                managerSelect.innerHTML = appState.managers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');

                if (leaveId) {
                    const leaveData = appState.plottedLeaves.find(l => l.id === leaveId);
                    if (!leaveData) {
                        showToast("Could not find leave data to edit.", "error");
                        return;
                    }
                    title.textContent = "Edit Leave";
                    managerSelect.value = leaveData.managerId;
                    typeSelect.value = leaveData.leaveType;
                    startDateInput.value = leaveData.startDate;
                    endDateInput.value = leaveData.endDate;
                    modal.dataset.leaveId = leaveId;
                    deleteBtn.classList.remove('hidden');
                } else {
                    title.textContent = "Plot Leave";
                    const selectedDate = date ? date : getLocalDateString(new Date());
                    startDateInput.value = selectedDate;
                    endDateInput.value = selectedDate;
                }

                modal.classList.remove('hidden');
            }

            async function saveLeaveFromModal() {
                const modal = document.getElementById('leave-modal');
                const leaveId = modal.dataset.leaveId;
                const managerId = document.getElementById('leave-manager-select').value;
                const managerName = appState.managers.find(m => m.id === managerId)?.name;
                const leaveType = document.getElementById('leave-type-select').value;
                const startDate = document.getElementById('leave-start-date').value;
                const endDate = document.getElementById('leave-end-date').value;

                if (!managerId || !startDate || !endDate) return showToast("Please fill all fields.", "error");

                const leaveData = { managerId, managerName, leaveType, startDate, endDate, year: new Date(startDate).getFullYear() };

                try {
                    if (leaveId) {
                        await db.collection('plotted_leaves').doc(leaveId).update(leaveData);
                    } else {
                        await db.collection('plotted_leaves').add(leaveData);
                    }
                    
                    showToast(`Leave ${leaveId ? 'updated' : 'plotted'} successfully!`, "success");
                    modal.classList.add('hidden');
                    loadInitialData(); // Reload data to show the new planned leave
                } catch (error) {
                    console.error("Error saving leave:", error);
                    showToast("Failed to save leave.", "error");
                }
            }

            async function deleteLeaveFromModal() {
                const modal = document.getElementById('leave-modal');
                const leaveId = modal.dataset.leaveId;
                if (!leaveId) return;
                
                showConfirm("Are you sure you want to delete this planned leave?", async () => {
                    try {
                        await db.collection('plotted_leaves').doc(leaveId).delete();
                        
                        showToast("Planned leave deleted successfully!", "success");
                        modal.classList.add('hidden');
                        loadInitialData();
                    } catch (error) {
                        console.error("Error deleting leave:", error);
                        showToast("Failed to delete leave.", "error");
                    }
                });
            }

            // --- AUTHENTICATION FLOW ---
            UI.loginForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = UI.loginForm.email.value;
                const password = UI.loginForm.password.value;
                UI.loginError.textContent = '';
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        UI.loginError.textContent = "Invalid username or password.";
                    });
            });

            auth.onAuthStateChanged(async user => {
                if (user) {
                    UI.loadingOverlay.style.display = 'flex';
                    UI.loadingText.textContent = 'Authenticating...';
                    
                    try {
                        UI.loginScreen.style.display = 'none';
                        UI.appContainer.style.display = 'flex';
                        
                        // Store current user email
                        appState.currentUserEmail = user.email;
                        
                        const userDocRef = db.collection('users').doc(user.uid);
                        const userDoc = await userDocRef.get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            appState.accessLevel = userData.access_level || 3;
                            // Check if user has a linked manager_id
                            if (userData.manager_id) {
                                appState.currentUserManagerId = userData.manager_id;
                            }
                        } else {
                            const newUser = {
                                username: user.email,
                                access_level: 3
                            };
                            await userDocRef.set(newUser);
                            appState.accessLevel = 3; 
                        }

                        if (appState.accessLevel === 3) {
                            appState.currentView = 'activities';
                        }
                        
                        UI.userGreeting.textContent = `Welcome, ${user.email.split('@')[0]}`;
                        await loadInitialData();
                        
                        // After loading data, try to match user email with a manager name
                        if (!appState.currentUserManagerId && appState.managers.length > 0) {
                            const emailUsername = user.email.split('@')[0].toLowerCase();
                            const matchedManager = appState.managers.find(m => 
                                m.name.toLowerCase().replace(/\s+/g, '') === emailUsername ||
                                m.name.toLowerCase().split(' ')[0] === emailUsername ||
                                m.name.toLowerCase() === emailUsername
                            );
                            if (matchedManager) {
                                appState.currentUserManagerId = matchedManager.id;
                                appState.currentUserManagerName = matchedManager.name;
                            }
                        } else if (appState.currentUserManagerId) {
                            const manager = appState.managers.find(m => m.id === appState.currentUserManagerId);
                            if (manager) {
                                appState.currentUserManagerName = manager.name;
                            }
                        }
                        
                        // Render My Schedule if on schedule view
                        if (appState.currentView === 'manager-schedule') {
                            renderMySchedule();
                        }
                        
                    } catch (error) {
                        console.error("Authentication process failed:", error);
                        showToast("Could not complete login process. Please contact admin.", "error");
                        auth.signOut(); 
                    } 
                } else {
                    UI.loginScreen.style.display = 'flex';
                    UI.appContainer.style.display = 'none';
                    UI.loadingOverlay.style.display = 'none';
                    appState.accessLevel = 3;
                    appState.currentUserEmail = null;
                    appState.currentUserManagerId = null;
                    appState.currentUserManagerName = null;
                }
            });

            // --- INITIALIZE APP ---
            setupAllEventListeners();
        });
    </script>

</body>
</html>
