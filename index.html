<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>McDonald's San Carlos 688</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #F7F7F7;
        }
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button.active {
            background-color: #DA291C; /* McDonald's Red */
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 50vh;
        }
        .stat-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #E5E7EB;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            opacity: 1;
            bottom: 40px;
        }
        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }
        /* Custom scrollbar for webkit browsers */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .month-tab.active {
            border-color: #DA291C;
            background-color: #DA291C;
            color: white;
        }
        .schedule-tab {
            color: #4b5563; /* Darker gray for inactive tabs */
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .schedule-tab:hover {
            background-color: #f3f4f6;
            border-bottom: 3px solid #d1d5db;
        }
        .schedule-tab.active {
            background-color: #4A5568; /* Dark Slate Gray from image */
            color: white;
            font-weight: 600;
            border-color: transparent;
            border-radius: 6px 6px 0 0;
        }
        .schedule-tab.active:hover {
             background-color: #4A5568;
        }
        .schedule-table th, .schedule-table td {
            text-align: center;
            padding: 0.25rem;
            border: 1px solid #e2e8f0;
            vertical-align: middle;
            height: 70px;
        }
        .schedule-table th {
            background-color: #f8fafc;
            padding: 0.75rem;
        }
        .schedule-cell {
            cursor: pointer;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .schedule-cell:hover {
            background-color: #f7fafc;
        }
        .schedule-input {
            width: 100%;
            border: 1px solid #e2e8f0;
            background-color: white;
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        .schedule-input:focus {
            outline: none;
            border-color: #DA291C;
            box-shadow: 0 0 0 2px rgba(218, 41, 28, 0.2);
        }
        /* Calendar Styles */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e2e8f0;
            border: 1px solid #e2e8f0;
        }
        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 0.5rem 0;
            background-color: #f8fafc;
        }
        .calendar-day {
            min-height: 120px;
            padding: 0.5rem;
            background-color: white;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-day:hover {
            background-color: #f7fafc;
        }
        .calendar-day.other-month {
            background-color: #f1f5f9;
            color: #94a3b8;
        }
        .calendar-day .day-number {
            font-weight: 500;
        }
        .leave-entry {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin-top: 4px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .leave-vl { background-color: #3b82f6; }
        .leave-hl { background-color: #10b981; }
        .leave-sl { background-color: #f59e0b; }
        .view-only {
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex-col items-center justify-center z-50 hidden">
        <div class="text-center p-4">
            <svg class="animate-spin h-10 w-10 text-[#DA291C] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">Loading...</p>
        </div>
    </div>
    
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png" alt="Logo" class="h-12 w-auto mx-auto mb-6">
            <h2 class="text-2xl font-bold text-center mb-1">Welcome Back</h2>
            <p class="text-center text-gray-500 mb-6">Please sign in to access the forecaster.</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Username (Email)</label>
                    <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500">
                </div>
                <div id="login-error" class="text-sm text-red-600 h-auto"></div>
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#DA291C] hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Sign In
                </button>
            </form>
        </div>
    </div>


    <div id="app-container" class="min-h-screen flex-col hidden">
        <header class="bg-white shadow-md sticky top-0 z-10">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center space-x-4">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/McDonald%27s_Golden_Arches.svg/1200px-McDonald%27s_Golden_Arches.svg.png" alt="Logo" class="h-8 w-auto">
                        <h1 class="text-xl md:text-2xl font-bold text-gray-800">McDonald's San Carlos 688</h1>
                    </div>
                     <nav id="main-nav" class="hidden md:flex flex-wrap items-center text-base justify-center">
                        <button data-view="dashboard" class="nav-button active px-3 py-2 rounded-lg font-semibold">Dashboard</button>
                        <button data-view="insights" class="nav-button px-3 py-2 rounded-lg font-semibold">Insights</button>
                        <button data-view="evaluator" class="nav-button px-3 py-2 rounded-lg font-semibold">Evaluator</button>
                        <button data-view="manager-schedule" class="nav-button px-3 py-2 rounded-lg font-semibold">Manager Schedule</button>
                        <button data-view="datamgmt" class="nav-button px-3 py-2 rounded-lg font-semibold">Add Data</button>
                        <button data-view="activities" class="nav-button px-3 py-2 rounded-lg font-semibold">Activities</button>
                        <button data-view="historical" class="nav-button px-3 py-2 rounded-lg font-semibold">History</button>
                        <button data-view="admin" class="nav-button px-3 py-2 rounded-lg font-semibold hidden">Admin</button>
                    </nav>
                     <div class="flex items-center space-x-4">
                        <p id="user-greeting" class="hidden md:block text-sm font-semibold"></p>
                        <button id="logout-btn" class="hidden md:flex items-center space-x-2 px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition">
                            <span>Logout</span>
                        </button>
                     </div>
                </div>
            </div>
        </header>
        
        <nav id="mobile-nav" class="md:hidden bg-white shadow-md p-2 grid grid-cols-4 gap-1 sticky top-0 z-10">
            <button data-view="dashboard" class="nav-button active flex-1 text-xs py-2 rounded-lg font-semibold">Dashboard</button>
            <button data-view="insights" class="nav-button flex-1 text-xs py-2 rounded-lg font-semibold">Insights</button>
            <button data-view="evaluator" class="nav-button flex-1 text-xs py-2 rounded-lg font-semibold">Evaluator</button>
            <button data-view="manager-schedule" class="nav-button flex-1 text-xs py-2 rounded-lg font-semibold">Schedule</button>
            <button data-view="datamgmt" class="nav-button flex-1 text-xs py-2 rounded-lg font-semibold">Add Data</button>
            <button data-view="activities" class="nav-button flex-1 text-xs py-2 rounded-lg font-semibold">Activities</button>
            <button data-view="historical" class="nav-button flex-1 text-xs py-2 rounded-lg font-semibold">History</button>
            <button data-view="admin" class="nav-button flex-1 text-xs py-2 rounded-lg font-semibold hidden">Admin</button>
        </nav>


        <main id="content-area" class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <div id="provisional-forecast-banner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
                <p class="font-bold">Provisional Forecast</p>
                <p>Displaying a basic forecast generated from historical data. For the advanced prediction, please run the backend Python engine.</p>
            </div>
            
            <section id="dashboard-section" class="view">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Dashboard</h2>
                    <p class="text-gray-600">This section presents the 15-day outlook for projected sales and customer traffic, providing a high-level overview of expected performance.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Daily Sales (7-Day)</h3>
                        <p id="avg-sales" class="text-4xl font-bold text-[#DA291C] mt-2">₱0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Daily Customers (7-Day)</h3>
                        <p id="avg-customers" class="text-4xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="stat-card text-center">
                        <h3 class="text-lg font-semibold text-gray-500">Avg. Transaction Value (7-Day)</h3>
                        <p id="avg-atv" class="text-4xl font-bold text-gray-800 mt-2">₱0.00</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                     <h3 class="text-xl font-bold mb-4">15-Day Performance Outlook</h3>
                    <div class="chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="insights-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Insights</h2>
                    <p class="text-gray-600">Explore the underlying drivers of the daily forecast. This waterfall chart breaks down how factors like the day of the week, seasonality, and holidays contribute to the final customer projection.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h3 class="text-xl font-bold mb-2 sm:mb-0">Daily Driver Analysis</h3>
                        <div>
                            <label for="insightDate" class="font-semibold mr-2">Select a Date:</label>
                            <select id="insightDate" class="p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-center">
                        <div class="lg:col-span-2 chart-container">
                            <canvas id="waterfallChart"></canvas>
                        </div>
                        <div id="insight-summary" class="bg-gray-50 p-6 rounded-lg border">
                            <h4 class="font-bold text-lg mb-2">Summary</h4>
                            <p class="text-gray-700">Select a date to see a summary of its forecast drivers.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="evaluator-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Forecast Evaluator</h2>
                    <p class="text-gray-600">This section measures the model's historical accuracy by comparing past day-ahead forecasts against actual results. This helps build trust and identify areas for model improvement.</p>
                </div>
                <div class="flex justify-center mb-6">
                     <div class="inline-flex rounded-lg shadow-sm bg-white border">
                        <button id="eval-7-day" class="eval-toggle-button bg-[#DA291C] text-white px-4 py-2 rounded-l-lg font-semibold">Last 7 Days</button>
                        <button id="eval-30-day" class="eval-toggle-button px-4 py-2 font-semibold text-gray-600">Last 30 Days</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                     <div class="stat-card">
                         <h3 class="text-lg font-semibold text-gray-500">Sales Accuracy (vs MAPE)</h3>
                         <p id="sales-accuracy" class="text-3xl font-bold mt-1">0.00%</p>
                     </div>
                     <div class="stat-card">
                         <h3 class="text-lg font-semibold text-gray-500">Customer Accuracy (vs MAPE)</h3>
                         <p id="customer-accuracy" class="text-3xl font-bold mt-1">0.00%</p>
                     </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Actual vs. Forecasted Sales</h3>
                        <div class="chart-container">
                            <canvas id="salesEvalChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Actual vs. Forecasted Customers</h3>
                        <div class="chart-container">
                            <canvas id="customersEvalChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="manager-schedule-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Manager Schedule</h2>
                    <p class="text-gray-600">Plot daily shifts and track leaves for managers.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div id="manager-schedule-tabs" class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-2" aria-label="Tabs">
                            <button data-tab="weekly-schedule" class="schedule-tab whitespace-nowrap font-medium text-sm active">Weekly Schedule</button>
                            <button data-tab="shift-schedule" class="schedule-tab whitespace-nowrap font-medium text-sm">Shift Schedule</button>
                            <button data-tab="leave-schedule" class="schedule-tab whitespace-nowrap font-medium text-sm">HL & VL Schedule</button>
                            <button data-tab="leave-tracking" class="schedule-tab whitespace-nowrap font-medium text-sm">Leave Tracking</button>
                            <button data-tab="manage-managers" class="schedule-tab whitespace-nowrap font-medium text-sm">Manage Managers</button>
                        </nav>
                    </div>

                    <div id="weekly-schedule-content" class="schedule-content">
                        <div class="flex justify-end items-center mb-4">
                            <label for="week-picker" class="font-semibold mr-2">Select Week:</label>
                            <input type="date" id="week-picker" class="p-2 rounded-lg border-2 border-gray-200 focus:border-[#DA291C] focus:outline-none">
                        </div>
                        <div class="overflow-x-auto hidden md:block">
                            <table id="weekly-schedule-table" class="min-w-full bg-white border schedule-table"></table>
                        </div>
                        <div id="weekly-schedule-mobile" class="block md:hidden space-y-4"></div>
                    </div>

                    <div id="shift-schedule-content" class="schedule-content hidden">
                        <div class="overflow-x-auto hidden md:block">
                            <table id="shift-schedule-table" class="min-w-full bg-white border schedule-table"></table>
                        </div>
                        <div id="shift-schedule-mobile" class="block md:hidden space-y-4"></div>
                    </div>

                    <div id="leave-schedule-content" class="schedule-content hidden">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-2">
                                <button id="prev-month-btn" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300">&lt;</button>
                                <h3 id="calendar-month-year" class="text-xl font-bold text-center w-48"></h3>
                                <button id="next-month-btn" class="px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300">&gt;</button>
                            </div>
                            <button id="add-leave-btn" class="px-4 py-2 bg-[#DA291C] text-white font-semibold rounded-lg hover:bg-red-700">Add Leave</button>
                        </div>
                        <div id="leave-calendar-container"></div>
                    </div>

                    <div id="leave-tracking-content" class="schedule-content hidden">
                        <h3 class="text-xl font-bold mb-4">Manager Leave Summary</h3>
                        <div id="leave-records-container" class="space-y-4"></div>
                    </div>

                    <div id="manage-managers-content" class="schedule-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-xl font-bold mb-4">Add New Manager</h3>
                                <form id="add-manager-form" class="space-y-4">
                                    <div>
                                        <label for="manager-name" class="block font-semibold mb-1">Manager Name</label>
                                        <input type="text" id="manager-name" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                    </div>
                                    <button type="submit" class="w-full bg-[#DA291C] text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition duration-300">Add Manager</button>
                                </form>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold mb-4">Current Managers</h3>
                                <div id="manager-list-container" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="datamgmt-section" class="view hidden">
                 <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Add New Data</h2>
                    <p class="text-gray-600">Add new daily records and future activities to improve forecast accuracy.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Add New Daily Record</h3>
                        <form id="daily-record-form" class="space-y-4">
                            <div>
                                <label for="record-date" class="block font-semibold mb-1">Date</label>
                                <input type="date" id="record-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="record-sales" class="block font-semibold mb-1">Total Sales (₱)</label>
                                    <input type="number" step="0.01" id="record-sales" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-customers" class="block font-semibold mb-1">Customers</label>
                                    <input type="number" id="record-customers" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-addons" class="block font-semibold mb-1">Add-on Sales (₱)</label>
                                    <input type="number" step="0.01" id="record-addons" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="record-weather" class="block font-semibold mb-1">Weather</label>
                                    <select id="record-weather" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                        <option>Sunny</option>
                                        <option>Cloudy</option>
                                        <option>Rainy</option>
                                        <option>Storm</option>
                                    </select>
                                </div>
                            </div>
                             <button type="submit" class="w-full bg-[#DA291C] text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition duration-300">Save Daily Record</button>
                        </form>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4">Add Future Event</h3>
                        <form id="event-form" class="space-y-4">
                             <div>
                                <label for="event-name" class="block font-semibold mb-1">Event Name</label>
                                <input type="text" id="event-name" placeholder="e.g., San Carlos Charter Day" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                             <div>
                                <label for="event-date" class="block font-semibold mb-1">Date</label>
                                <input type="date" id="event-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                            <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition duration-300">Save Event</button>
                        </form>
                    </div>
                </div>
            </section>
            
            <section id="activities-section" class="view hidden">
                 <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Future Activities</h2>
                    <p class="text-gray-600">Add, browse, and manage all upcoming events and promotions.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                         <h3 class="text-xl font-bold mb-4">Add New Activity</h3>
                        <form id="activity-form" class="space-y-4">
                             <div>
                                <label for="activity-name" class="block font-semibold mb-1">Activity Name</label>
                                <input type="text" id="activity-name" placeholder="e.g., Catering for Birthday" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                            </div>
                            <div>
                                <label for="customer-name" class="block font-semibold mb-1">Customer Name</label>
                                <input type="text" id="customer-name" placeholder="e.g., John Doe" class="w-full p-2 rounded-lg border-2 border-gray-200">
                            </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="activity-date" class="block font-semibold mb-1">Date</label>
                                    <input type="date" id="activity-date" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                                <div>
                                    <label for="activity-sales" class="block font-semibold mb-1">Est. Sales (₱)</label>
                                    <input type="number" step="0.01" id="activity-sales" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                </div>
                            </div>
                             <div>
                                <label for="activity-status" class="block font-semibold mb-1">Status</label>
                                <select id="activity-status" class="w-full p-2 rounded-lg border-2 border-gray-200" required>
                                    <option>Confirmed</option>
                                    <option>Needs Follow-up</option>
                                    <option>Tentative</option>
                                    <option>Cancelled</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-900 transition duration-300">Save Activity</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="flex space-x-4 mb-4 bg-white p-4 rounded-lg shadow-sm border">
                            <div>
                                <label for="activity-year" class="block text-sm font-medium text-gray-700">Year</label>
                                <select id="activity-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"></select>
                            </div>
                        </div>
                        <div id="activity-tabs-container" class="mb-4 border-b border-gray-300">
                            </div>
                        <div id="activity-content-container">
                            </div>
                    </div>
                </div>
            </section>

            <section id="historical-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">Historical Data</h2>
                    <p class="text-gray-600">Browse and manage past daily records.</p>
                </div>
                <div class="flex space-x-4 mb-4 bg-white p-4 rounded-lg shadow-sm border">
                    <div>
                        <label for="hist-year" class="block text-sm font-medium text-gray-700">Year</label>
                        <select id="hist-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="hist-month" class="block text-sm font-medium text-gray-700">Month</label>
                        <select id="hist-month" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md"></select>
                    </div>
                </div>
                <div id="historical-list" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                    </div>
            </section>

            <section id="admin-section" class="view hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-1">User Management</h2>
                    <p class="text-gray-600">View and manage user access levels. New users should be created securely in the Firebase Console.</p>
                </div>
                <div id="user-list" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 space-y-4">
                    </div>
            </section>

        </main>
    </div>
    <div id="toast-container"></div>

    <!-- Schedule Editing Modal -->
    <div id="schedule-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="modal-title">Edit Schedule</h3>
            <div class="space-y-4">
                <div>
                    <label for="modal-shift-select" class="block text-sm font-medium text-gray-700">Shift</label>
                    <select id="modal-shift-select" class="mt-1 block w-full schedule-input"></select>
                </div>
                <div id="modal-time-container">
                    <label for="modal-time-input" class="block text-sm font-medium text-gray-700">Time of Duty</label>
                    <input type="text" id="modal-time-input" list="time-choices" class="mt-1 block w-full schedule-input" placeholder="e.g., 9am-6pm or select">
                    <datalist id="time-choices">
                        <option value="6am-3pm"></option>
                        <option value="7am-4pm"></option>
                        <option value="2pm-11pm"></option>
                        <option value="4pm-1am"></option>
                        <option value="8am-5pm"></option>
                        <option value="10pm-7am"></option>
                        <option value="10am-7pm"></option>
                    </datalist>
                </div>
            </div>
            <div class="mt-6 space-y-2">
                <button id="modal-save-btn" class="w-full px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    Save
                </button>
                 <button id="modal-delete-btn" class="w-full px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    Clear Schedule
                </button>
                <button id="modal-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Leave Plotting Modal -->
    <div id="leave-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4" id="leave-modal-title">Plot Leave</h3>
            <div class="space-y-4">
                <div>
                    <label for="leave-manager-select" class="block text-sm font-medium text-gray-700">Manager</label>
                    <select id="leave-manager-select" class="mt-1 block w-full schedule-input"></select>
                </div>
                 <div>
                    <label for="leave-type-select" class="block text-sm font-medium text-gray-700">Leave Type</label>
                    <select id="leave-type-select" class="mt-1 block w-full schedule-input">
                        <option value="VL">Vacation Leave (VL)</option>
                        <option value="HL">Holiday Leave (HL)</option>
                        <option value="SL">Sick Leave (SL)</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="leave-start-date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="leave-start-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="leave-end-date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="leave-end-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            </div>
            <div class="mt-6 space-y-2">
                <button id="leave-save-btn" class="w-full px-4 py-2 bg-green-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-700">Save Leave</button>
                <button id="leave-delete-btn" class="w-full px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700">Delete Leave</button>
                <button id="leave-cancel-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- FIREBASE INITIALIZATION ---
            const firebaseConfig = {
              apiKey: "AIzaSyBlbxhzUp_TZd8oTrLxrY-E6gq-_XdiMCo",
              authDomain: "mcdonalds-san-carlos.firebaseapp.com",
              projectId: "mcdonalds-san-carlos",
              storageBucket: "mcdonalds-san-carlos.appspot.com",
              messagingSenderId: "1052052612983",
              appId: "1:1052052612983:web:8df02d65d12e99e0666372",
              measurementId: "G-EYSWHXTQ6F"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // --- GLOBAL STATE & CHARTS ---
            let charts = {};
            const appState = {
                currentView: 'dashboard',
                evalDays: 7,
                forecastData: null,
                evaluationData: null,
                insightsData: null,
                activitiesData: null,
                historicalData: null,
                usersData: null,
                managers: [],
                managerSchedules: {},
                plottedLeaves: [],
                calendarDate: new Date(),
                accessLevel: 3, // Default to viewer
            };
            
            // --- TOAST NOTIFICATION ---
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toastContainer.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            }

            // --- DATE HELPER FUNCTIONS ---
            function getLocalDateString(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function getWeekDateStrings(date) {
                const startOfWeek = new Date(date);
                const dayOfWeek = startOfWeek.getDay();
                const diff = startOfWeek.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust for Sunday
                startOfWeek.setDate(diff);

                return Array.from({ length: 7 }).map((_, i) => {
                    const weekDay = new Date(startOfWeek);
                    weekDay.setDate(startOfWeek.getDate() + i);
                    return getLocalDateString(weekDay);
                });
            }

            // --- DATA FETCHING & PROCESSING ---
            async function loadAppData() {
                document.getElementById('loading-overlay').style.display = 'flex';
                document.getElementById('loading-text').textContent = 'Loading All Application Data...';
                
                try {
                    const thirtyFiveDaysAgo = new Date();
                    thirtyFiveDaysAgo.setDate(thirtyFiveDaysAgo.getDate() - 35);

                    const [
                        dashboardLogSnapshot,
                        allHistoricalSnapshot,
                        activitiesSnapshot,
                        usersSnapshot,
                        evalLogSnapshot,
                        evalHistoricalSnapshot
                    ] = await Promise.all([
                        db.collection("forecast_log").orderBy("generated_on", "desc").limit(15).get(),
                        db.collection("historical_data").orderBy("date", "desc").get(),
                        db.collection("future_activities").orderBy("date", "asc").get(),
                        db.collection("users").get(),
                        db.collection("forecast_log").where("forecast_for_date", ">=", thirtyFiveDaysAgo).get(),
                        db.collection("historical_data").where("date", ">=", thirtyFiveDaysAgo).orderBy("date", "desc").get()
                    ]);

                    appState.historicalData = allHistoricalSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.activitiesData = activitiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appState.usersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    const provisionalBanner = document.getElementById('provisional-forecast-banner');
                    if (dashboardLogSnapshot.empty) {
                        provisionalBanner?.classList.remove('hidden');
                        generateProvisionalForecast();
                    } else {
                        provisionalBanner?.classList.add('hidden');
                        const forecastDocs = dashboardLogSnapshot.docs.map(doc => doc.data()).reverse();
                        appState.forecastData = {
                            dates: forecastDocs.map(d => d.forecast_for_date.toDate()),
                            sales: forecastDocs.map(d => d.predicted_sales),
                            customers: forecastDocs.map(d => d.predicted_customers),
                        };
                    }
                    
                    const recentHistoryForInsight = appState.historicalData.slice(0, 30).map(h => h.customers).reverse();
                    const trendMovingAverage = recentHistoryForInsight.length > 0 ? recentHistoryForInsight.slice(-7).reduce((a, b) => a + b, 0) / 7 : 250;
                    
                    if(appState.forecastData && appState.forecastData.dates.length > 0) {
                        appState.insightsData = appState.forecastData.dates.map((date, i) => {
                            const forecastCustomers = appState.forecastData.customers[i];
                            const effect = forecastCustomers - trendMovingAverage;
                            return {
                                date: date,
                                trend: trendMovingAverage,
                                seasonal_effect: effect,
                                total: forecastCustomers
                            };
                        });
                    }

                    const latestForecastsForEval = new Map();
                    evalLogSnapshot.docs.forEach(doc => {
                        const log = doc.data();
                        const logDateStr = getLocalDateString(log.forecast_for_date.toDate());
                        const existing = latestForecastsForEval.get(logDateStr);
                        if (!existing || log.generated_on.toMillis() > existing.generated_on.toMillis()) {
                            latestForecastsForEval.set(logDateStr, log);
                        }
                    });

                    const actualsForEval = new Map();
                    evalHistoricalSnapshot.docs.forEach(doc => {
                        const actual = doc.data();
                        const actualDateStr = getLocalDateString(actual.date.toDate());
                        if (!actualsForEval.has(actualDateStr)) {
                            actualsForEval.set(actualDateStr, { id: doc.id, ...actual });
                        }
                    });

                    const mergedEvalData = [];
                    actualsForEval.forEach((actual, actualDateStr) => {
                        if (latestForecastsForEval.has(actualDateStr)) {
                            const forecast = latestForecastsForEval.get(actualDateStr);
                            mergedEvalData.push({
                                date: actual.date.toDate(),
                                actual_sales: Number(actual.sales),
                                forecast_sales: Number(forecast.predicted_sales) + Number(actual.add_on_sales || 0),
                                actual_customers: Number(actual.customers),
                                forecast_customers: Number(forecast.predicted_customers),
                            });
                        }
                    });
                    
                    appState.evaluationData = mergedEvalData.sort((a,b) => a.date - b.date);
                    
                    updateView();

                } catch (error) {
                    console.error("Firebase Error:", error);
                    showToast("Error loading application data. Some features may not work.", "error");
                } finally {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                       loadingOverlay.style.display = 'none';
                    }
                }
            }
            
            function generateProvisionalForecast() {
                if (!appState.historicalData || appState.historicalData.length < 7) {
                    showToast("Not enough historical data for a provisional forecast.", "error");
                    return;
                }
                const dates = Array.from({length: 15}, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() + i + 1);
                    return d;
                });
                const last7DaysCustomers = appState.historicalData.slice(0, 7).map(d => d.customers);
                const avgCustomers = last7DaysCustomers.reduce((a, b) => a + b, 0) / 7;
                const last7DaysATV = appState.historicalData.slice(0, 7).map(d => (d.sales / d.customers));
                const avgATV = last7DaysATV.reduce((a,b) => a+b, 0) / 7;

                appState.forecastData = {
                    dates: dates,
                    customers: Array(15).fill(avgCustomers),
                    sales: Array(15).fill(avgCustomers * avgATV)
                };
            }
            
            // --- MANAGER SCHEDULE FUNCTIONS ---
            async function loadManagers() {
                try {
                    const snapshot = await db.collection("managers").orderBy("sortOrder").get();
                    appState.managers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderManagerList();
                    const activeTab = document.querySelector('.schedule-tab.active')?.dataset.tab;
                    if (activeTab === 'weekly-schedule') {
                        renderWeeklySchedule();
                    } else if (activeTab === 'leave-schedule') {
                        renderLeaveCalendar();
                    }
                } catch (error) {
                    console.error("Error loading managers:", error);
                    showToast("Could not load managers.", "error");
                }
            }

            async function loadScheduleForWeek(week) {
                const weekKey = week[0];
                try {
                    const doc = await db.collection("manager_schedules").doc(weekKey).get();
                    appState.managerSchedules = doc.exists ? doc.data() : {};
                } catch (error) {
                    console.error("Error loading schedule:", error);
                    showToast("Could not load schedule data.", "error");
                }
                renderWeeklySchedule();
                renderShiftSchedule();
            }

            function renderManagerList() {
                const container = document.getElementById('manager-list-container');
                if (!container) return;
                container.innerHTML = '';
                if (appState.managers.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No managers added yet.</p>';
                    return;
                }
                appState.managers.forEach(manager => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                    div.innerHTML = `
                        <p class="font-medium">${manager.name}</p>
                        <button data-id="${manager.id}" class="delete-manager-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                    `;
                    container.appendChild(div);
                });
            }

            function renderWeeklySchedule() {
                const table = document.getElementById('weekly-schedule-table');
                const mobileContainer = document.getElementById('weekly-schedule-mobile');
                if (!table || !mobileContainer) return;

                const weekPicker = document.getElementById('week-picker');
                const selectedDate = new Date(weekPicker.value + 'T00:00:00');
                const weekDates = getWeekDateStrings(selectedDate);

                // --- DESKTOP TABLE RENDER ---
                let thead = '<thead><tr><th class="w-48">Manager</th>';
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                weekDates.forEach((date, i) => {
                    const datePart = date.split('-')[2];
                    thead += `<th>${days[i]}<br><span class="font-normal text-sm">${datePart}</span></th>`;
                });
                thead += '</tr></thead>';

                let tbody = '<tbody>';
                if (appState.managers.length === 0) {
                    tbody += '<tr><td colspan="8" class="text-center text-gray-500 py-4">Please add managers first.</td></tr>';
                } else {
                    appState.managers.forEach(manager => {
                        tbody += `<tr><td class="font-semibold px-2 text-left">${manager.name}</td>`;
                        weekDates.forEach(date => {
                            const scheduleKey = `${manager.id}_${date}`;
                            const scheduleData = appState.managerSchedules[scheduleKey] || { shift: '', time: '' };
                            let offClass = scheduleData.shift === 'OFF' ? 'text-red-500' : '';
                            let cellContent = scheduleData.shift ? `<div class="text-sm"><p class="font-semibold ${offClass}">${scheduleData.shift}</p><p class="text-gray-500 text-xs">${scheduleData.time || ''}</p></div>` : '<span class="text-2xl font-light text-gray-400">+</span>';
                            tbody += `<td class="p-1"><div class="schedule-cell" data-manager-id="${manager.id}" data-date="${date}">${cellContent}</div></td>`;
                        });
                        tbody += '</tr>';
                    });
                }
                tbody += '</tbody>';
                table.innerHTML = thead + tbody;

                // --- MOBILE LIST RENDER ---
                let mobileHTML = '';
                if (appState.managers.length === 0) {
                    mobileHTML = '<p class="text-center text-gray-500 py-4">Please add managers first.</p>';
                } else {
                    weekDates.forEach((date, i) => {
                        const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                        mobileHTML += `<div class="bg-white rounded-lg shadow p-4">
                                        <h4 class="font-bold text-lg mb-2 border-b pb-2">${days[i]} - ${formattedDate}</h4>
                                        <div class="space-y-2">`;
                        appState.managers.forEach(manager => {
                            const scheduleKey = `${manager.id}_${date}`;
                            const scheduleData = appState.managerSchedules[scheduleKey] || { shift: '', time: '' };
                            let offClass = scheduleData.shift === 'OFF' ? 'text-red-500' : '';
                            let shiftContent = scheduleData.shift ? `<div class="text-right"><p class="font-semibold ${offClass}">${scheduleData.shift}</p><p class="text-gray-500 text-xs">${scheduleData.time || ''}</p></div>` : '<span class="text-xl font-light text-gray-400">+</span>';
                            mobileHTML += `<div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 schedule-cell" data-manager-id="${manager.id}" data-date="${date}">
                                            <p class="font-medium">${manager.name}</p>
                                            ${shiftContent}
                                         </div>`;
                        });
                        mobileHTML += `</div></div>`;
                    });
                }
                mobileContainer.innerHTML = mobileHTML;
            }
            
            function renderShiftSchedule() {
                const table = document.getElementById('shift-schedule-table');
                const mobileContainer = document.getElementById('shift-schedule-mobile');
                if (!table || !mobileContainer) return;

                const weekPicker = document.getElementById('week-picker');
                const selectedDate = new Date(weekPicker.value + 'T00:00:00');
                const weekDates = getWeekDateStrings(selectedDate);
                
                const shiftCategories = {
                    "Open SL": ["Open SL"],
                    "Open SM": ["Open SM"],
                    "Mid SM": ["Mid SM"],
                    "Close SL": ["Close SL"],
                    "Close SM": ["Close SM"],
                    "GY": ["GY"]
                };

                // --- DESKTOP TABLE RENDER ---
                let thead = '<thead><tr><th class="w-48">Shift</th>';
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                weekDates.forEach((date, i) => {
                    const datePart = date.split('-')[2];
                    thead += `<th>${days[i]}<br><span class="font-normal text-sm">${datePart}</span></th>`;
                });
                thead += '</tr></thead>';

                let tbody = '<tbody>';
                for (const category in shiftCategories) {
                    tbody += `<tr><td class="font-semibold px-2 text-left">${category}</td>`;
                    weekDates.forEach(date => {
                        let cellContent = '';
                        appState.managers.forEach(manager => {
                            const scheduleKey = `${manager.id}_${date}`;
                            const scheduleData = appState.managerSchedules[scheduleKey];
                            if (scheduleData && shiftCategories[category].includes(scheduleData.shift)) {
                                cellContent += `<div class="text-xs p-1">${manager.name}</div>`;
                            }
                        });
                        tbody += `<td class="p-1 align-top text-xs">${cellContent}</td>`;
                    });
                    tbody += '</tr>';
                }
                tbody += '</tbody>';
                table.innerHTML = thead + tbody;
                
                 // --- MOBILE LIST RENDER ---
                let mobileHTML = '';
                weekDates.forEach((date, i) => {
                    const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                    mobileHTML += `<div class="bg-white rounded-lg shadow p-4">
                                    <h4 class="font-bold text-lg mb-2 border-b pb-2">${days[i]} - ${formattedDate}</h4>
                                    <div class="space-y-3">`;
                    for (const category in shiftCategories) {
                        let managerNames = '';
                        appState.managers.forEach(manager => {
                            const scheduleKey = `${manager.id}_${date}`;
                            const scheduleData = appState.managerSchedules[scheduleKey];
                            if (scheduleData && shiftCategories[category].includes(scheduleData.shift)) {
                                managerNames += `<div class="text-sm">${manager.name}</div>`;
                            }
                        });

                        if(managerNames) {
                             mobileHTML += `<div class="flex justify-between items-start">
                                            <p class="font-semibold text-sm w-1/3 text-left">${category}</p>
                                            <div class="w-2/3 text-right">${managerNames}</div>
                                          </div>`;
                        }
                    }
                    mobileHTML += `</div></div>`;
                });
                mobileContainer.innerHTML = mobileHTML;
            }

            function openScheduleModal(managerId, date) {
                const modal = document.getElementById('schedule-modal');
                const title = document.getElementById('modal-title');
                const shiftSelect = document.getElementById('modal-shift-select');
                const timeInput = document.getElementById('modal-time-input');
                const timeContainer = document.getElementById('modal-time-container');

                const manager = appState.managers.find(m => m.id === managerId);
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
                title.textContent = `Edit Schedule for ${manager.name} on ${formattedDate}`;

                modal.dataset.managerId = managerId;
                modal.dataset.date = date;

                const shiftOptions = ["", "Open SL", "Open SM", "Mid SM", "Close SL", "Close SM", "GY", "Scheduling", "VL", "HL", "SL", "OFF", "Ordering", "People Day", "MDP", "Pull-out", "Marketing", "Store Day", "Travel", "Class", "Payroll", "Inventory", "Meeting", "Leave"];
                
                shiftSelect.innerHTML = shiftOptions.map(o => `<option value="${o}">${o}</option>`).join('');

                const scheduleKey = `${managerId}_${date}`;
                const scheduleData = appState.managerSchedules[scheduleKey] || { shift: '', time: '' };

                shiftSelect.value = scheduleData.shift;
                timeInput.value = scheduleData.time;
                
                timeContainer.style.display = ['VL', 'HL', 'SL', 'OFF', 'Leave', ''].includes(scheduleData.shift) ? 'none' : 'block';

                modal.classList.remove('hidden');
            }

            async function saveScheduleFromModal() {
                const modal = document.getElementById('schedule-modal');
                const managerId = modal.dataset.managerId;
                const date = modal.dataset.date;
                const shift = document.getElementById('modal-shift-select').value;
                const time = document.getElementById('modal-time-input').value;

                const scheduleKey = `${managerId}_${date}`;
                const weekKey = getWeekDateStrings(new Date(date + 'T00:00:00'))[0];
                const scheduleData = { shift: shift, time: ['VL', 'HL', 'SL', 'OFF', 'Leave', ''].includes(shift) ? '' : time };

                try {
                    const scheduleRef = db.collection("manager_schedules").doc(weekKey);
                    await scheduleRef.set({ [scheduleKey]: scheduleData }, { merge: true });

                    const leaveRecordId = `${managerId}_${date}`;
                    const leaveRecordRef = db.collection('leave_records').doc(leaveRecordId);

                    if (['VL', 'HL', 'SL'].includes(shift)) {
                        const manager = appState.managers.find(m => m.id === managerId);
                        await leaveRecordRef.set({
                            managerId: managerId,
                            managerName: manager.name,
                            leaveType: shift,
                            date: firebase.firestore.Timestamp.fromDate(new Date(date + 'T00:00:00'))
                        });
                    } else {
                        await leaveRecordRef.delete().catch(() => {});
                    }

                    showToast("Schedule saved!", "success");
                    appState.managerSchedules[scheduleKey] = scheduleData;
                    renderWeeklySchedule();
                    renderShiftSchedule();
                    document.getElementById('schedule-modal').classList.add('hidden');
                } catch (error) {
                    console.error("Error saving schedule: ", error);
                    showToast("Failed to save schedule.", "error");
                }
            }

            async function clearScheduleFromModal() {
                 const modal = document.getElementById('schedule-modal');
                const managerId = modal.dataset.managerId;
                const date = modal.dataset.date;
                
                const scheduleKey = `${managerId}_${date}`;
                const weekKey = getWeekDateStrings(new Date(date + 'T00:00:00'))[0];
                
                try {
                    const scheduleRef = db.collection("manager_schedules").doc(weekKey);
                    await scheduleRef.update({
                        [scheduleKey]: firebase.firestore.FieldValue.delete()
                    });

                    const leaveRecordId = `${managerId}_${date}`;
                    await db.collection('leave_records').doc(leaveRecordId).delete().catch(() => {});

                    showToast("Schedule cleared!", "success");
                    delete appState.managerSchedules[scheduleKey];
                    renderWeeklySchedule();
                    renderShiftSchedule();
                    document.getElementById('schedule-modal').classList.add('hidden');
                } catch (error) {
                    console.error("Error clearing schedule: ", error);
                    showToast("Failed to clear schedule.", "error");
                }
            }


            // --- NEW LEAVE CALENDAR FUNCTIONS ---
            
            function renderLeaveCalendar() {
                const container = document.getElementById('leave-calendar-container');
                if (!container) return;

                const monthYearEl = document.getElementById('calendar-month-year');
                const currentMonth = appState.calendarDate.getMonth();
                const currentYear = appState.calendarDate.getFullYear();
                
                monthYearEl.textContent = `${appState.calendarDate.toLocaleString('default', { month: 'long' })} ${currentYear}`;

                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                
                const dayOffset = firstDay === 0 ? 6 : firstDay - 1;

                let calendarHTML = '<div class="calendar-header">Mon</div><div class="calendar-header">Tue</div><div class="calendar-header">Wed</div><div class="calendar-header">Thu</div><div class="calendar-header">Fri</div><div class="calendar-header">Sat</div><div class="calendar-header">Sun</div>';

                for (let i = 0; i < dayOffset; i++) {
                    calendarHTML += '<div class="calendar-day other-month"></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = getLocalDateString(new Date(currentYear, currentMonth, day));
                    let leaveEntriesHTML = '';
                    appState.plottedLeaves.forEach(leave => {
                        const leaveStart = new Date(leave.startDate + 'T00:00:00');
                        const leaveEnd = new Date(leave.endDate + 'T00:00:00');
                        const currentDate = new Date(dateStr + 'T00:00:00');

                        if (currentDate >= leaveStart && currentDate <= leaveEnd) {
                            leaveEntriesHTML += `<div class="leave-entry ${leave.leaveType === 'VL' ? 'leave-vl' : 'leave-hl'}">${leave.managerName}</div>`;
                        }
                    });

                    calendarHTML += `<div class="calendar-day" data-date="${dateStr}"><div class="day-number">${day}</div><div class="leave-entries">${leaveEntriesHTML}</div></div>`;
                }
                
                container.innerHTML = `<div class="calendar">${calendarHTML}</div>`;
            }

            async function loadPlottedLeavesForMonth() {
                const year = appState.calendarDate.getFullYear();
                try {
                    const snapshot = await db.collection('plotted_leaves').where('year', '==', year).get();
                    appState.plottedLeaves = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    renderLeaveCalendar();
                } catch(error) {
                    console.error("Error fetching leaves:", error);
                    showToast("Could not load leave data.", "error");
                }
            }

            function openLeaveModal(date = null) {
                const modal = document.getElementById('leave-modal');
                const managerSelect = document.getElementById('leave-manager-select');
                const startDateInput = document.getElementById('leave-start-date');
                const endDateInput = document.getElementById('leave-end-date');

                managerSelect.innerHTML = appState.managers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                
                const selectedDate = date ? date : getLocalDateString(new Date());
                startDateInput.value = selectedDate;
                endDateInput.value = selectedDate;

                modal.classList.remove('hidden');
            }

            async function saveLeaveFromModal() {
                const managerId = document.getElementById('leave-manager-select').value;
                const managerName = appState.managers.find(m => m.id === managerId).name;
                const leaveType = document.getElementById('leave-type-select').value;
                const startDate = document.getElementById('leave-start-date').value;
                const endDate = document.getElementById('leave-end-date').value;

                if (!managerId || !startDate || !endDate) {
                    showToast("Please fill all fields.", "error");
                    return;
                }

                const start = new Date(startDate);
                const end = new Date(endDate);

                try {
                    await db.collection('plotted_leaves').add({
                        managerId,
                        managerName,
                        leaveType,
                        startDate,
                        endDate,
                        year: start.getFullYear()
                    });

                    for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                        const dateStr = getLocalDateString(d);
                        const weekKey = getWeekDateStrings(d)[0];
                        const scheduleKey = `${managerId}_${dateStr}`;
                        const scheduleData = { shift: leaveType, time: '' };
                        
                        const scheduleRef = db.collection("manager_schedules").doc(weekKey);
                        await scheduleRef.set({ [scheduleKey]: scheduleData }, { merge: true });
                    }

                    showToast("Leave plotted successfully!", "success");
                    document.getElementById('leave-modal').classList.add('hidden');
                    loadPlottedLeavesForMonth();

                } catch (error) {
                    console.error("Error plotting leave:", error);
                    showToast("Failed to plot leave.", "error");
                }
            }

            async function loadAndRenderLeaveTracking() {
                const container = document.getElementById('leave-records-container');
                if (!container) return;
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Loading leave records...</p>';
                try {
                    const snapshot = await db.collection('leave_records').orderBy('managerName').get();
                    const records = snapshot.docs.map(doc => doc.data());

                    const leaveSummary = records.reduce((acc, record) => {
                        if (!acc[record.managerName]) {
                            acc[record.managerName] = { VL: 0, HL: 0, SL: 0 };
                        }
                        acc[record.managerName][record.leaveType]++;
                        return acc;
                    }, {});

                    if (Object.keys(leaveSummary).length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">No leave records found.</p>';
                        return;
                    }

                    let content = '';
                    for (const managerName in leaveSummary) {
                        const vlCount = leaveSummary[managerName].VL;
                        const hlCount = leaveSummary[managerName].HL;
                        const slCount = leaveSummary[managerName].SL;
                        const total = vlCount + hlCount + slCount;
                        content += `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-lg">${managerName}</h4>
                                <div class="mt-2 grid grid-cols-4 gap-4 text-center">
                                    <div>
                                        <p class="text-2xl font-bold text-blue-600">${vlCount}</p>
                                        <p class="text-sm text-gray-500">VL</p>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold text-green-600">${hlCount}</p>
                                        <p class="text-sm text-gray-500">HL</p>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold text-yellow-500">${slCount}</p>
                                        <p class="text-sm text-gray-500">SL</p>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold text-gray-800">${total}</p>
                                        <p class="text-sm text-gray-500">Total</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    container.innerHTML = content;

                } catch (error) {
                    console.error("Error loading leave records:", error);
                    container.innerHTML = '<p class="text-red-500 text-center py-4">Could not load leave records.</p>';
                }
            }


            // --- NAVIGATION LOGIC ---
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    appState.currentView = button.dataset.view;
                    updateView();
                });
            });

            function updateView() {
                document.querySelectorAll('.view').forEach(section => section.classList.add('hidden'));
                const currentSection = document.getElementById(`${appState.currentView}-section`);
                if(currentSection) currentSection.classList.remove('hidden');

                navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.view === appState.currentView);
                });

                switch(appState.currentView) {
                    case 'dashboard': renderDashboard(); break;
                    case 'insights': renderInsights(); break;
                    case 'evaluator': renderEvaluator(); break;
                    case 'manager-schedule': 
                        loadManagers();
                        document.querySelector('.schedule-tab.active')?.click();
                        break;
                    case 'activities': renderActivities(); break;
                    case 'historical': renderHistorical(); break;
                    case 'admin': renderAdmin(); break;
                }
            }
            
            // --- FULL RENDERING FUNCTIONS ---
            function renderDashboard() {
                if (!appState.forecastData) return;
                const { dates, sales, customers } = appState.forecastData;

                const ctx = document.getElementById('forecastChart')?.getContext('2d');
                if(!ctx) return;
                if(charts.forecast) charts.forecast.destroy();

                charts.forecast = new Chart(ctx, {
                    type: 'line',
                    data: { labels: dates, datasets: [
                        { label: 'Predicted Sales (₱)', data: sales, borderColor: '#DA291C', backgroundColor: 'rgba(218, 41, 28, 0.1)', yAxisID: 'ySales', tension: 0.3, fill: true },
                        { label: 'Predicted Customers', data: customers, borderColor: '#FFC72C', backgroundColor: 'rgba(255, 199, 44, 0.1)', yAxisID: 'yCustomers', tension: 0.3 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { type: 'time', time: { unit: 'day', tooltipFormat: 'MMM dd, yyyy' }, grid: { display: false } },
                            ySales: { type: 'linear', position: 'left', title: { display: true, text: 'Sales (₱)', font: {weight: 'bold'} }, grid: { color: '#E5E7EB' } },
                            yCustomers: { type: 'linear', position: 'right', title: { display: true, text: 'Customers', font: {weight: 'bold'} }, grid: { display: false } }
                        },
                        plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } },
                        interaction: { mode: 'index', intersect: false }
                    }
                });
                
                const weeklySales = sales.slice(0, 7).reduce((a, b) => a + b, 0) / 7;
                const weeklyCustomers = customers.slice(0, 7).reduce((a, b) => a + b, 0) / 7;
                document.getElementById('avg-sales').textContent = `₱${weeklySales.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                document.getElementById('avg-customers').textContent = `${Math.round(weeklyCustomers).toLocaleString()}`;
                document.getElementById('avg-atv').textContent = `₱${(weeklySales/weeklyCustomers).toFixed(2)}`;
            }

            function renderInsights() {
                if (!appState.insightsData) {
                    showToast("No insights data available to display.", "error");
                    return;
                }
                const select = document.getElementById('insightDate');
                if(!select) return;
                select.innerHTML = '';
                appState.insightsData.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.date.toISOString().split('T')[0];
                    option.textContent = d.date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    select.appendChild(option);
                });
                
                select.removeEventListener('change', handleInsightDateChange); 
                select.addEventListener('change', handleInsightDateChange);
                if (appState.insightsData.length > 0) {
                    updateWaterfallChart(select.value);
                }
            }

            function handleInsightDateChange(e) {
                updateWaterfallChart(e.target.value);
            }

            function updateWaterfallChart(dateString) {
                const data = appState.insightsData.find(d => d.date.toISOString().split('T')[0] === dateString);
                if (!data) return;

                const ctx = document.getElementById('waterfallChart')?.getContext('2d');
                if(!ctx) return;
                if (charts.waterfall) charts.waterfall.destroy();

                charts.waterfall = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Baseline Trend', 'Seasonal & Event Effects', 'Final Forecast'],
                        datasets: [{
                            data: [data.trend, data.seasonal_effect, data.total],
                            backgroundColor: ['#3B82F6', data.seasonal_effect >= 0 ? '#10B981' : '#EF4444', '#4B5563'],
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: { x: { title: { display: true, text: 'Customer Count Impact' } } }
                    }
                });
                
                const summaryEl = document.getElementById('insight-summary');
                summaryEl.innerHTML = `
                    <h4 class="font-bold text-lg mb-2">Summary for ${new Date(dateString + 'T08:00:00').toLocaleDateString('en-US', {month: 'long', day: 'numeric'})}</h4>
                    <p class="mb-2">The forecast starts with a baseline trend of <strong>${data.trend.toFixed(0)}</strong> customers.</p>
                    <p class="mb-2">Seasonal and event effects are ${data.seasonal_effect >= 0 ? 'positive' : 'negative'}, adjusting by <strong>${data.seasonal_effect.toFixed(0)}</strong> customers.</p>
                    <hr class="my-3 border-gray-300">
                    <p class="font-bold">Resulting in a final forecast of <strong>${data.total.toFixed(0)}</strong> customers.</p>
                `;
            }
            
            function renderEvaluator() {
                const salesAccuracyEl = document.getElementById('sales-accuracy');
                const customerAccuracyEl = document.getElementById('customer-accuracy');
                const salesChartCtx = document.getElementById('salesEvalChart')?.getContext('2d');
                const custChartCtx = document.getElementById('customersEvalChart')?.getContext('2d');

                if (charts.salesEval) charts.salesEval.destroy();
                if (charts.custEval) charts.custEval.destroy();
                if(salesAccuracyEl) salesAccuracyEl.textContent = 'N/A';
                if(customerAccuracyEl) customerAccuracyEl.textContent = 'N/A';

                if (!appState.evaluationData || appState.evaluationData.length === 0) {
                    showToast("No matching historical and forecast data found for evaluation.", "error");
                    return;
                }

                const days = appState.evalDays;
                const dataSlice = appState.evaluationData.slice(-days);
                
                if (dataSlice.length === 0) {
                    showToast(`No evaluation data available for the last ${days} days.`, "error");
                    return;
                }
                
                const salesMapeData = dataSlice.filter(d => d.actual_sales > 0);
                const salesMape = salesMapeData.length > 0 
                    ? (salesMapeData.reduce((sum, val) => sum + Math.abs((val.actual_sales - val.forecast_sales) / val.actual_sales), 0) / salesMapeData.length) * 100
                    : 0;

                const custMapeData = dataSlice.filter(d => d.actual_customers > 0);
                const custMape = custMapeData.length > 0
                    ? (custMapeData.reduce((sum, val) => sum + Math.abs((val.actual_customers - val.forecast_customers) / val.actual_customers), 0) / custMapeData.length) * 100
                    : 0;

                if(salesAccuracyEl) salesAccuracyEl.textContent = `${(100 - salesMape).toFixed(2)}%`;
                if(customerAccuracyEl) customerAccuracyEl.textContent = `${(100 - custMape).toFixed(2)}%`;

                if (salesChartCtx) {
                    charts.salesEval = createEvalChart(salesChartCtx, dataSlice.map(d=>d.date), dataSlice.map(d=>d.actual_sales), dataSlice.map(d=>d.forecast_sales));
                }
                
                if (custChartCtx) {
                    charts.custEval = createEvalChart(custChartCtx, dataSlice.map(d=>d.date), dataSlice.map(d=>d.actual_customers), dataSlice.map(d=>d.forecast_customers));
                }
            }
            
            function createEvalChart(ctx, dates, actuals, forecasts) {
                return new Chart(ctx, {
                    type: 'line',
                    data: { labels: dates, datasets: [
                        { label: 'Actual', data: actuals, borderColor: '#DA291C', tension: 0.1 },
                        { label: 'Forecast', data: forecasts, borderColor: '#FFC72C', borderDash: [5, 5], tension: 0.1 }
                    ]},
                    options: { responsive: true, maintainAspectRatio: false,
                        scales: { x: { type: 'time', time: { unit: 'day' } } },
                        plugins: { legend: { position: 'top' } }
                    }
                });
            }

            function setupActivityFilters() {
                const yearSelect = document.getElementById('activity-year');
                if(!yearSelect) return;
                if (!appState.activitiesData || appState.activitiesData.length === 0) {
                    yearSelect.innerHTML = `<option>${new Date().getFullYear()}</option>`;
                    return;
                }

                const years = [...new Set(appState.activitiesData.map(d => d.date.toDate().getFullYear()))].sort((a,b) => b - a);
                const currentYear = new Date().getFullYear();

                if (!years.includes(currentYear)) {
                    years.push(currentYear);
                    years.sort((a,b) => b - a);
                }
                
                yearSelect.innerHTML = '';
                years.forEach(y => {
                    yearSelect.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`;
                });
                
                yearSelect.addEventListener('change', () => {
                    renderActivities();
                });
            }

            function renderActivities() {
                const tabsContainer = document.getElementById('activity-tabs-container');
                const contentContainer = document.getElementById('activity-content-container');
                const yearSelect = document.getElementById('activity-year');
                if(!tabsContainer || !contentContainer || !yearSelect) return;

                tabsContainer.innerHTML = '';
                contentContainer.innerHTML = '';

                const selectedYear = parseInt(yearSelect.value);

                if (!appState.activitiesData || appState.activitiesData.length === 0) {
                    contentContainer.innerHTML = `<p class="text-gray-500 text-center py-4">No future activities found.</p>`;
                    return;
                }
                
                const yearActivities = appState.activitiesData.filter(d => d.date.toDate().getFullYear() === selectedYear);

                if (yearActivities.length === 0) {
                    contentContainer.innerHTML = `<p class="text-gray-500 text-center py-4">No activities found for ${selectedYear}.</p>`;
                    return;
                }

                const activitiesByMonth = yearActivities.reduce((acc, activity) => {
                    const month = activity.date.toDate().toLocaleString('default', { month: 'long' });
                    const monthKey = `${activity.date.toDate().getMonth()}_${month}`;
                    if (!acc[monthKey]) {
                        acc[monthKey] = [];
                    }
                    acc[monthKey].push(activity);
                    return acc;
                }, {});
                
                const sortedMonthKeys = Object.keys(activitiesByMonth).sort((a, b) => parseInt(a.split('_')[0]) - parseInt(b.split('_')[0]));

                sortedMonthKeys.forEach((monthKey, index) => {
                    const monthName = monthKey.split('_')[1];
                    const tab = document.createElement('button');
                    tab.textContent = monthName;
                    tab.className = `month-tab px-4 py-2 font-semibold border-b-2 transition-colors duration-300 ${index === 0 ? 'active' : 'border-transparent'}`;
                    tab.dataset.month = monthKey;
                    tabsContainer.appendChild(tab);
                });

                function displayMonth(monthKey) {
                    contentContainer.innerHTML = '';
                    if (!activitiesByMonth[monthKey]) return;
                    const monthActivities = activitiesByMonth[monthKey];
                    
                    const totalSales = monthActivities.reduce((sum, act) => sum + (act.potential_sales || 0), 0);
                    const unconfirmed = monthActivities.filter(act => act.remarks !== 'Confirmed').length;

                    const summary = document.createElement('div');
                    summary.className = 'grid grid-cols-2 gap-4 mb-4';
                    summary.innerHTML = `
                        <div class="stat-card text-center">
                            <h3 class="text-lg font-semibold text-gray-500">Total Expected Sales</h3>
                            <p class="text-3xl font-bold text-green-600 mt-2">₱${totalSales.toLocaleString()}</p>
                        </div>
                        <div class="stat-card text-center">
                            <h3 class="text-lg font-semibold text-gray-500">Unconfirmed Activities</h3>
                            <p class="text-3xl font-bold text-yellow-600 mt-2">${unconfirmed}</p>
                        </div>
                    `;
                    contentContainer.appendChild(summary);

                    const listContainer = document.createElement('div');
                    listContainer.className = 'space-y-4';
                    monthActivities.forEach(activity => {
                        const card = createActivityCard(activity);
                        listContainer.appendChild(card);
                    });
                    contentContainer.appendChild(listContainer);
                }

                tabsContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('month-tab')) {
                        const currentActive = tabsContainer.querySelector('.active');
                        if (currentActive) {
                            currentActive.classList.remove('active');
                        }
                        e.target.classList.add('active');
                        displayMonth(e.target.dataset.month);
                    }
                });

                if (sortedMonthKeys.length > 0) {
                    displayMonth(sortedMonthKeys[0]);
                }
            }

            function createActivityCard(activity) {
                const date = activity.date.toDate();
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border';
                card.innerHTML = `
                    <div id="view-${activity.id}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-lg">${activity.activity_name}</p>
                                <p class="text-gray-600">${date.toLocaleDateString('en-US', { dateStyle: 'full' })}</p>
                            </div>
                            <div>
                                <button data-id="${activity.id}" class="edit-activity-btn text-blue-500 hover:text-blue-700 font-semibold mr-4">Edit</button>
                                <button data-id="${activity.id}" class="delete-activity-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                            <p><strong>Est. Sales:</strong> ₱${(activity.potential_sales || 0).toLocaleString()}</p>
                            <p><strong>Status:</strong> ${activity.remarks || 'N/A'}</p>
                            <p><strong>Customer:</strong> ${activity.customer_name || 'N/A'}</p>
                        </div>
                    </div>
                    <form id="edit-form-${activity.id}" class="hidden space-y-2 mt-4">
                        <input type="text" value="${activity.activity_name}" class="w-full p-2 border rounded" placeholder="Activity Name">
                        <input type="text" value="${activity.customer_name || ''}" class="w-full p-2 border rounded" placeholder="Customer Name">
                        <input type="date" value="${date.toISOString().split('T')[0]}" class="w-full p-2 border rounded">
                        <input type="number" value="${activity.potential_sales}" class="w-full p-2 border rounded" placeholder="Potential Sales">
                        <select class="w-full p-2 border rounded">
                            <option ${activity.remarks === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                            <option ${activity.remarks === 'Needs Follow-up' ? 'selected' : ''}>Needs Follow-up</option>
                            <option ${activity.remarks === 'Tentative' ? 'selected' : ''}>Tentative</option>
                            <option ${activity.remarks === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                        <div class="flex space-x-2">
                            <button type="submit" data-id="${activity.id}" class="update-activity-btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                            <button type="button" data-id="${activity.id}" class="cancel-edit-btn w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                        </div>
                    </form>
                `;
                return card;
            }

            function renderHistorical(year, month) {
                const container = document.getElementById('historical-list');
                if(!container) return;
                container.innerHTML = '';
                if (!appState.historicalData) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">No historical data found.</p>`;
                    return;
                }

                let filteredData = appState.historicalData;
                if (year) {
                    filteredData = filteredData.filter(d => d.date.toDate().getFullYear() === year);
                }
                if (month !== null && month !== undefined && month !== '') {
                    filteredData = filteredData.filter(d => d.date.toDate().getMonth() === month);
                }

                 filteredData.forEach(record => {
                    const card = createHistoricalCard(record);
                    container.appendChild(card);
                });
            }

            function createHistoricalCard(record) {
                const date = record.date.toDate();
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border';
                card.innerHTML = `
                    <div id="view-hist-${record.id}">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-lg">${date.toLocaleDateString('en-US', { dateStyle: 'full' })}</p>
                            <div>
                                <button data-id="${record.id}" class="edit-historical-btn text-blue-500 hover:text-blue-700 font-semibold mr-4">Edit</button>
                                <button data-id="${record.id}" class="delete-historical-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                            <p><strong>Sales:</strong> ₱${record.sales.toLocaleString()}</p>
                            <p><strong>Customers:</strong> ${record.customers}</p>
                            <p><strong>Add-on:</strong> ₱${(record.add_on_sales || 0).toLocaleString()}</p>
                            <p><strong>Weather:</strong> ${record.weather || 'N/A'}</p>
                        </div>
                    </div>
                    <form id="edit-form-hist-${record.id}" class="hidden space-y-2 mt-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" step="0.01" value="${record.sales}" class="w-full p-2 border rounded">
                            <input type="number" value="${record.customers}" class="w-full p-2 border rounded">
                            <input type="number" step="0.01" value="${record.add_on_sales || 0}" class="w-full p-2 border rounded">
                            <select class="w-full p-2 border rounded">
                                <option ${record.weather === 'Sunny' ? 'selected' : ''}>Sunny</option>
                                <option ${record.weather === 'Cloudy' ? 'selected' : ''}>Cloudy</option>
                                <option ${record.weather === 'Rainy' ? 'selected' : ''}>Rainy</option>
                                <option ${record.weather === 'Storm' ? 'selected' : ''}>Storm</option>
                            </select>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" data-id="${record.id}" class="update-historical-btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Save</button>
                            <button type="button" data-id="${record.id}" class="cancel-edit-hist-btn w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                        </div>
                    </form>
                `;
                return card;
            }

            function setupHistoricalFilters() {
                const yearSelect = document.getElementById('hist-year');
                const monthSelect = document.getElementById('hist-month');
                if(!yearSelect || !monthSelect) return;
                
                const years = [...new Set(appState.historicalData.map(d => d.date.toDate().getFullYear()))];
                yearSelect.innerHTML = '<option value="">All Years</option>';
                years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);

                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                monthSelect.innerHTML = '<option value="">All Months</option>';
                monthNames.forEach((m, i) => monthSelect.innerHTML += `<option value="${i}">${m}</option>`);
                
                const updateFilter = () => {
                    const year = yearSelect.value ? parseInt(yearSelect.value) : null;
                    const month = monthSelect.value !== "" ? parseInt(monthSelect.value) : null;
                    renderHistorical(year, month);
                };

                yearSelect.addEventListener('change', updateFilter);
                monthSelect.addEventListener('change', updateFilter);
                
                renderHistorical(null, null);
            }

            function renderAdmin() {
                const container = document.getElementById('user-list');
                if(!container) return;
                container.innerHTML = '';
                 if (!appState.usersData || appState.usersData.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">No users found.</p>`;
                    return;
                }

                appState.usersData.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 p-4 rounded-lg border flex justify-between items-center';
                    card.innerHTML = `
                        <div>
                            <p class="font-bold text-lg">${user.username}</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <select data-id="${user.id}" class="user-access-level-select w-full p-2 border rounded">
                                <option value="1" ${user.access_level === 1 ? 'selected' : ''}>Admin</option>
                                <option value="2" ${user.access_level === 2 ? 'selected' : ''}>Manager</option>
                                <option value="3" ${user.access_level === 3 ? 'selected' : ''}>Viewer</option>
                            </select>
                            <button data-id="${user.id}" class="delete-user-btn text-red-500 hover:text-red-700 font-semibold">Delete</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }


            // --- EVENT LISTENERS ---
            function setupAppEventListeners() {
                document.querySelectorAll('.eval-toggle-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        document.querySelectorAll('.eval-toggle-button').forEach(btn => btn.classList.remove('bg-[#DA291C]', 'text-white'));
                        e.target.classList.add('bg-[#DA291C]', 'text-white');
                        appState.evalDays = e.target.id === 'eval-7-day' ? 7 : 30;
                        renderEvaluator();
                    });
                });
                
                // --- MANAGER SCHEDULE LISTENERS ---
                const managerScheduleTabs = document.getElementById('manager-schedule-tabs');
                managerScheduleTabs?.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        const tab = e.target.dataset.tab;
                        
                        managerScheduleTabs.querySelectorAll('.schedule-tab').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');

                        document.querySelectorAll('.schedule-content').forEach(content => content.classList.add('hidden'));
                        document.getElementById(`${tab}-content`)?.classList.remove('hidden');

                        if (tab === 'weekly-schedule') {
                            const weekPicker = document.getElementById('week-picker');
                            const weekDates = getWeekDateStrings(new Date(weekPicker.value + 'T00:00:00'));
                            loadScheduleForWeek(weekDates);
                        } else if (tab === 'shift-schedule') {
                            renderShiftSchedule();
                        } else if (tab === 'leave-schedule') {
                            loadPlottedLeavesForMonth();
                        } else if (tab === 'leave-tracking') {
                            loadAndRenderLeaveTracking();
                        } else if (tab === 'manage-managers') {
                            loadManagers();
                        }
                    }
                });

                document.getElementById('add-manager-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const nameInput = document.getElementById('manager-name');
                    const name = nameInput.value.trim();
                    if (name) {
                        try {
                            await db.collection("managers").add({ name: name });
                            showToast("Manager added successfully!");
                            nameInput.value = '';
                            loadManagers();
                        } catch (error) {
                            showToast("Error adding manager.", "error");
                        }
                    }
                });

                document.getElementById('manage-managers-content')?.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('delete-manager-btn')) {
                        const managerId = e.target.dataset.id;
                        if (confirm('Are you sure you want to delete this manager? This action cannot be undone.')) {
                            try {
                                await db.collection("managers").doc(managerId).delete();
                                showToast("Manager deleted.");
                                loadManagers();
                            } catch (error) {
                                showToast("Error deleting manager.", "error");
                            }
                        }
                    }
                });

                const weekPicker = document.getElementById('week-picker');
                weekPicker?.addEventListener('change', () => {
                    const selectedDate = new Date(weekPicker.value + 'T00:00:00');
                    const weekDates = getWeekDateStrings(selectedDate);
                    loadScheduleForWeek(weekDates);
                });
                
                const scheduleTable = document.getElementById('weekly-schedule-table');
                scheduleTable?.addEventListener('click', (e) => {
                    const cell = e.target.closest('.schedule-cell');
                    if (cell && cell.dataset.managerId) {
                        openScheduleModal(cell.dataset.managerId, cell.dataset.date);
                    }
                });
                
                const scheduleMobileContainer = document.getElementById('weekly-schedule-mobile');
                scheduleMobileContainer?.addEventListener('click', (e) => {
                    const cell = e.target.closest('.schedule-cell');
                    if (cell && cell.dataset.managerId) {
                        openScheduleModal(cell.dataset.managerId, cell.dataset.date);
                    }
                });

                // Modal Listeners
                document.getElementById('modal-cancel-btn')?.addEventListener('click', () => {
                    document.getElementById('schedule-modal').classList.add('hidden');
                });
                document.getElementById('modal-save-btn')?.addEventListener('click', saveScheduleFromModal);
                document.getElementById('modal-delete-btn')?.addEventListener('click', clearScheduleFromModal);

                document.getElementById('modal-shift-select')?.addEventListener('change', (e) => {
                    const timeContainer = document.getElementById('modal-time-container');
                    if (['VL', 'HL', 'SL', 'OFF', 'Leave', ''].includes(e.target.value)) {
                        timeContainer.style.display = 'none';
                    } else {
                        timeContainer.style.display = 'block';
                    }
                });


                // --- LEAVE CALENDAR LISTENERS ---
                document.getElementById('prev-month-btn')?.addEventListener('click', () => {
                    appState.calendarDate.setMonth(appState.calendarDate.getMonth() - 1);
                    loadPlottedLeavesForMonth();
                });
                document.getElementById('next-month-btn')?.addEventListener('click', () => {
                    appState.calendarDate.setMonth(appState.calendarDate.getMonth() + 1);
                    loadPlottedLeavesForMonth();
                });
                document.getElementById('add-leave-btn')?.addEventListener('click', () => openLeaveModal());
                
                document.getElementById('leave-calendar-container')?.addEventListener('click', (e) => {
                    const dayCell = e.target.closest('.calendar-day');
                    if (dayCell && dayCell.dataset.date) {
                        openLeaveModal(dayCell.dataset.date);
                    }
                });

                // Leave Modal Listeners
                document.getElementById('leave-cancel-btn')?.addEventListener('click', () => {
                    document.getElementById('leave-modal').classList.add('hidden');
                });
                document.getElementById('leave-save-btn')?.addEventListener('click', saveLeaveFromModal);
            }
            
            // --- AUTHENTICATION FLOW ---
            const loginForm = document.getElementById('login-form');
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');

            loginForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = loginForm.email.value;
                const password = loginForm.password.value;
                loginError.innerHTML = '';
                
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        console.error("Login Error:", error);
                        loginError.textContent = "Invalid username or password.";
                    });
            });
            
            logoutBtn?.addEventListener('click', () => {
                auth.signOut();
            });

            auth.onAuthStateChanged(async user => {
                if (user) {
                    loginScreen.style.display = 'none';
                    appContainer.style.display = 'flex';
                    loadingOverlay.style.display = 'flex';
                    
                    document.getElementById('user-greeting').textContent = `Welcome, ${user.email.split('@')[0]}`;
                    
                    document.querySelector('button[data-view="admin"]')?.classList.remove('hidden');
                    document.querySelector('#mobile-nav button[data-view="admin"]')?.classList.remove('hidden');

                    await loadAppData(); 
                    setupAppEventListeners();
                    if(appState.historicalData) {
                        setupHistoricalFilters();
                        setupActivityFilters();
                    }
                    
                    const weekPicker = document.getElementById('week-picker');
                    if(weekPicker) weekPicker.value = getLocalDateString(new Date());

                    // Load initial data for schedule tabs
                    const initialWeekDates = getWeekDateStrings(new Date());
                    loadScheduleForWeek(initialWeekDates);
                    loadPlottedLeavesForMonth();


                } else {
                    loginScreen.style.display = 'flex';
                    appContainer.style.display = 'none';
                    loadingOverlay.style.display = 'none';
                }
            });
        });
    </script>

</body>
</html>
